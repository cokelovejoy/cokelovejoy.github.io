<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>RICHARD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Technology Blog">
<meta name="keywords" content="Python, JS, Vue, NodeJS">
<meta property="og:type" content="website">
<meta property="og:title" content="RICHARD">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="RICHARD">
<meta property="og:description" content="Technology Blog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RICHARD">
<meta name="twitter:description" content="Technology Blog">
  
    <link rel="alternate" href="/atom.xml" title="RICHARD" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">RICHARD</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">RICHARD BLOG</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Vue源码学习思考" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/04/Vue源码学习思考/" class="article-date">
  <time datetime="2020-06-04T05:57:42.000Z" itemprop="datePublished">2020-06-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/04/Vue源码学习思考/">Vue源码学习思考</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Vue-source-code"><a href="#Vue-source-code" class="headerlink" title="Vue source code"></a>Vue source code</h1><p>本章所有内容都是基于Vue 2.6.11版本</p>
<p>在学习Vue 源码之前，我们可以先思考Vue作为前端web框架，给我们提供了什么东西，我们以何种方式去使用Vue，在使用Vue的过程中有哪些值得注意的点（坑）。然后我们可以从这些点思考Vue如何实现这些功能(API)，探究Vue内部的具体实现原理。从整体的层面来考虑Vue，我们应该先思考Vue 做了一些什么事情，或者说是作为一个web框架应该实现的东西。当我们使用一个web框架去实现一个web应用程序的时候，不管使用这个框架时所使用的编程语法多么的复杂或是简单，其内部都应该不可避免的会去实现一些东西，比如编译器，将程序员写的代码(模板)编译成HTML代码，因为浏览器只会将html处理并渲染，并不理解程序员自定义的标签，因此我们可以学习，Vue是如何实现编译器的，如何实现将自定义的标签，属性，指令编译成html代码。然后我们可以思考一下Vue框架的特性，数据响应化，即Vue能够监听对用户定义的状态所做的更改，并对DOM进行响应式的更新。然后学习Vue中各种API具体是如何实现的，通过这一步，可以知道使用Vue的过程中出现一些错误的原因，比如为什么data必须是一个返回对象的函数，为什么获取数据的最早时机只能是在created生命周期函数钩子中。同时我们通过学习源码，能知道Vue内部一些代码的执行时机。综上所述，我们在学习完源码之后，应该可以知道如何以最佳方式去使用Vue，避免在使用Vue的时候出现一些迷惑性的操作，以及对出现的问题，能够很好的追根溯源。</p>
<p>总结 我们应该学习以下要点：</p>
<ol>
<li>Vue 构造函数 实现的完整流程。</li>
<li>Vue 数据响应化处理包括(object, array)，这里有监听器(Watcher class),依赖收集(Dep class).还涉及到了发布订阅模式的使用。</li>
<li>Vue 如何实现模板编译(compile), 这里有虚拟DOM(Vnode class)，抽象语法树(AST)。</li>
<li>Vue 具体如何实现这些API，$nextTick(), forceUpdate(), setData()。</li>
<li>Vue 中使用到的设计模式，比如发布订阅模式，混入模式等。</li>
<li>Vue 中可以实现的对于数据类型的判断的(object, null, undefined)，以及数据转换的实现(toString, toNumber)</li>
</ol>
<h2 id="How-to-start"><a href="#How-to-start" class="headerlink" title="How to start"></a>How to start</h2><p>首先我们需要获取Vue源码<br>Vue源码地址： https:/github.com/vuejs/vue<br>当前版本： 2.6.10</p>
<ol>
<li><p>获取源码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https:/github.com/vuejs/vue</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置调试环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入vue源文件，下载依赖</span></span><br><span class="line">npm install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装rollup(专门用于js代码的打包工具)</span></span><br><span class="line">npm install -g rollup</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改package.json<br>在scripts &gt; dev 下添加 –sourcemap<br>指明配置文件所在目录： -c scripts/config.js </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"dev"</span>: <span class="string">"rollup -w -c scripts/config.js --sourcemap --environment TARGET:web-full-dev"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动命令<br>当运行命令后会生成对应打包后的vue.js文件，在/dist目录下。<br>vue各版本： vue.runtime.common.js 用于webpack 1.x， browserify。vue.runtime.esm.js用于webpack 2.x。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run dev</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建html文件用于浏览器调试<br>新建 /examples/test/test.html</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入vue.js 创建Vue实例</span></span><br><span class="line">&lt;script src=<span class="string">"/dist/vue.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">        el: <span class="string">'#app'</span>,</span><br><span class="line">        data: &#123;</span><br><span class="line">            msg1:<span class="string">'hello vue'</span>,</span><br><span class="line">            msg2: <span class="string">'coke'</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>源码入口文件<br>我们学习的是打包后生成的带编译器的vue.js文件。<br>所以源码学习从入口文件从 /src/platforms/web/entry-runtime-with-compiler.js开始。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Runtime+compiler development build (Browser)</span></span><br><span class="line">    <span class="string">'web-full-dev'</span>: &#123;</span><br><span class="line">        entry: resolve(<span class="string">'web/entry-runtime-with-compiler.js'</span>), <span class="comment">// webpack打包的入口文件</span></span><br><span class="line">        dest: resolve(<span class="string">'dist/vue.js'</span>), <span class="comment">// webpack打包生成的目标文件的位置</span></span><br><span class="line">        format: <span class="string">'umd'</span>, <span class="comment">// 输出规范</span></span><br><span class="line">        env: <span class="string">'development'</span>,</span><br><span class="line">        alias: &#123; <span class="attr">he</span>: <span class="string">'./entity-decoder'</span> &#125;,</span><br><span class="line">        banner</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Vue-Constructor-Function"><a href="#Vue-Constructor-Function" class="headerlink" title="Vue Constructor Function"></a>Vue Constructor Function</h2><p>经过以上步骤，我们已经知道了从哪一个文件开始分析vue源码，但是我这里不从最外层一层一层开始分析，因为我已经整理过，下图是我自己总结的Vue构造函数的简单的整体结构是什么样子的，所以我直接从Vue源码最底层开始讲起，分析Vue是如何从最初的构造函数一步步壮大的。更详细的Vue源码分析的思维导图，请查看地址：<a href="https://www.processon.com/view/link/5ed8b1df5653bb445ce4a8ba。" target="_blank" rel="noopener">https://www.processon.com/view/link/5ed8b1df5653bb445ce4a8ba。</a></p>
<img src="/static/img/VueCorFunc.png">
首先会有一个简单的Vue构造函数，我称之为Basic Vue，在这里这仅仅是一个简单的构造函数，其内部只有一个_init()方法的调用，也就是当我们写new Vue({xxx})的时候，会去执行到_init这个方法。看到这里你可能会问_init是在哪里定义的，继续往下看，我们会看到initMixin(Vue)这个方法的调用，也就是在这个方法中，我们可以看到给Vue的实例绑定了一个_init()方法。

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>._init(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">initMixin(Vue)</span><br><span class="line">stateMixin(Vue)</span><br><span class="line">eventsMixin(Vue)</span><br><span class="line">lifecycleMixin(Vue)</span><br><span class="line">renderMixin(Vue)</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/04/Vue源码学习思考/" data-id="ckh5kzawh000stgv2itg5vjbi" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Vue源码学习之工具函数" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/20/Vue源码学习之工具函数/" class="article-date">
  <time datetime="2020-05-20T01:44:34.000Z" itemprop="datePublished">2020-05-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/20/Vue源码学习之工具函数/">Vue源码学习之工具函数</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Vue源码之工具函数"><a href="#Vue源码之工具函数" class="headerlink" title="Vue源码之工具函数"></a>Vue源码之工具函数</h1><h2 id="toNumber"><a href="#toNumber" class="headerlink" title="toNumber"></a>toNumber</h2><ul>
<li>Convert an input value to a number for persistence.</li>
<li>If the conversion fails, return original string.<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toNumber</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> n = <span class="built_in">parseFloat</span>(val)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">isNaN</span>(n) ? val : n</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="toString"></a>toString</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get the raw type string of a value, e.g., [object Object].</span></span><br><span class="line"><span class="keyword">const</span> _toString = <span class="built_in">Object</span>.prototype.toString</span><br><span class="line"></span><br><span class="line"><span class="comment">// Strict object type check. Only returns true</span></span><br><span class="line"><span class="comment">// for plain JavaScript objects.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isPlainObject</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> _toString.call(obj) === <span class="string">'[object Object]'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Convert a value to a string.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toString</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> val == <span class="literal">null</span></span><br><span class="line">    ? <span class="string">''</span></span><br><span class="line">    : <span class="built_in">Array</span>.isArray(val) || (isPlainObject(val) &amp;&amp; val.toString == _toString)</span><br><span class="line">        ? <span class="built_in">JSON</span>.stringify(val, <span class="literal">null</span>, <span class="number">2</span>)</span><br><span class="line">        : <span class="built_in">String</span>(val)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="isObject"><a href="#isObject" class="headerlink" title="isObject"></a>isObject</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isObject</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> obj !== <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> obj === <span class="string">'object'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="looseEqual"><a href="#looseEqual" class="headerlink" title="looseEqual"></a>looseEqual</h2><p>Check if two values are loosely equal - that is if they are plain objects, do they have the same shape?</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">looseEqual</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a === b) <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> isObjectA = isObject(a)</span><br><span class="line">    <span class="keyword">const</span> isObjectB = isObject(b)</span><br><span class="line">    <span class="keyword">if</span> (isObjectA &amp;&amp; isObjectB) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> isArrayA = <span class="built_in">Array</span>.isArray(a)</span><br><span class="line">            <span class="keyword">const</span> isArrayB = <span class="built_in">Array</span>.isArray(b)</span><br><span class="line">            <span class="keyword">if</span> (isArrayA &amp;&amp; isArrayB) &#123;</span><br><span class="line">                <span class="keyword">return</span> a.length === b.length &amp;&amp; a.every(<span class="function">(<span class="params">e, i</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> looseEqual(e, b[i])</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a <span class="keyword">instanceof</span> <span class="built_in">Date</span> &amp;&amp; <span class="keyword">instanceof</span> <span class="built_in">Date</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> a.getTime() === b.getTime()</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isArrayA &amp;&amp; !isArrayB) &#123;</span><br><span class="line">                <span class="keyword">const</span> keysA = <span class="built_in">Object</span>.keys(a)</span><br><span class="line">                <span class="keyword">const</span> keysB = <span class="built_in">Object</span>.keys(b)</span><br><span class="line">                <span class="keyword">return</span> keysA.length === keysB.length &amp;&amp; keysA.every(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> looseEqual(a[key], b[key])</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isObjectA &amp;&amp; !isObjectB) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">String</span>(a) === <span class="built_in">String</span>(b)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/05/20/Vue源码学习之工具函数/" data-id="ckh5kzawf000rtgv2c8upww6c" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-短链接" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/19/短链接/" class="article-date">
  <time datetime="2020-05-19T09:21:47.000Z" itemprop="datePublished">2020-05-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/19/短链接/">短链接</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="短链接的实现原理"><a href="#短链接的实现原理" class="headerlink" title="短链接的实现原理"></a>短链接的实现原理</h1><p>短链接主要是通过域名重定向技术，将长网址通过一定的算法转换成一个短链接。当用户访问这个短链接时就可以直接跳转到较长的URL的地址上。域名重定向技术也可以称为URL转发技术，它是通过网站服务器或者各种应用程序的设置，将访问当前域名的用户引导至另一个URL地址。</p>
<h2 id="短链接好处"><a href="#短链接好处" class="headerlink" title="短链接好处"></a>短链接好处</h2><ol>
<li>链接变短，在对内容长度有限制的平台发文，可编辑的文字就变多了</li>
<li>将链接转为二维码的形式分享给他人时，如果是长链，二维码就会变得密集难以识别</li>
<li>链接太长在有些平台上无法识别为超链接</li>
</ol>
<h2 id="短链接跳转的基本原理"><a href="#短链接跳转的基本原理" class="headerlink" title="短链接跳转的基本原理"></a>短链接跳转的基本原理</h2><p>访问短网址后重定向访问长网址</p>
<h2 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h2><h3 id="301"><a href="#301" class="headerlink" title="301"></a>301</h3><p>301代表永久重定向，也就是第一次请求拿到长链接后，下次浏览器再去请求短链的话，不会向短网址服务器请求了，而是直接从浏览器的缓存里拿，缺点就是在server层就无法获取短网址的点击数， 如果这个链接刚好是某个活动的链接，也就无法分析此活动的效果。因此一般不采用301。</p>
<h3 id="302"><a href="#302" class="headerlink" title="302"></a>302</h3><p>302代表临时重定向，也就是说每次去请求短链都会去请求短网址服务器（除非响应中用Cache-Control或Expired暗示浏览器缓存），这样就便于server统计点击数，缺点就是增加了服务器的压力。但在数据异常重要的今天，这是值得的，所以推荐使用302。</p>
<h2 id="使用哈希生成短链接"><a href="#使用哈希生成短链接" class="headerlink" title="使用哈希生成短链接"></a>使用哈希生成短链接</h2><ol>
<li>哈希算法<br>短链组成： 固定短链域名 + 长链 映射成的一串字母<br>通过hash函数计算长链生成 一串字母，然后拼接短链域名形成短链接。<br>这里是使用的hash算法不需要考虑反向解密的难度，只需要考虑hash的运算速度和冲突概率。</li>
</ol>
<p>推荐使用： GOOGLE 的 MurmurHash算法</p>
<ol start="2">
<li>MurmurHash<br>MurmurHash 是一种非加密型的哈希函数，适合用于一般的哈希检索操作。与其他流行的哈希函数相比，对于规律性较强的key,MurmurHash 的随机分布特征表现更良好。非加密意味着相比MD5,SHA这些函数它的性能肯定更高（实际性能是MD5等加密算法的十倍），现在正被广泛应用。</li>
</ol>
<p>MurmurHash 提供了两种长度的哈希值，32bit，128bit，为了让网址尽可能的短，我们选择32bit的哈希值，32bit所能表示的最大值近43亿，对于中小型的公司的业务而言绰绰有余。</p>
<ol start="3">
<li><p>缩短域名<br>将10 进制的数转换成 62进制的数，62进制的数去表示568亿的数，应付长链转换绰绰有余。</p>
</li>
<li><p>解决哈希冲突<br>哈希函数不可避免地会产生哈希冲突（尽管概率很低）。<br>选择数据库保存 短链和长链之间的映射关系。</p>
</li>
</ol>
<ul>
<li>设计思路</li>
</ul>
<ol>
<li>将长链经过MurmurHash后得到短链。</li>
<li>在根据短链去short_url_map 表中查找看是否存在相关记录，如果不存在，将长链与短链对应关系插入数据库中，存储。</li>
<li>如果存在，说明已经有相关记录，此时在长串上拼接一个自定义好的字段如[DUPLICATE]，然后再对[lurl + DUPLICATE]再做hash运算。如果最后还是重复，再拼一个字段串，只要根据短链取出长链的时候把这些自定义好的字符串把这些自定义好的字符串移除即是原来的长链。</li>
</ol>
<p>以上步骤，插入一条数据会经过两次sql查询（经过短链查记录，将短链对应关系插入到数据库中），如果在高并发下，显然会成为瓶颈。<br>一般数据库和服务应用（只做计算不做存储）会部署在两台不同的server上，执行两条sql语句，就需要两次网络通信，这两次网络通信和两次sql执行 将是整个短链系统的性能瓶颈所在。<br>5. 优化性能</p>
<ul>
<li>首先需要给短链字段surl加上唯一索引</li>
<li>当长链经过MurmurHash得到短链后，直接将长短链对应的关系存入到db中，如果db里不包含有此短链的记录，则插入，如果包含了，说明违反了唯一性检索，此时只要给长链在加上我们自定义字段[DUPLICATE]，重新hash在插入即可，看起来在违反唯一性索引的情况下是多执行了步骤，但MurmurHash发生冲突的概率是非常低的。当然在数据量很大的情况下，冲突的概率会加大，此时我们可以使用布隆过滤器进行优化。</li>
</ul>
<p>用所有生成的短网址构建布隆过滤器，当一个新的长链生成短链之后，先将此短链在布隆过滤器中查找，如果不存在，说明db里不存在此网址，可以插入。</p>
<ol start="6">
<li>布隆过滤器</li>
</ol>
<h2 id="使用自增序列算法"><a href="#使用自增序列算法" class="headerlink" title="使用自增序列算法"></a>使用自增序列算法</h2><p>做一个ID自增生成器，比如1,2,3 这样的整数递增ID，当收到一个长链转短链的请求时，ID生成器为其分配一个ID，再将其转化成62进制，拼接到短域名后面就得到了最终的短网址。<br>如何设计ID自增生成器。</p>
<ol>
<li><p>类uuid<br>用UUID（Universally Unique Identifier）全局唯一标识符，是指在一台机器上生成的数字，它保证对同一时空中的所有机器都是唯一的，但这种方式生成的id比较长，且无序，在插入db时可能会频繁导致页分裂，影响性能。</p>
</li>
<li><p>Redis</p>
</li>
<li><p>Snowflake</p>
</li>
<li><p>Mysql 自增主键<br>设计一个专门的发号表，每插入一条记录，为短链id预留从主键id* 1000 - 999 到主键id * 1000 的号段</p>
</li>
</ol>
<p>当长链转短链时，先看这个机器的是否分配了短链的号段，没有分配就往发号表中插入一条记录，则这台机器将为短链分配范围在start 到end 之间的id，从start一直开始分配，一直到end，如果发号达到了end，说明这个范围内的id 已经分配完了，则再往发号表插入一条记录就又获取了一个发号id区间。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/05/19/短链接/" data-id="ckh5kzax8001mtgv2lnk5gz4r" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-nginx" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/18/nginx/" class="article-date">
  <time datetime="2020-03-18T03:15:23.000Z" itemprop="datePublished">2020-03-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/18/nginx/">nginx</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Ubuntu-install-nginx"><a href="#Ubuntu-install-nginx" class="headerlink" title="Ubuntu install nginx"></a>Ubuntu install nginx</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install nginx</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get upgrade</span><br><span class="line"><span class="comment"># 查看nginx版本</span></span><br><span class="line">sudo nginx -v</span><br><span class="line"><span class="comment"># 检查Nginx服务的状态和版本</span></span><br><span class="line">sudo systemctl status nginx</span><br></pre></td></tr></table></figure>

<h1 id="文件目录"><a href="#文件目录" class="headerlink" title="文件目录"></a>文件目录</h1><p>配置文件 : /etc/nginx/nginx.conf<br>程序文件 : /usr/sbin/nginx<br>日志 : /varlog/nginx<br>默认虚拟主机 : /var/www/html (放网页的位置)</p>
<h1 id="管理Nginx服务"><a href="#管理Nginx服务" class="headerlink" title="管理Nginx服务"></a>管理Nginx服务</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">sudo /etc/init.d/nginx start</span><br><span class="line"><span class="comment"># 停止</span></span><br><span class="line">sudo /etc/init.d/nginx stop</span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">sudo /etc/init.d/nginx restart</span><br><span class="line"><span class="comment"># 状态</span></span><br><span class="line">sudo /etc/init.d/nginx status</span><br><span class="line"><span class="comment"># 查看端口占用</span></span><br><span class="line">lsof -i:80</span><br><span class="line"><span class="comment"># 测试nginx.conf文件</span></span><br><span class="line">/usr/sbin/nginx -t -c /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure>

<h1 id="conf配置文件"><a href="#conf配置文件" class="headerlink" title="conf配置文件"></a>conf配置文件</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen      80;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    index index.html index.htm index.php;</span><br><span class="line">    root /var/www/html/statium;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /var/www/html/statium;</span><br><span class="line">        try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html last;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">    error_page 500 502 503 504 /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="使用systemctl管理nginx服务"><a href="#使用systemctl管理nginx服务" class="headerlink" title="使用systemctl管理nginx服务"></a>使用systemctl管理nginx服务</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">sudo systemctl start nginx</span><br><span class="line"><span class="comment"># 停止</span></span><br><span class="line">sudo systemctl stop nginx</span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">sudo systemctl restart nginx</span><br><span class="line"><span class="comment"># 更改配置后重新加载Nginx服务：</span></span><br><span class="line">sudo systemctl reload nginx</span><br><span class="line"><span class="comment"># 禁用在系统启动时启动nginx</span></span><br><span class="line">sudo systemctl <span class="built_in">disable</span> nginx</span><br><span class="line"><span class="comment"># 重新启用nginx</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> nginx</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/18/nginx/" data-id="ckh5kzaws0014tgv2c8n2brn3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-cookie-session-token" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/10/cookie-session-token/" class="article-date">
  <time datetime="2020-03-10T05:28:08.000Z" itemprop="datePublished">2020-03-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/10/cookie-session-token/">cookie session token</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="cookie-原理"><a href="#cookie-原理" class="headerlink" title="cookie 原理"></a>cookie 原理</h1><h2 id="什么是cookie？"><a href="#什么是cookie？" class="headerlink" title="什么是cookie？"></a>什么是cookie？</h2><p>cookie指的是浏览器里面能永久存储的一种数据，仅仅是浏览器实现的一种数据存储功能。</p>
<p>cookie 由服务器生成，发送给浏览器，浏览器把cookie以键值对形式保存在本地某个目录下的文本文件内。浏览器下一次请求同一网站时会把该cookie发送给服务器。由于cookie是存在客户端上的，所以浏览器加入了一些限制确保cookie不会被恶意使用，同时不会占用太多磁盘空间，所以每个域的cookie数量是有限的。</p>
<h2 id="cookie-运作流程"><a href="#cookie-运作流程" class="headerlink" title="cookie 运作流程"></a>cookie 运作流程</h2><p>用户第一次访问并登陆到一个网站的时候，cookie的设置以及发送会经历一下4个步骤。</p>
<ol>
<li>客户端发送一个请求到服务器</li>
<li>服务器发送一个HttpResponse响应到客户端，其中包含Set-Cookie的头部</li>
<li>客户端保存cookie，之后再向服务器发送请求时，HttpRequest请求中会自动包含Cookie的头部信息</li>
<li>服务器比对接收到的cookie和之前设置的cookie，根据比对的结果返回相应的响应信息<img src="https://upload-images.jianshu.io/upload_images/13949989-dcf024be2733e725.png?imageMogr2/auto-orient/strip|imageView2/2/w/400/format/webp">

</li>
</ol>
<h2 id="cookie-特点"><a href="#cookie-特点" class="headerlink" title="cookie 特点"></a>cookie 特点</h2><ol>
<li>域的限制: cookie是基于浏览器的，不同的浏览器，cookie不能共享，Cookie是不可以跨域名的，隐私安全机制禁止网站非法获取其他网站的Cookie。</li>
<li>时间限制: cookie的默认生命周期是会话周期，即浏览器窗口关闭之前，一直存在。关闭浏览器，相当于结束默认的会话，cookie数据会自动消失，再次打开浏览器，相同页面读取数据，无法读到。cookie的有效期，是可以设置的，使用时间戳来表示，多少秒后对应的cookie数据消失，数据过期后，会被浏览器自动清除掉，HTTP请求中，仅携带有效期内的cookie数据，可以减少占用空间，减少HTTP传输的数据量。</li>
<li>空间限制:cookie只能存储4kb</li>
<li>数量限制:一个浏览器针对一个网站最多存20个cookie，浏览器一般只允许存放300个cookie。</li>
<li>存储数据类型限制:cookie只能存储字符串</li>
<li>移动端对cookie的支持不好，Session基于cookie实现，所以移动端常用token。</li>
<li>使用httpOnly提高安全性</li>
</ol>
<h2 id="cookie-的操作"><a href="#cookie-的操作" class="headerlink" title="cookie 的操作"></a>cookie 的操作</h2><p>cookie本质为简单数据，基本操作仅为增删改查。</p>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><ul>
<li>会话状态管理（如用户登录状态、购物车、游戏分数和其它需要记录的信息）</li>
<li>个性化设置（如用户自定义设置、主题等）</li>
<li>浏览器行为跟踪（如跟踪分析用户行为）</li>
</ul>
<h1 id="session-原理"><a href="#session-原理" class="headerlink" title="session 原理"></a>session 原理</h1><h2 id="什么是session？"><a href="#什么是session？" class="headerlink" title="什么是session？"></a>什么是session？</h2><p>session 是另一种记录服务器和客户端会话状态的机制。</p>
<p>session字面意思是会话，当浏览器访问服务器时，服务器为了标识当前访问的客户端，就给当前的浏览器访问，设置了一个’身份标识’，这个身份标识，我们就称之为session，一个session就对应了一个浏览器窗口的访问，只允许当前这个session对应的浏览器访问，就算是在同一个机器上新启的浏览器也是无法访问的。而另外一个浏览器也需要记录session的话，就会再启一个属于自己的session。然后客户端每次向服务器发请求的时候，都会带上session，服务器就知道这个请求来自谁了。客户端保存这个’身份标识’,可以有很多种方式，对于浏览器客户端，都默认采用cookie的方式。</p>
<p>服务器会开辟一块内存来存储session，把用户的信息临时保存在服务器上，用户离开网站后session会被销毁。</p>
<h2 id="session运作流程"><a href="#session运作流程" class="headerlink" title="session运作流程"></a>session运作流程</h2><ol>
<li>用户第一次请求服务器的时候，服务器根据用户提交的相关信息，创建对应的Session，然后保存Session在内存中（或者redis）然后给这个session生成一个唯一的标识字符串，然后在响应头中设置这个唯一标识字符串（SessionID）。</li>
<li>请求返回时将此Session的唯一标识信息SessionID返回浏览器</li>
<li>浏览器接收到服务器返回的SessionID信息后，会将此信息存入到cookie中，同时cookie记录此SessionID属于哪个域名。（这是cookie的特性，域名限制）</li>
<li>当用户第二次访问服务器的时候， 请求会自动判断此域名下是否存在Cookie信息，如果存在自动将Cookie信息也发送给服务器，服务器会从Cookie中获取SessionID，在根据SessionID查找对应的Session信息，如果没有找到说明用户没有登录或者登录失败，如果找到Session证明用户已经登录可以执行后面的操作。</li>
</ol>
<p>因此SessionID是连接cookie和Session的一道桥梁，大部分系统也是根据此原理来验证用户登录状态。</p>
<h2 id="session特点"><a href="#session特点" class="headerlink" title="session特点"></a>session特点</h2><p>session基于cookie实现的，session信息存储在服务器端，sessionID会被存储到客户端的cookie中，服务器端根据SessionID找session。</p>
<p>关闭浏览器不会导致session被删除，迫使服务器为seesion设置了一个失效时间，当距离客户端上一次使用session的时间超过这个失效时间时，服务器就可以认为客户端已经停止了活动，才会把session删除以节省存储空间。</p>
<p>服务器无法知道浏览器是否关闭，浏览器关闭只是cookie被清除了，导致找不到sessionID了，如果将cookie保存在硬盘，那么即使浏览器关闭后再新开一个浏览器窗口访问服务器，也能通过sessionID找到session，但是session也有过期时间，也可以在服务器端主动删除。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ol>
<li>将session存储在服务器里面，当用户同时在线量比较多时，这些session会占据较多的内存，需要在服务端定期的去清理过期的session。(思考解决的方法）</li>
<li>当网站采用集群部署的时候，会遇到多台web服务器之间如何做session共享的问题。因为session是由单个服务器创建的，但是处理用户请求的服务器不一定是那个创建session的服务器，那么该服务器就无法拿到之前已经放入到session中的登录凭证之类的信息了。</li>
<li>当多个应用要共享session时，除了以上问题，还会遇到跨域问题，因为不同的应用可能部署的主机不一样，需要在各个应用做好cookie跨域的处理。</li>
<li>sessionID被保存在cookie中，浏览器端禁止使用cookie，必须有其他机制以便在cookie被禁止时仍然能够把sessionID传递回服务器。经常被使用的一种技术叫做URL重写，就是把sessionID直接附加在URL路径的后面，附加方式也有两种：<br>一种是作为URL路径的附加信息<br>http://…../xxx;sessionid=ByOK3vjFD75aPnrF7C2HmdnV6QZcEbzWoWiBYEnLerjQ99zWpBng!-145788764<br>另一种是作为查询字符串附加在URL后面，表现形式为<br>http://…../xxx?jsessionid=ByOK3vjFD75aPnrF7C2HmdnV6QZcEbzWoWiBYEnLerjQ99zWpBng!-145788764</li>
<li>移动端对cookie的支持不好，session基于cookie实现，所以移动端常用token。</li>
</ol>
<h2 id="比较Cookie和Session"><a href="#比较Cookie和Session" class="headerlink" title="比较Cookie和Session"></a>比较Cookie和Session</h2><ul>
<li>安全性： Session比Cookie更安全，Session是存储在服务器端的，Cookie是存储在客户端的。</li>
<li>存储值得类型不同： Cookie只能存储字符串数据，要设置其他类型的数据，需要将其转换成字符串，Session可以存储任意类型的数据，</li>
<li>存储大小不同： 单个Cookie保存的数据不能超过4kb，Session可存储的数据远高于Cookie，但是当访问量过多，会占用过多的服务器资源。</li>
</ul>
<h1 id="token令牌"><a href="#token令牌" class="headerlink" title="token令牌"></a>token令牌</h1><h2 id="早期基于服务器的验证"><a href="#早期基于服务器的验证" class="headerlink" title="早期基于服务器的验证"></a>早期基于服务器的验证</h2><p>由于HTTP协议是无状态的，这意味着程序需要验证每一次请求，从而辨别客户端的身份。<br>早期程序都是通过在服务器存储登录信息来辨别请求的，这种方式一般都是通过存储Session来完成的。</p>
<h2 id="基于服务器验证方式暴露的问题"><a href="#基于服务器验证方式暴露的问题" class="headerlink" title="基于服务器验证方式暴露的问题"></a>基于服务器验证方式暴露的问题</h2><ol>
<li>Session： 每次认证用户发起请求时，服务器需要去创建一个记录来存储信息。当越来越多的用户发请求，内存的开销也会不断增加。</li>
<li>可扩展性： 在服务端的内存中使用session存储登录信息，伴随而来的是可扩展性问题。</li>
<li>CORS（跨域资源共享）： 当我们需要让数据跨多台移动设备上使用时，跨域资源的共享会是一个让人头疼的问题。在使用Ajax抓取另一个域的资源，就会出现禁止请求的情况。</li>
<li>CSRF（跨站请求伪造）</li>
</ol>
<h2 id="基于Token的验证原理"><a href="#基于Token的验证原理" class="headerlink" title="基于Token的验证原理"></a>基于Token的验证原理</h2><p>token是访问资源接口（api）时，所需要的资源凭证。<br>基于Token的身份验证实现了服务器无状态化，不再需要将用户信息存在服务器，因为信息就存在token中，服务器端通过解析token就可以拿到用户信息。<br>简单的token组成： uid（用户唯一的身份标识），time（当前时间的时间戳）， sign（签名，token的前几位以hash算法压缩成一定长度的十六进制字符串）。</p>
<h2 id="基于Token的身份验证过程"><a href="#基于Token的身份验证过程" class="headerlink" title="基于Token的身份验证过程"></a>基于Token的身份验证过程</h2><ol>
<li>客户端使用用户名和密码请求登录。</li>
<li>服务端收到请求，去验证用户名和密码（查询数据库）。</li>
<li>验证成功后，服务端会签发一个token并把token发送给客户端。</li>
<li>客户端收到token以后，会把它存储起来，比如放在cookie或者localstorage里。</li>
<li>客户端每次向服务端请求资源的时候需要带着服务器签发的token。</li>
<li>服务器收到请求，然后去验证客户端请求里面带着的token，如果验证成功，就向客户端返回请求的数据。</li>
</ol>
<p>注意点:</p>
<ul>
<li>每一次请求都需要携带token，需要把token放到HTTP请求的Header里。</li>
<li>基于token的用户认证是一种服务端无状态的认证方式，服务端不用存放token数据。用解析token的计算时间换取session的存取空间，从而减轻服务器的压力，减少频繁的查询数据库。</li>
<li>设置服务器属性Access-Control-Allow-Origin：*，让服务器能接受到来自所有域的请求。</li>
<li>如果用数据库来存储token会导致查询时间太长，可以选择放在内存中。比如redis很适合token的查询。</li>
</ul>
<h2 id="refresh-token"><a href="#refresh-token" class="headerlink" title="refresh token"></a>refresh token</h2><p>refresh token 是专门用于刷新Access token的token，如果没有refresh token，也可以刷新access token，但每次刷新都要用户输入登录用户名和密码，很麻烦。有了refresh token，客户端可以以直接用refresh token去更新accesstoken，无需用户进行额外的操作。</p>
<ul>
<li>Access token的有效期比较短，当Access token 由于过期而时效时，使用refresh token就可以获取新的 access token，只有当refresh token也失效了，用户就只能重新登录了。</li>
<li>refresh token 及过期时间是存储在服务器的数据库中，只有在申请新的Access token时才会验证，不会对业务接口响应时间造成影响，也不需要向session一样一直保持在内存中。</li>
</ul>
<h2 id="token的特点"><a href="#token的特点" class="headerlink" title="token的特点"></a>token的特点</h2><ul>
<li>无状态<br>在客户端存储的token是无状态的，不需要存储session信息，负载均衡器能将用户信息从一个服务传到其他服务器上。<br>如果是将已经验证的用户信息存储到session中，则每次请求都需要用户向已验证的服务器发送验证信息，用户量大时，会造成拥堵。</li>
<li>安全性<br>请求中发送token而不是cookie能够防止CSRF跨站请求伪造。即使在客户端使用cookie存储token，cookie也只是一个存储机制，而不是用于认证。也不讲用户信息存储在session中，少了对session的操作。<br>token是由时效性的，一段时间之后用户需要重新验证。也可以手动使特定的token或一组相同认证的token无效。</li>
<li>可扩展性<br>token可以创建与其他程序共享权限的程序。<br>使用token时，可以提供可选的权限给第三方应用。当用户想让另一应用程序访问他们的数据，我们可以通过建立API，得出特殊权限的token。</li>
<li>多平台跨域<br>支持移动端设备，只要用户有一个通过验证的token，数据和资源就能在任何域上被请求到。</li>
</ul>
<h2 id="Token和Session的比较"><a href="#Token和Session的比较" class="headerlink" title="Token和Session的比较"></a>Token和Session的比较</h2><ul>
<li>session是一种记录服务器和客户端会话状态的机制，使服务端状态化，可以记录会话信息。而Token是令牌，访问资源接口API时所需要的资源凭证，Token使服务端无状态化，不存储会话信息。在大规模系统中，对每个请求都检索会话信息可能是一个复杂和耗时的过程，但另一方面服务端要通过token来解析用户身份也需要定义好相应的协议（比如JWT）。</li>
<li>session一般通过cookie交互，而token方式更加灵活，可以是cookie，也可以是header，也可以放在请求的内容中。不使用cookie可以带来跨域上的便利性。</li>
<li>token 的生成方式更加多样化，可以由第三方模块来提供。</li>
<li>token如果被盗用，服务端无法感知。cookie信息存储在用户自己电脑中，被盗用风险略小。</li>
<li>session和token并不矛盾，作为身份认证token安全性更高，同时还可以使用session来在服务端保存一些状态。</li>
<li>如果用户数据需要和第三方共享，或者允许第三方调用API接口，用token，如果永远只是自己的网站，自己的app，都可以。</li>
</ul>
<h1 id="JWT（JSON-WEB-TOKEN）"><a href="#JWT（JSON-WEB-TOKEN）" class="headerlink" title="JWT（JSON WEB TOKEN）"></a>JWT（JSON WEB TOKEN）</h1><p>JSON Web Token （简称JWT）是目前最流行的跨域认证解决方案。JWT是一种认证授权机制。</p>
<h2 id="跨域认证问题"><a href="#跨域认证问题" class="headerlink" title="跨域认证问题"></a>跨域认证问题</h2><p>互联网用户认证的一般流程如下：</p>
<ol>
<li>用户想服务器发送用户名和密码。</li>
<li>服务器验证通过后，在当前对话（session）里面保存相关数据。比如用户角色，登录时间等。</li>
<li>服务器向用户返回一个sessionID，写入用户的Cookie中。</li>
<li>用户随后的每一次请求，都会通过Cookie，将sessionID传回服务器。</li>
<li>服务器收到SessionID，找到前期保存的数据，由此得知用户的身份。</li>
</ol>
<p>这种模式的产生的问题：扩展性不好，如果是服务器集群或者是跨域的服务器导向架构，就要求session数据共享，每台服务器都能够读取到session。例如，要求用户在一个网站登录，在访问另一个网站就会自动登录，如何实现？（实现单点登录sso）</p>
<p>一种解决方案是session数据持久化，写入数据库或别的持久层。各种服务收到请求后，都想持久层请求数据。这种方案的优点是架构清晰，缺点是工程量大，另外持久层挂了，就会单点登录失败。</p>
<p>另一种方案就是服务器不保存session数据，所有数据（就是token）都保存在客户端，每次请求都发回服务器。JWT就是这种方案的一个代表。</p>
<h2 id="JWT原理"><a href="#JWT原理" class="headerlink" title="JWT原理"></a>JWT原理</h2><p>JWT的原理是，服务器认证以后，生成一个JSON对象，发回给用户。如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;coke&quot;,</span><br><span class="line">    &quot;role&quot;: &quot;admin&quot;,</span><br><span class="line">    &quot;expireTime&quot;: &quot;2020.02.02&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以后，用户与服务器端通信的时候，都要发回这个JSON对象。服务器完全只靠这个对象认证用户身份。为了防止用户篡改数据，服务器在生成这个JSON对象的时候，会进行签名操作。</p>
<p>服务器就不保存session数据了，也就是说，服务器变成无状态的了，从而比较容易实现扩展。</p>
<h2 id="JWT的数据结构"><a href="#JWT的数据结构" class="headerlink" title="JWT的数据结构"></a>JWT的数据结构</h2><p>实际的JWT就像是下面这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7InVzZXJuYW1lIjoiYWJjIiwicGFzc3dvcmQiOiIxMTExMTEifSwiZXhwIjoxNTU3MTU1NzMwLCJpYXQiOjE1NTcxNTIxMzB9.</span><br><span class="line">pjGaxzX2srG_MEZizzmFEy7JM3t8tjkiu3yULgzFwUk</span><br></pre></td></tr></table></figure>

<p>它是一个很长的字符串，中间用点（.）分隔成三个部分。注意，JWT内部是没有换行的，此处方便展示，将它写成几行。<br>JWT的三个部分依次是：</p>
<ol>
<li>Header(头部)</li>
<li>Playload（负载）</li>
<li>Signature（签名）</li>
</ol>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>Header部分是一个JSON对象，描述了JWT的元数据，通常如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;alg&quot;: &quot;HS256&quot;,</span><br><span class="line">    &quot;typ&quot;: &quot;JWT&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中alg属性表示签名的算法（algorithm），默认是HMAC SHA256（写成 HS256）,typ属性表示这个令牌（token）的类型，JWT令牌统一写成JWT。</p>
<p>最后，将上面的JSON对象使用Base64URL算法转成字符串。</p>
<h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h3><p>Payload部分也是一个JSON对象，用来存放实际需要传递的数据.JWT规定了7个官方字段，供选用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iss(issuer): 签发人</span><br><span class="line">exp(expiration time): 过期时间</span><br><span class="line">sub(subject): 主题</span><br><span class="line">aud(audience): 受众</span><br><span class="line">nbf(Not Before): 生效时间</span><br><span class="line">iat(Issued At): 签发时间</span><br><span class="line">jti(JWT ID): 编号</span><br></pre></td></tr></table></figure>

<p>还可以自定义私有字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;coke&quot;,</span><br><span class="line">    &quot;admin&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，JWT默认是不加密的，任何人都可以读到，所以不要把秘密信息放在这个部分。<br>这个JSON对象也要使用Base64URL算法转成字符串。</p>
<h3 id="Signature"><a href="#Signature" class="headerlink" title="Signature"></a>Signature</h3><p>Signature部分是对前两部分的签名，防止数据篡改。<br>首先，需要制定一个密钥（secret）。这个密钥只有服务器才知道，不能泄露给用户。然后使用Header里面指定的签名算法（默认是HMAC SHA256），按照下面的公式产生签名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HMACSHA256(</span><br><span class="line">    base64UrlEncode(header) + &quot;.&quot; +</span><br><span class="line">    baseUrlEncode(payload),</span><br><span class="line">    secret</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>算出签名以后，把Header，Payload，Signature三个部分拼成一个字符串，每个部分之间用”点”(.)分隔，就可以返回给用户。</p>
<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>默认使用HS256算法对JWT中的Header和Payload数据签名,然后将产生的结果和JWT中的Signature数据比对.</p>
<h3 id="Base64URL"><a href="#Base64URL" class="headerlink" title="Base64URL"></a>Base64URL</h3><p>Base64 内容传送编码被设计用来把任意序列的8位字节描述为一种不易被人识别的形式.<br>Header和Payload串行化的算法是Base64URL。这个算法跟Base64算法基本类似，但是有一些小的不同。</p>
<p>JWT作为一个令牌（token），有些使用场景可能会放到URL中（如api/example/?token=xxx）.Base64算法中有三个字符+,/,=在URL中有特殊含义，因此要被替换掉，=被省略，+号替换成-，/替换成_,这就是Base64URL算法。</p>
<h3 id="HMAC-SHA156"><a href="#HMAC-SHA156" class="headerlink" title="HMAC SHA156"></a>HMAC SHA156</h3><p>HMAC（Hash Message Authentication Code），散列消息鉴别码，实现鉴别的原理，用公开函数和密钥产生一个固定长度的值作为认证表示，用这个标识鉴别消息的完整性。使用一个密钥生成一个固定大小的小数据块，即MAC，并将其加入到消息中，然后传输。接收方利用与发送方共享的密钥进行鉴别认证。</p>
<h3 id="Beare"><a href="#Beare" class="headerlink" title="Beare"></a>Beare</h3><p>Beare作为一种认证类型(基于OAuth 2.0),使用”Bearer”关键词进行定义.<br>当用户希望访问一个受保护的路由或者资源的时候,需要请求头的Authorization字段中使用Bearer模式添加JWT,如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Bearer xxxxxxxxxxxxxxxxxxxxxxxxxx.yyyyyyyyyyyyyyyyy.zzzzzzzzzzzzzzzzzzzzzzzzz</span><br></pre></td></tr></table></figure>

<h2 id="JWT的认证流程"><a href="#JWT的认证流程" class="headerlink" title="JWT的认证流程"></a>JWT的认证流程</h2><ol>
<li>用户输入用户名、密码的登录，服务器认证成功后，会返回给客户端一个JWT。</li>
<li>客户端收到服务器返回的JWT，可以存储在Cookie中，也可以存储在localStorage。</li>
<li>当用户希望访问一个受保护的路由或者资源的时候，需要请求头的Authorization字段中使用Bearer模式添加JWT。</li>
<li>服务端的保护路由将会检查请求头Authorization中的JWT信息，如果合法，则允许用户的行为。</li>
<li>因为JWT是包含了一些会话信息的，因此减少了需要查询数据库的需要。</li>
<li>JWT并不使用Cookie，因此可以使用任何域名提供API服务，而不需要担心跨域资源共享的问题。</li>
</ol>
<p>此后，客户端每次与服务器通信，都要带上这个JWT。可以把它放在Cookie里面自动发送，但是这样不能跨域，所以更好的做法是放在HTTP请求头Authorization字段里面。</p>
<p>另一种做法就是JWT就放在POST请求的数据体里面。</p>
<h2 id="JWT的特点"><a href="#JWT的特点" class="headerlink" title="JWT的特点"></a>JWT的特点</h2><ol>
<li>JWT默认是不加密的，但是也可以再加密。生成原始的token以后，可以用密钥在加密一次。</li>
<li>JWT不加密的情况下，不要将私密数据写入JWT。</li>
<li>JWT不仅可以用于认证，也可以用于交换信息。有效使用JWT，可以降低服务器查询数据库的次数。</li>
<li>JWT的最大缺点就是，由于服务器不保存session状态，因此无法在使用的过程中废止某个token，或者更改token的权限。也就是说，一旦JWT签发了，在到期之前就会始终有效，除非服务器手动终止。</li>
<li>JWT本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为了减少盗用，JWT的有效期应该设置得比较短。对于一些比较重要的权限，使用时应该再次对用户进行认证。</li>
<li>为了减少盗用，JWT不应该使用HTTP协议明码传输，要使用HTTPS协议传输。</li>
</ol>
<h2 id="JWT和token的比较"><a href="#JWT和token的比较" class="headerlink" title="JWT和token的比较"></a>JWT和token的比较</h2><p>相同：</p>
<ul>
<li>都是访问资源的令牌</li>
<li>都可以记录用户信息</li>
<li>都是使服务端无状态化</li>
<li>都是只有验证成功后，客户端才能访问服务端上受保护的资源。</li>
</ul>
<p>区别：</p>
<ul>
<li>token： 服务端验证客户端发送过来的token时，还需要查询数据库获取用户信息，然后验证token是否有效。</li>
<li>JWT： 将token和Payload加密后存储在客户端，服务端只需要使用相同的加密算法加密header和payload，然后比对Signature，进行校验。不需要查询或者减少查询数据库，因为JWT自包含了用户信息和加密的数据。</li>
</ul>
<h1 id="hash-算法"><a href="#hash-算法" class="headerlink" title="hash 算法"></a>hash 算法</h1><p>哈希算法（Hash Algorithm）又称散列算法，哈希函数，哈希算法将数据重新打乱混合，重新创建一个新的哈希值。<br>哈希算法主要用于保障数据真实性（完整性），即发信人将原始消息和哈希值一起发送，收信人通过相同的hash算法来校验原始数据是否真实。<br>哈希算法的特点： 不定长数据转换成定长数据，雪崩效应， 防篡改。</p>
<h1 id="常用的鉴权的几种方式"><a href="#常用的鉴权的几种方式" class="headerlink" title="常用的鉴权的几种方式"></a>常用的鉴权的几种方式</h1><h2 id="Cookie-Session方式"><a href="#Cookie-Session方式" class="headerlink" title="Cookie/Session方式"></a>Cookie/Session方式</h2><h3 id="设置Cookie"><a href="#设置Cookie" class="headerlink" title="设置Cookie"></a>设置Cookie</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>)</span><br><span class="line">http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.url === <span class="string">'/favicon.ico'</span>) &#123;</span><br><span class="line">        res.end(<span class="string">''</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 观察cookie 存在， 如果有cookie，发送请求时，浏览器会自动带上cookie</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'cookie:'</span>, req.headers.cookie)</span><br><span class="line">    <span class="comment">// Header Set-Cookie用于设置cookie</span></span><br><span class="line">    res.setHeader(<span class="string">'Set-Cookie'</span>, <span class="string">'cookie1=abc'</span>)</span><br><span class="line">    res.end(<span class="string">'hello cookie!!'</span>)</span><br><span class="line">&#125;).listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'listen on port 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="设置session"><a href="#设置session" class="headerlink" title="设置session"></a>设置session</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>)</span><br><span class="line"><span class="keyword">const</span> session = &#123;&#125;</span><br><span class="line">http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.url === <span class="string">'/favicon.ico'</span>) &#123;</span><br><span class="line">        res.end(<span class="string">''</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">// 观察cookie存在</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'cookie'</span>, req.headers.cookie)</span><br><span class="line">    <span class="keyword">const</span> sessionKey = <span class="string">'SessionID'</span></span><br><span class="line">    <span class="keyword">const</span> cookie = req.headers.cookie</span><br><span class="line">    <span class="comment">// cookie中存在sessionID</span></span><br><span class="line">    <span class="keyword">if</span> (cookie &amp;&amp; cookie.indexOf(sessionKey) != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="comment">// 简略处理</span></span><br><span class="line">        res.end(<span class="string">'have log in'</span>)</span><br><span class="line">        <span class="keyword">const</span> pattern = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`<span class="subst">$&#123;sessionKey&#125;</span>=([^;]+);?\s*`</span>)</span><br><span class="line">        <span class="keyword">const</span> sid = pattern.exec(cookie)[<span class="number">1</span>]</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'session:'</span>, sid, session, session[sid])</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 生成随机sessionID</span></span><br><span class="line">        <span class="keyword">const</span> sid = (<span class="built_in">Math</span>.random() * <span class="number">99999999</span>).toFixed()</span><br><span class="line">        <span class="comment">// 将sessionID保存到cookie中</span></span><br><span class="line">        res.setHeader(<span class="string">'Set-Cookie'</span>, <span class="string">`<span class="subst">$&#123;sessionKey&#125;</span>=<span class="subst">$&#123;sid&#125;</span>;`</span>)</span><br><span class="line">        <span class="comment">// 设置session保存用户信息</span></span><br><span class="line">        session[sid] = &#123; <span class="attr">name</span>: <span class="string">'coke'</span>, <span class="attr">age</span>: <span class="number">22</span>&#125;</span><br><span class="line">        res.end(<span class="string">`Hello <span class="subst">$&#123;sid&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'listen on port 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="在Koa中使用session：-npm-i-koa-session-S"><a href="#在Koa中使用session：-npm-i-koa-session-S" class="headerlink" title="在Koa中使用session： npm i koa-session -S"></a>在Koa中使用session： npm i koa-session -S</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'koa-session'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 签名keys作用： 用来对cookie进行签名</span></span><br><span class="line">app.keys = [<span class="string">'some secret'</span>]</span><br><span class="line"><span class="comment">// 配置项</span></span><br><span class="line"><span class="keyword">const</span> SESS_CONFIG = &#123;</span><br><span class="line">    key: <span class="string">'sessionID'</span>,</span><br><span class="line">    maxAge: <span class="number">86400000</span>, <span class="comment">// 设置有效时间，默认一天</span></span><br><span class="line">    httpOnly: <span class="literal">true</span>, <span class="comment">// 仅限服务器修改</span></span><br><span class="line">    signed: <span class="literal">true</span> <span class="comment">// 签名cookie,防止前端篡改数据</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 注册session中间件</span></span><br><span class="line">app.use(session(SESS_CONFIG, app))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试</span></span><br><span class="line">app.use(<span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ctx.path === <span class="string">'/favicon.ico'</span>) <span class="keyword">return</span></span><br><span class="line">    <span class="comment">// 获取</span></span><br><span class="line">    <span class="keyword">let</span> count = ctx.session.count || <span class="number">0</span></span><br><span class="line">    <span class="comment">// 设置 session</span></span><br><span class="line">    ctx.session.count = ++count</span><br><span class="line">    ctx.body = <span class="string">'第'</span>+ count + <span class="string">'次访问'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'listen on port 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.jsdelivr.net/npm/vue/dist/vue.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/axios/dist/axios.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">v-model</span>=<span class="string">"username"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">v-model</span>=<span class="string">"password"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"login"</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"logout"</span>&gt;</span>Logout<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"getUserInfo"</span>&gt;</span>GetUserInformation<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">"document.getElementById('log').innerHTML = ''"</span>&gt;</span>Clear Log<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h6</span> <span class="attr">id</span>=<span class="string">"log"</span>&gt;</span><span class="tag">&lt;/<span class="name">h6</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        axios.default.withCredentials =<span class="literal">true</span></span></span><br><span class="line">        axios.interceptors.response.use(</span><br><span class="line">            response =&gt; &#123;</span><br><span class="line"><span class="javascript">                <span class="built_in">document</span>.getElementById(<span class="string">'log'</span>).append(<span class="built_in">JSON</span>.stringify(response.data))</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> response</span></span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">            el: <span class="string">'#app'</span>,</span></span><br><span class="line">            data: &#123;</span><br><span class="line"><span class="javascript">                username: <span class="string">'test'</span>,</span></span><br><span class="line"><span class="javascript">                password: <span class="string">'test'</span></span></span><br><span class="line">            &#125;,</span><br><span class="line">            methods: &#123;</span><br><span class="line"><span class="javascript">                <span class="keyword">async</span> login() &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">await</span> axios.post(<span class="string">'/users/login'</span>, &#123;</span></span><br><span class="line"><span class="javascript">                        username: <span class="keyword">this</span>.username,</span></span><br><span class="line"><span class="javascript">                        password: <span class="keyword">this</span>.password</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;,</span><br><span class="line"><span class="javascript">                <span class="keyword">async</span> logout() &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">await</span> axios.post(<span class="string">'/users/logout'</span>)</span></span><br><span class="line">                &#125;,</span><br><span class="line"><span class="javascript">                <span class="keyword">async</span> getUserInfo() &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">await</span> axios.get(<span class="string">'/users/getUser'</span>)</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)()</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'koa-session'</span>)</span><br><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">'koa2-cors'</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> = <span class="built_in">require</span>(<span class="string">'koa-static'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置session的中间件</span></span><br><span class="line">app.use(cors(&#123;</span><br><span class="line">    credentials: <span class="literal">true</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只有服务器端知道的密钥，用于签名</span></span><br><span class="line">app.keys = [<span class="string">'some secret'</span>]</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">static</span>(__dirname + <span class="string">'/'</span>))</span><br><span class="line"><span class="comment">// 注册中间件 bodyParser</span></span><br><span class="line"><span class="comment">// 用于将 post请求中的数据变成对象保存在ctx.request.body</span></span><br><span class="line">app.use(bodyParser())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册session中间件</span></span><br><span class="line">app.use(session(app))</span><br><span class="line"></span><br><span class="line">app.use(<span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 除了login路由不用检查session，其余路由需要检查session</span></span><br><span class="line">    <span class="keyword">if</span> (ctx.url.indexOf(<span class="string">'login'</span>) != <span class="number">-1</span>) &#123;</span><br><span class="line">        next()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'session'</span>, ctx.session.userinfo)</span><br><span class="line">        <span class="keyword">if</span> (!ctx.session.userinfo) &#123;</span><br><span class="line">            ctx.body = &#123;</span><br><span class="line">                message: <span class="string">"登录失败"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            next()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/users/login'</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; body &#125; = ctx.request</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'body'</span>, body)</span><br><span class="line">    <span class="comment">// 登录时，设置session的信息</span></span><br><span class="line">    ctx.session.userinfo = body.username</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">        message: <span class="string">"登录成功"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/users/logout'</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 设置session</span></span><br><span class="line">    <span class="keyword">delete</span> ctx.session.userinfo</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">        message: <span class="string">"登出系统"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/users/getUser'</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">        message: <span class="string">"获取数据成功"</span>,</span><br><span class="line">        userinfo: ctx.session.userinfo</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.use(router.routes())</span><br><span class="line">app.use(router.allowedMethods())</span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<h3 id="使用redis存储session"><a href="#使用redis存储session" class="headerlink" title="使用redis存储session"></a>使用redis存储session</h3><h4 id="redis介绍"><a href="#redis介绍" class="headerlink" title="redis介绍"></a>redis介绍</h4><p>redis是一个高性能的 key-value数据库。<br>Redis is an in-memory database that persists on disk. The data model is key-value, but many different kind of values are supported: Strings, Lists, Sets, Sorted Sets, Hashes.</p>
<h3 id="Redis-与其他的缓存产品有以下三个特点"><a href="#Redis-与其他的缓存产品有以下三个特点" class="headerlink" title="Redis 与其他的缓存产品有以下三个特点"></a>Redis 与其他的缓存产品有以下三个特点</h3><ul>
<li>Redis支持数据的持久化，可以将内存中的数据保存在磁盘，重启的时候可以再次加载进行使用。</li>
<li>Redis 不仅仅支持简单的key-value类型的数据，同时还提供list，set，zset，hash等数据结构的存储。</li>
<li>Redis支持数据的备份，即master-slave模式的数据备份。</li>
</ul>
<h3 id="Redis优势"><a href="#Redis优势" class="headerlink" title="Redis优势"></a>Redis优势</h3><ul>
<li>性能极高-Redis能读的速度是 110000次/s, 写的速度是81000次/s。</li>
<li>丰富的数据类型- Redis支持二进制案例的Strings, Lists, Hashes, Sets及Ordered Sets数据类型操作。</li>
<li>原子 - Redis的所有操作都是原子性的，意思就是要么成功执行，要么失败完全不执行。单个操作是原子性的。多个操作也支持事务，即原子性，通过MULTI 和EXEC指令包起来。</li>
<li>丰富的特性 - Redis还支持publish/subscribe, 通知key过期等特性。</li>
</ul>
<h3 id="使用redis"><a href="#使用redis" class="headerlink" title="使用redis"></a>使用redis</h3><h4 id="windows安装redis"><a href="#windows安装redis" class="headerlink" title="windows安装redis"></a>windows安装redis</h4><p>下载地址： <a href="https://github.com/MSOpenTech/redis/releases" target="_blank" rel="noopener">https://github.com/MSOpenTech/redis/releases</a></p>
<h4 id="启动redis"><a href="#启动redis" class="headerlink" title="启动redis"></a>启动redis</h4><p>打开cmd窗口使用cd命令切换到redis安装目录运行如下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server.exe</span><br></pre></td></tr></table></figure>

<h4 id="使用redis模块操作redis"><a href="#使用redis模块操作redis" class="headerlink" title="使用redis模块操作redis"></a>使用redis模块操作redis</h4><p>安装redis模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i redis -S</span><br></pre></td></tr></table></figure>

<p>使用redis</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> redis = <span class="built_in">require</span>(<span class="string">'redis'</span>)</span><br><span class="line"><span class="keyword">const</span> client = redis.createClient(<span class="number">6379</span>, <span class="string">'localhost'</span>)</span><br><span class="line"></span><br><span class="line">client.set(<span class="string">'hello'</span>, <span class="string">'this is a value'</span>)</span><br><span class="line"></span><br><span class="line">client.get(<span class="string">'hello'</span>,  (err, value) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"redis get"</span>, value)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="使用koa-redis"><a href="#使用koa-redis" class="headerlink" title="使用koa-redis"></a>使用koa-redis</h3><p>安装：npm i -S koa-redis<br>配置使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'koa-session'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> redisStore = <span class="built_in">require</span>(<span class="string">'koa-redis'</span>)</span><br><span class="line"><span class="keyword">const</span> redis = <span class="built_in">require</span>(<span class="string">'redis'</span>)</span><br><span class="line"><span class="keyword">const</span> redisClient = redis.createClient(<span class="number">6379</span>, <span class="string">"localhost"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wrapper = <span class="built_in">require</span>(<span class="string">'co-redis'</span>)</span><br><span class="line"><span class="keyword">const</span> client = wrapper(redisClient)</span><br><span class="line"></span><br><span class="line">app.keys = [<span class="string">'some secret'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SESS_CONFIG = &#123;</span><br><span class="line">    key: <span class="string">'richard:session'</span>,</span><br><span class="line">    store: redisStore(&#123; client &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(session(SESS_CONFIG, app))</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 查看redis</span></span><br><span class="line">    redisClient.keys(<span class="string">"*"</span>, (err, keys) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'keys: '</span>, keys)</span><br><span class="line">        keys.forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">            redisClient.get(key, (err, val) =&gt; &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(val)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> (ctx.path === <span class="string">'/favicon.ico'</span>) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">let</span> n = ctx.session.count || <span class="number">0</span></span><br><span class="line">    ctx.session.count = ++n</span><br><span class="line">    ctx.body = <span class="string">'第'</span> + n + <span class="string">'次访问'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Token认证"><a href="#Token认证" class="headerlink" title="Token认证"></a>Token认证</h2><ul>
<li><p>登录页index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.jsdelivr.net/npm/vue/dist/vue.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/axios/dist/axios.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">v-model</span>=<span class="string">"username"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">v-model</span>=<span class="string">"password"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"login"</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"logout"</span>&gt;</span>Logout<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"getUser"</span>&gt;</span>GetUser<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"logs=[]"</span>&gt;</span>Clear Log<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- log --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">"(log, index) in logs"</span> <span class="attr">:key</span>=<span class="string">"index"</span>&gt;</span></span><br><span class="line">                &#123;&#123; log &#125;&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 请求拦截器</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">// 判断是否存在token，如果存在token，每个http请求的Header都加上token</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">// Bearer 是JWT认证的头部信息</span></span></span><br><span class="line">        axios.interceptors.request.use(</span><br><span class="line">            config =&gt; &#123;</span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> token = <span class="built_in">window</span>.localStorage.getItem(<span class="string">"token"</span>)</span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (token) &#123;</span></span><br><span class="line"><span class="javascript">                    config.headers.common[<span class="string">"Authorization"</span>] = <span class="string">"Bearer "</span> + token</span></span><br><span class="line">                &#125;</span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> config</span></span><br><span class="line">            &#125;,</span><br><span class="line">            err =&gt; &#123;</span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(err)</span></span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        axios.interceptors.response.use(</span><br><span class="line">            response =&gt; &#123;</span><br><span class="line"><span class="javascript">                app.logs.push(<span class="built_in">JSON</span>.stringify(response.data));</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> response;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            err =&gt; &#123;</span><br><span class="line"><span class="javascript">                app.logs.push(<span class="built_in">JSON</span>.stringify(response.data));</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(err);</span></span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">            el: <span class="string">"#app"</span>,</span></span><br><span class="line">            data: &#123;</span><br><span class="line"><span class="javascript">                username: <span class="string">"test"</span>,</span></span><br><span class="line"><span class="javascript">                password: <span class="string">"test"</span>,</span></span><br><span class="line">                logs: []</span><br><span class="line">            &#125;,</span><br><span class="line">            methods: &#123;</span><br><span class="line"><span class="javascript">                login: <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">const</span> res = <span class="keyword">await</span> axios.post(<span class="string">"/users/login-token"</span>, &#123;</span></span><br><span class="line"><span class="javascript">                        username: <span class="keyword">this</span>.username,</span></span><br><span class="line"><span class="javascript">                        password: <span class="keyword">this</span>.password</span></span><br><span class="line">                    &#125;)</span><br><span class="line"><span class="javascript">                    localStorage.setItem(<span class="string">"token"</span>, res.data.token)</span></span><br><span class="line">                &#125;,</span><br><span class="line"><span class="javascript">                logout: <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                    localStorage.removeItem(<span class="string">"token"</span>)</span></span><br><span class="line">                &#125;,</span><br><span class="line"><span class="javascript">                getUser: <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">await</span> axios.get(<span class="string">"/users/getUser-token"</span>)</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>登录接口(服务端)</p>
</li>
<li><p>安装依赖： npm i jsonwebtoken koa-jwt -S</p>
</li>
<li><p>接口编写 index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)()</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> = <span class="built_in">require</span>((<span class="string">'koa-static'</span>))</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>)</span><br><span class="line"><span class="keyword">const</span> jwtAuth = <span class="built_in">require</span>(<span class="string">'koa-jwt'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> secret = <span class="string">"it's a secret"</span></span><br><span class="line"></span><br><span class="line">app.use(bodyParser())</span><br><span class="line">app.use(<span class="keyword">static</span>(__dirname + <span class="string">'/'</span>))</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">"/users/login-token"</span>, <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; body &#125; = ctx.request</span><br><span class="line">    <span class="comment">// 登录逻辑, 验证账户和密码，假设验证成功</span></span><br><span class="line">    <span class="comment">// 设置session</span></span><br><span class="line">    <span class="keyword">const</span> userinfo = body.username</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">        message: <span class="string">"登录成功"</span>,</span><br><span class="line">        user: userinfo,</span><br><span class="line">        <span class="comment">// 服务器端生成的token 返回给客户端</span></span><br><span class="line">        token: jwt.sign(&#123;</span><br><span class="line">            data: userinfo,</span><br><span class="line">            <span class="comment">// 设置token过期时间，一小时后，秒为单位</span></span><br><span class="line">            exp: <span class="built_in">Math</span>.floor(<span class="built_in">Date</span>.now() / <span class="number">1000</span>) + <span class="number">10</span> * <span class="number">60</span></span><br><span class="line">        &#125;, secret)</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">router.get(<span class="string">"/users/getUser-token"</span>, jwtAuth(&#123;secret&#125;), <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">    <span class="comment">// 验证通过， state.user</span></span><br><span class="line">    <span class="built_in">console</span>.log(ctx.state.user)</span><br><span class="line">    <span class="comment">// 获取session</span></span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">        message: <span class="string">"获取数据成功"</span>,</span><br><span class="line">        userinfo: ctx.state.user.data</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">app.use(router.routes())</span><br><span class="line">app.use(router.allowedMethods())</span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Oauth第三方授权登录"><a href="#Oauth第三方授权登录" class="headerlink" title="Oauth第三方授权登录"></a>Oauth第三方授权登录</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>第三方登录主要是基于OAuth 2.0。OAuth协议为用户资源的授权提供了一个安全的，开放而又简易的标准。与以往的授权方式不同之处是OAuth的授权不会使第三方触及到用户的账号信息（如用户名和密码），即第三方无需使用用户的用户名与密码就可以申请获得该用户资源的授权，因此OAuth是安全的。</p>
<h3 id="应用-1"><a href="#应用-1" class="headerlink" title="应用"></a>应用</h3><p>使用github提供的第三方登入接口。</p>
<h3 id="配置github，申请一个-OAuth-App"><a href="#配置github，申请一个-OAuth-App" class="headerlink" title="配置github，申请一个 OAuth App"></a>配置github，申请一个 OAuth App</h3><ol>
<li>先注册登录github</li>
<li>点击头像下的Settings —&gt; 点击Developer settings —&gt; 点击右侧 New OAuth App</li>
<li>填写申请app的配置:Application name,Homepage URL,Application description,Authorization callback URL</li>
<li>最重要的两项就是Homepage URL和 Authorization callback URL,<br>Homepage URL 这个是后续使用授权的URL，也就是项目目录根地址。</li>
<li>Authorization callback URL 授权成功后的回调地址，github会重定向到这个URL并携带code，获取 code后 我们才能继续获取access_token,在进一步获取用户信息。</li>
</ol>
<h3 id="授权登录步骤"><a href="#授权登录步骤" class="headerlink" title="授权登录步骤"></a>授权登录步骤</h3><ol>
<li>服务器端重定向 <a href="https://github.com/login/oauth/authorize" target="_blank" rel="noopener">https://github.com/login/oauth/authorize</a></li>
<li>github端重定向到服务端，并携带了code，保存code</li>
<li>根据code请求github接口<a href="https://github.com/login/oauth/access_token" target="_blank" rel="noopener">https://github.com/login/oauth/access_token</a>, 获取access_token</li>
<li>根据access_token请求github接口<a href="https://api.github.com/user?access_token=xxxxxxxxxxxx" target="_blank" rel="noopener">https://api.github.com/user?access_token=xxxxxxxxxxxx</a> ,获取用户信息</li>
</ol>
<h3 id="登录页面-index-html"><a href="#登录页面-index-html" class="headerlink" title="登录页面 index.html"></a>登录页面 index.html</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.jsdelivr.net/npm/vue/dist/vue.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/axios/dist/axios.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/github/login"</span>&gt;</span>login with github<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="登录接口-服务器-index-js"><a href="#登录接口-服务器-index-js" class="headerlink" title="登录接口(服务器)index.js"></a>登录接口(服务器)index.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)()</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> = <span class="built_in">require</span>(<span class="string">'koa-static'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">'axios'</span>)</span><br><span class="line"><span class="keyword">const</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>)</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">static</span>(__dirname, <span class="string">'/'</span>))</span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    client_id: <span class="string">'0beb87ba1a33ceeb41ff'</span>,</span><br><span class="line">    client_secret: <span class="string">'5b38b93be974d56220dd497dbec1c5d80f4f183b'</span></span><br><span class="line">&#125;</span><br><span class="line">router.get(<span class="string">'/github/login'</span>, <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">    <span class="comment">// 重定向到认证接口，并配置参数</span></span><br><span class="line">    <span class="keyword">var</span> path = <span class="string">"https://github.com/login/oauth/authorize"</span></span><br><span class="line">    path += <span class="string">'?client_id='</span> + config.client_id</span><br><span class="line">    <span class="comment">// 转发到授权服务器</span></span><br><span class="line">    ctx.redirect(path)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/github/callback'</span>, <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'callback..'</span>)</span><br><span class="line">    <span class="comment">// github 那边重定向到当前url下，并返回了code</span></span><br><span class="line">    <span class="keyword">const</span> code = ctx.query.code</span><br><span class="line">    <span class="keyword">const</span> params = &#123;</span><br><span class="line">        client_id: config.client_id,</span><br><span class="line">        client_secret: config.client_secret,</span><br><span class="line">        code: code</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 向github的接口发送请求，获取access_token</span></span><br><span class="line">    <span class="keyword">let</span> res = <span class="keyword">await</span> axios.post(<span class="string">'https://github.com/login/oauth/access_token'</span>, params)</span><br><span class="line">    <span class="keyword">const</span> access_token = querystring.parse(res.data).access_token</span><br><span class="line">    <span class="comment">// 再拿access_token去请求用户信息。</span></span><br><span class="line">    res = <span class="keyword">await</span> axios.get(<span class="string">'https://api.github.com/user?access_token='</span> + access_token)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'userAccess: '</span>, res.data)</span><br><span class="line">    ctx.body = <span class="string">`</span></span><br><span class="line"><span class="string">        &lt;h1&gt;Hello <span class="subst">$&#123;res.data.login&#125;</span>&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;img src="<span class="subst">$&#123;res.data.avatar_url&#125;</span>" alt=""&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.use(router.routes())</span><br><span class="line">app.use(router.allowedMethods())</span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/10/cookie-session-token/" data-id="ckh5kzawq0012tgv2kwjsrc89" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-单点登陆" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/06/单点登陆/" class="article-date">
  <time datetime="2020-03-06T01:39:52.000Z" itemprop="datePublished">2020-03-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/06/单点登陆/">单点登陆SSO</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>单点登陆SSO(Single Sign On): 就是在多系统环境中实现,一次登陆,其他系统不再需要登陆也能协作.<br>实现单点登陆就是要解决如何产生和存储那个信任,再就是其他系统如何验证这个信任的有效性.<br>要点:</p>
<ul>
<li>存储信任</li>
<li>验证信任</li>
</ul>
<h1 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h1><h2 id="Cookie-为凭证媒介"><a href="#Cookie-为凭证媒介" class="headerlink" title="Cookie 为凭证媒介"></a>Cookie 为凭证媒介</h2><p>最简单的单点登陆实现方式:是使用cookie作为媒介,存放用户凭证.用户登陆父应用之后,返回一个加密的cookie.当用户访问子应用的时候,携带上这个cookie,子应用解密cookie并进行校验,校验通过则登陆用户.<br><img src="/static/img/sso_cookie.png"></p>
<p>问题:</p>
<ol>
<li>cookie存储在客户端,不安全</li>
<li>不能跨域实现免登陆.</li>
</ol>
<h2 id="JSONP方式"><a href="#JSONP方式" class="headerlink" title="JSONP方式"></a>JSONP方式</h2><p>对于跨域问题,可以使用JSONP实现.<br>用户在父应用中登录后，跟Session匹配的Cookie会存到客户端中，当用户需要登录子应用的时候，子应用访问父应用提供的JSONP接口，并在请求中带上父应用域名下的Cookie，父应用接收到请求，验证用户的登录状态，返回加密的信息，子应用通过解析返回来的加密信息来验证用户，如果通过验证则登录用户。<br><img src="/static/img/sso_jsonp.png"></p>
<p>问题: 虽然能解决跨域问题但和cookie一样当cookie加密算法泄露,就能伪造响应请求.</p>
<h2 id="页面重定向的方式"><a href="#页面重定向的方式" class="headerlink" title="页面重定向的方式"></a>页面重定向的方式</h2><p>通过父应用和子应用来回重定向中进行通信，实现信息的安全传递。<br>父应用提供一个GET方式的登录接口，用户通过子应用重定向连接的方式访问这个接口，如果用户还没有登录，则返回一个的登录页面，用户输入账号密码进行登录。如果用户已经登录了，则生成加密的Token，并且重定向到子应用提供的验证Token的接口，通过解密和校验之后，子应用登录当前用户。</p>
<img src="/static/img/sso_redirect.png">


<h2 id="使用独立的登陆系统"><a href="#使用独立的登陆系统" class="headerlink" title="使用独立的登陆系统"></a>使用独立的登陆系统</h2><p>大型应用会把授权的逻辑和用户信息的相关逻辑独立成一个应用,称为用户中心.用户中心不处理业务逻辑,只是处理用户信息的管理以及授权给第三方应用.第三方应用需要登陆的时候,则把用户的登陆请求转发给用户中心进行处理,用户处理完返回凭证,第三方应用验证凭证,通过后就可以登陆用户.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/06/单点登陆/" data-id="ckh5kzax5001itgv2ryyx7aaf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Docker" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/25/Docker/" class="article-date">
  <time datetime="2020-02-25T03:31:48.000Z" itemprop="datePublished">2020-02-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/25/Docker/">Docker</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Docker是什么"><a href="#Docker是什么" class="headerlink" title="Docker是什么?"></a>Docker是什么?</h1><p>一次封装,到处执行(不用配置环境,任何环境下都能运行应用,极大简化部署)<br>基于lunux的高效,敏捷,轻量级的容器(轻量虚拟)的方案</p>
<ul>
<li><p>虚拟化技术<br>完全虚拟化: VMware Workstation, VirtualBox<br>硬件辅助虚拟化: InterVT, AMD-V<br>超虚拟化技术: Xen<br>操作系统级: Docker LXC容器</p>
</li>
<li><p>部署一个典型的前后端分离的系统<br>前端工程化- Webpack(Taro)<br>后端- Nodejs<br>数据库- MongoDB<br>Nginx- 静态服务, 反向代理</p>
</li>
<li><p>特点</p>
</li>
</ul>
<ol>
<li>高效的利用系统资源</li>
<li>快速的启动时间</li>
<li>一致的运行环境</li>
<li>持续交付和部署</li>
<li>更轻松的迁移</li>
</ol>
<h1 id="Docker-中的三个重要概念"><a href="#Docker-中的三个重要概念" class="headerlink" title="Docker 中的三个重要概念"></a>Docker 中的三个重要概念</h1><ol>
<li>镜像Image<br>面向Docker的只读模板(类比 类的概念)</li>
<li>容器Container<br>镜像的运行实例(类比 实例的概念)</li>
<li>仓库(Registry)<br>存储镜像的服务器(类比 github代码仓库)</li>
</ol>
<h1 id="Docker安装"><a href="#Docker安装" class="headerlink" title="Docker安装"></a>Docker安装</h1><ol>
<li>申请云服务器</li>
<li>安装过程(将docker安装在云服务器上)</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apt升级</span></span><br><span class="line">sudo apt-get update</span><br><span class="line"><span class="comment"># 添加相关软件包</span></span><br><span class="line">sudo apt-get install \</span><br><span class="line">  apt-transport-https \</span><br><span class="line">  ca-certificates \</span><br><span class="line">  curl \</span><br><span class="line">  software-properties-common</span><br><span class="line"><span class="comment"># 下载软件包的合法性,需要添加软件源的 GPG 密钥</span></span><br><span class="line">curl -fsSL https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line"><span class="comment"># source.list 中添加 Docker 软件源</span></span><br><span class="line">sudo add-apt-repository \</span><br><span class="line">   <span class="string">"deb [arch=amd64] https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu \</span></span><br><span class="line"><span class="string">   <span class="variable">$(lsb_release -cs)</span> \</span></span><br><span class="line"><span class="string">   stable"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Docker CE</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install docker-ce</span><br><span class="line"><span class="comment"># 启动 Docker CE</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> docker</span><br><span class="line">sudo systemctl start docker</span><br><span class="line"><span class="comment"># 建立 docker 用户组(附加)</span></span><br><span class="line">sudo groupadd docker  <span class="comment"># 添加docker用户组</span></span><br><span class="line">sudo usermod -aG docker <span class="variable">$USER</span> <span class="comment"># 将登陆用户加入到docker用户组中</span></span><br><span class="line">newgrp docker     <span class="comment"># 更新用户组</span></span><br><span class="line">docker ps    <span class="comment"># 测试docker命令是否可以正常使用</span></span><br><span class="line"><span class="comment"># Helloworld测试</span></span><br><span class="line">docker run hello-world</span><br></pre></td></tr></table></figure>

<p>关于权限的问题:<br>docker进程使用Unix Socket而不是TCP端口。而默认情况下，Unix socket属于root用户，需要root权限才能访问。<br>docker守护进程启动的时候，会默认赋予名字为docker的用户组读写Unix socket的权限，因此只要创建docker用户组，并将当前用户加入到docker用户组中，那么当前用户就有权限访问Unix socket了，进而也就可以执行docker相关命令.<br>3. 镜像加速</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>

<p>写入如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;registry-mirrors&quot;: [</span><br><span class="line">        &quot;https://dockerhub.azk8s.cn&quot;,</span><br><span class="line">        &quot;https://reg-mirror.qiniu.com&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启docker:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<h1 id="Docker常用命令"><a href="#Docker常用命令" class="headerlink" title="Docker常用命令"></a>Docker常用命令</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载镜像：docker pull &lt;镜像名:tag&gt;    如：下载centos镜像</span></span><br><span class="line">docker pull centos</span><br><span class="line">docker pull sameersbn/redmine:latest</span><br><span class="line"><span class="comment"># 查看已下载镜像</span></span><br><span class="line">docker images</span><br><span class="line"><span class="comment"># 删除容器</span></span><br><span class="line">docker rm &lt;容器名 or ID&gt;</span><br><span class="line"><span class="comment"># 查看容器日志</span></span><br><span class="line">docker logs -f &lt;容器名 or ID&gt;</span><br><span class="line"><span class="comment"># 查看正在运行的容器</span></span><br><span class="line">docker ps</span><br><span class="line"><span class="comment"># 查看所有的容器，包括已经停止的。</span></span><br><span class="line">docker ps -a </span><br><span class="line"><span class="comment"># 删除所有容器</span></span><br><span class="line">docker rm $(docker ps -a -q)</span><br><span class="line"><span class="comment"># 停止、启动、杀死指定容器</span></span><br><span class="line">docker start &lt;容器名 or ID&gt; <span class="comment"># 启动容器</span></span><br><span class="line">docker stop &lt;容器名 or ID&gt; <span class="comment"># 启动容器</span></span><br><span class="line">docker <span class="built_in">kill</span> &lt;容器名 or ID&gt; <span class="comment"># 杀死容器</span></span><br><span class="line"><span class="comment"># 后台运行 docker run -d &lt;Other Parameters&gt;</span></span><br><span class="line">docker run -d -p 127.0.0.1:33301:22 centos6-ssh</span><br><span class="line"><span class="comment"># 暴露端口： 一共有三种形式进行端口映射</span></span><br><span class="line">docker -p ip:hostPort:containerPort <span class="comment"># 映射指定地址的主机端口到容器端口</span></span><br><span class="line"><span class="comment"># 例如：docker -p 127.0.0.1:3306:3306 映射本机3306端口到容器的3306端口</span></span><br><span class="line">docker -p ip::containerPort <span class="comment"># 映射指定地址的任意可用端口到容器端口</span></span><br><span class="line"><span class="comment"># 例如：docker -p 127.0.0.1::3306 映射本机的随机可用端口到容器3306端口</span></span><br><span class="line">docer -p hostPort:containerPort <span class="comment"># 映射本机的指定端口到容器的指定端口</span></span><br><span class="line"><span class="comment"># 例如：docker -p 3306:3306 # 映射本机的3306端口到容器的3306端口</span></span><br><span class="line"><span class="comment"># 映射数据卷</span></span><br><span class="line">docker -v /home/data:/opt/data <span class="comment"># 这里/home/data 指的是宿主机的目录地址，后者则是容器的目录地址</span></span><br></pre></td></tr></table></figure>

<h1 id="SSH-远程操作服务器"><a href="#SSH-远程操作服务器" class="headerlink" title="SSH 远程操作服务器"></a>SSH 远程操作服务器</h1><p>SSH(Secure Shell Protocol),OpenSSH是SSH协议的免费开源实现.<br>OpenSSH包含服务端程序和客户端工具,用来加密远程控件和文件传输过程中的数据.因而该工具可以帮助我们在互联网上安全地访问远程服务器,因为SSH的所有连接都是加密的.OpenSSH提供了安全隧道功能和多种身份验证方法,支持SSH协议的所有版本.</p>
<ol>
<li><p>SSH连接配置<br>Linux下SSH分为客户端openssh-client和服务器openssh-server.客户端的SSH程序是用SSH来连接别的电脑的.服务器的SSH程序是让别的电脑通过SSH连接本机的.(客户端openssh-client通常Ubuntu会默认安装)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install openssh-client <span class="comment"># 本地主机运行此条，实际上通常是默认安装client端程序的</span></span><br><span class="line">sudo apt install openssh-server <span class="comment"># 在被连接的服务器运行此条命令安装</span></span><br><span class="line">sudo service ssh start <span class="comment"># 在被连接的服务器启动ssh</span></span><br><span class="line">systemctl restart sshd.service <span class="comment">#重启ssh 服务</span></span><br><span class="line">sudo ps -e |grep ssh <span class="comment"># 查看是否启动ssh</span></span><br><span class="line">ifconfig <span class="comment"># 查看主机ip</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>本地主机连接服务器<br>本机上运行以下命令来连接远程服务器.使用默认的端口:22</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ssh username@111.229.83.147</span><br><span class="line"><span class="comment"># 如果远程服务器的SSH服务不是使用22端口,那么SSH链接时则需要用-p指定端口（如258端口）</span></span><br><span class="line">ssh -p 258 username@111.229.83.147</span><br><span class="line"><span class="comment"># 远程服务其配置了密钥 使用密钥登陆("home/richard/ssh_key"为密钥的绝对路径)</span></span><br><span class="line">ssh -i <span class="string">"/home/richard/ssh_key"</span> ubuntu@192.168.11.123</span><br><span class="line"><span class="comment"># 退出远程服务器</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>本地主机与远程服务器主机互传文件</p>
</li>
</ol>
<ul>
<li><p>下载到本地</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scp coke@192.168.1.100:~/Desktop/a.txt ./Desktop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载整个目录</span></span><br><span class="line">scp -r username@serverip:/sever_path  /local_path</span><br></pre></td></tr></table></figure>
</li>
<li><p>上传文件到远程服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定端口用大写P</span></span><br><span class="line">scp -P 258 test.txt john@192.168.1.100:~/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传整个目录</span></span><br><span class="line">scp -r /local_dir username@serverip:/server_dir</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="4">
<li>使用密钥<br>所谓”公钥登录”，就是用户将自己的公钥储存在远程主机上。登录的时候，远程主机会向用户发送一段随机字符串，用户用自己的私钥加密后，再发回来。远程主机用事先储存的公钥进行解密，如果成功，就证明用户是可信的，直接允许登录shell，不再要求密码。</li>
</ol>
<ul>
<li>生成密钥对<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">"youremail@example.com"</span> </span><br><span class="line"><span class="comment"># -t 表示选择的类型,类型为rsa一种非对称的加密算法(产生公钥和私钥).</span></span><br><span class="line"><span class="comment"># 如果ssh_public_key要绑定github,那么邮箱为注册github的邮箱</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>执行以后会在$HOME目录下生成一个.ssh文件夹,其中包含私钥文件id_rsa和公钥文件id_rsa.pub.</p>
<ul>
<li><p>复制公钥到服务器<br>在进行以下配置以后，再进行连接时,就可以免去口令(密码)的输入了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录远程服务器</span></span><br><span class="line">ssh yucicheung@10.170.11.147 </span><br><span class="line"><span class="comment"># 在服务器上创建.ssh文件夹,如果已经存在就跳过此步</span></span><br><span class="line">mkdir .ssh </span><br><span class="line"><span class="comment"># 为了保证.ssh文件夹的安全，应取消其他用户对文件夹的所有权限</span></span><br><span class="line">chmod 700 .ssh</span><br><span class="line"><span class="comment"># 退出登录</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="comment"># 本地主机的公钥复制到远程服务器,作为已认证密钥</span></span><br><span class="line">scp /home/richard/.ssh/id_rsa.pub ubuntu@192.168.0.1:/home/ubuntu/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改本地/etc/ssh/sshd_config文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/ssh/sshd_config</span><br><span class="line"> </span><br><span class="line">RSAAuthentication yes      <span class="comment">#开启私钥验证</span></span><br><span class="line">PubkeyAuthentication yes   <span class="comment">#开启公钥验证</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>Note: 在使用云服务器的时候(如腾讯云,可以在它的控制台自己启用ssh密钥),生成密钥之后,我们将它下载到本地,在之后通过ssh访问云服务器的时候使用如下命令.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 远程服务自己配置了密钥 本地下载密钥并保存,使用密钥登陆("home/richard/ssh_key"为本地密钥保存的绝对路径)</span></span><br><span class="line">ssh -i <span class="string">"/home/richard/ssh_key"</span> ubuntu@192.168.11.123</span><br></pre></td></tr></table></figure>

<h1 id="简单的Nginx服务"><a href="#简单的Nginx服务" class="headerlink" title="简单的Nginx服务"></a>简单的Nginx服务</h1><ol>
<li><p>拉取官方镜像 - 面向docker的只读模板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>由指定镜像创建容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># www目录里面放一个index.html</span></span><br><span class="line">mkdir www</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'hello docker'</span> &gt;&gt; www/index.html</span><br><span class="line"><span class="comment"># 创建并启动容器 (由nginx 镜像 创建容器)</span></span><br><span class="line"><span class="comment"># -p 指定容器暴露80端口映射到真实主机的8000端口</span></span><br><span class="line"><span class="comment"># -v volume指定当前主机文件夹下文件挂载到容器的某目录下</span></span><br><span class="line">docker run -p 8000:80 -v <span class="variable">$PWD</span>/www:/usr/share/nginx/html nginx</span><br><span class="line"><span class="comment"># 后台启动 (-d detach 后台运行,会在终端输出这个容器的uuid)</span></span><br><span class="line">docker run -p 80:80 -v <span class="variable">$PWD</span>/www:/usr/share/nginx/html -d nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>容器操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ff6 是容器ID的前三个字母</span></span><br><span class="line"><span class="comment"># 启动容器</span></span><br><span class="line">docker start ff6</span><br><span class="line"><span class="comment"># 停止容器</span></span><br><span class="line">docker stop ff6 </span><br><span class="line"><span class="comment"># 重启容器</span></span><br><span class="line">docker restart ff6</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line"><span class="comment"># 查看全部</span></span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>
</li>
<li><p>伪终端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exec 用于在运行中的容器中执行命令</span></span><br><span class="line"><span class="comment"># 选项</span></span><br><span class="line"><span class="comment"># -d 分离模式即在后台运行</span></span><br><span class="line"><span class="comment"># -i 即使没有附加也保持STDIN标准输入打开</span></span><br><span class="line"><span class="comment"># -t 分配一个伪终端 /bin/bash  shell 命令终端</span></span><br><span class="line">docker <span class="built_in">exec</span> -it ff6 /bin/bash</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除容器</span></span><br><span class="line">docker rm ff6</span><br><span class="line"><span class="comment"># 删除镜像</span></span><br><span class="line">docker rmi nginx</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="Dockerfile-定制镜像"><a href="#Dockerfile-定制镜像" class="headerlink" title="Dockerfile 定制镜像"></a>Dockerfile 定制镜像</h1><p>镜像的定制实际上就是定制每一层所添加的配置,文件.如果我们可以把每一层修改,安装,构建,操作的命令都写入一个脚本.用这个脚本来构建,定制镜像,那么之前提及的无法重复的问题,镜像构建透明性的问题,体积问题就都会解决.这个脚本就是Dockerfile.</p>
<p>总结: 脚本创建镜像</p>
<h2 id="Dockerfile-脚本常用指令"><a href="#Dockerfile-脚本常用指令" class="headerlink" title="Dockerfile 脚本常用指令"></a>Dockerfile 脚本常用指令</h2><ol>
<li><p>FROM<br>指明 构建的新镜像来自于哪个基础镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FROM nginx:latest</span><br></pre></td></tr></table></figure>
</li>
<li><p>RUN<br>构建镜像时运行的Shell命令,这个shell命令是在docker进程内执行的,不是宿主机上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RUN <span class="built_in">echo</span> <span class="string">'&lt;h1&gt;Hello world&lt;/h1&gt;'</span> &gt; /usr/share/nginx/html/index.html</span><br></pre></td></tr></table></figure>
</li>
<li><p>CMD<br>启动容器时,在容器内执行的Shell命令,不是宿主机上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CMD [<span class="string">"node"</span>, <span class="string">"app.js"</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>ADD<br>拷贝当前宿主机下的文件或目录到镜像中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拷贝当前文件夹下的目录到 镜像的 /app目录下</span></span><br><span class="line">ADD . /app</span><br></pre></td></tr></table></figure>
</li>
<li><p>WORKDIR<br>进入app目录下面,类似cd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WORKDIR /data</span><br></pre></td></tr></table></figure>
</li>
<li><p>EXPOSE<br>声明容器对外暴露的端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPOSE 3000</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="定制自己的web服务器镜像"><a href="#定制自己的web服务器镜像" class="headerlink" title="定制自己的web服务器镜像"></a>定制自己的web服务器镜像</h2><h3 id="修改Dockerfile"><a href="#修改Dockerfile" class="headerlink" title="修改Dockerfile"></a>修改Dockerfile</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi Dockerfile</span></span><br><span class="line">FROM nginx:latest</span><br><span class="line">RUN <span class="built_in">echo</span> <span class="string">'&lt;h1&gt;Hello world&lt;/h1&gt;'</span> &gt; /usr/share/nginx/html/index.html</span><br></pre></td></tr></table></figure>

<h3 id="定制镜像"><a href="#定制镜像" class="headerlink" title="定制镜像"></a>定制镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建命名为nginx标签为richard 的nginx镜像 在当前文件夹下(这个.表示在当前文件下查找Dockerfile)</span></span><br><span class="line">docker build -t nginx:richard .</span><br></pre></td></tr></table></figure>

<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><p>启动并生成一个docker容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8000:80 nginx:richard</span><br></pre></td></tr></table></figure>

<h2 id="定制Nodejs镜像"><a href="#定制Nodejs镜像" class="headerlink" title="定制Nodejs镜像"></a>定制Nodejs镜像</h2><h3 id="新建node项目"><a href="#新建node项目" class="headerlink" title="新建node项目"></a>新建node项目</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm init -y</span><br><span class="line">npm i koa -s</span><br></pre></td></tr></table></figure>

<p>app.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&apos;koa&apos;)</span><br><span class="line">const app = new Koa()</span><br><span class="line">app.use(ctx =&gt; &#123;</span><br><span class="line">   ctx.body = &apos;Hello Docker&apos;</span><br><span class="line">&#125;)</span><br><span class="line">app.listen(3000, () =&gt; &#123;</span><br><span class="line">   console.log(&apos;app started at http://localhost:3000/&apos;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="定制Dockerfile"><a href="#定制Dockerfile" class="headerlink" title="定制Dockerfile"></a>定制Dockerfile</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 制定 node镜像的版本</span></span><br><span class="line">FROM node:10-alpine</span><br><span class="line"><span class="comment"># 拷贝当前目录下面的文件到app目录下</span></span><br><span class="line">ADD . /app/</span><br><span class="line"><span class="comment"># 进入到app目录下面,类似cd</span></span><br><span class="line">WORKDIR /app</span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">RUN npm install</span><br><span class="line"><span class="comment"># 对外暴露的端口</span></span><br><span class="line">EXPOSE 3000</span><br><span class="line"><span class="comment"># 程序启动脚本</span></span><br><span class="line">CMD [<span class="string">"node"</span>, <span class="string">"app.js"</span>]</span><br></pre></td></tr></table></figure>

<h3 id="定制镜像-1"><a href="#定制镜像-1" class="headerlink" title="定制镜像"></a>定制镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建镜像</span></span><br><span class="line">docker build -t mynode . </span><br><span class="line"><span class="comment"># 根据镜像mynode创建并启动容器</span></span><br><span class="line">docker run -p 3000:3000 -d mynode</span><br></pre></td></tr></table></figure>

<h2 id="定制PM2镜像"><a href="#定制PM2镜像" class="headerlink" title="定制PM2镜像"></a>定制PM2镜像</h2><p>pm2是node进程管理工具,可以用它来管理node进程,并查看node进程的状态,支持性能监控,进程守护,负载均衡等功能.</p>
<h3 id="pm2-使用简介"><a href="#pm2-使用简介" class="headerlink" title="pm2 使用简介"></a>pm2 使用简介</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局安装</span></span><br><span class="line">npm install -g pm2</span><br><span class="line"><span class="comment"># 启动进程/应用 </span></span><br><span class="line">pm2 start bin/www 或 pm2 start app.js</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名进程/应用 </span></span><br><span class="line">pm2 start app.js --name wb123</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加进程/应用 watch </span></span><br><span class="line">pm2 start bin/www --watch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结束进程/应用 </span></span><br><span class="line">pm2 stop www</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结束所有进程/应用</span></span><br><span class="line">pm2 stop all</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除进程/应用 </span></span><br><span class="line">pm2 delete www</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除所有进程/应用 </span></span><br><span class="line">pm2 delete all</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有进程/应用 </span></span><br><span class="line">pm2 list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看某个进程/应用具体情况</span></span><br><span class="line">pm2 describe www</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看进程/应用的资源消耗情况 </span></span><br><span class="line">pm2 monit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pm2的日志 </span></span><br><span class="line">pm2 logs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看某个进程/应用的日志</span></span><br><span class="line">pm2 logs www</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新启动进程/应用 </span></span><br><span class="line">pm2 restart www</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新启动所有进程/应用 </span></span><br><span class="line">pm2 restart all</span><br></pre></td></tr></table></figure>

<h3 id="新建-dockerignore"><a href="#新建-dockerignore" class="headerlink" title="新建.dockerignore"></a>新建.dockerignore</h3><p>新建.dockerignore文件,增加如下代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker 会忽略 node_modules文件夹</span></span><br><span class="line">node_modules</span><br></pre></td></tr></table></figure>

<h3 id="pm2-运行脚本"><a href="#pm2-运行脚本" class="headerlink" title="pm2 运行脚本"></a>pm2 运行脚本</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// process.yml</span></span><br><span class="line">apps:</span><br><span class="line"> - script : app.js</span><br><span class="line">   instances: <span class="number">2</span></span><br><span class="line">   watch : <span class="literal">true</span></span><br><span class="line">   env   :</span><br><span class="line">     NODE_ENV: production</span><br></pre></td></tr></table></figure>

<h3 id="新建Dockerfile"><a href="#新建Dockerfile" class="headerlink" title="新建Dockerfile"></a>新建Dockerfile</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile</span></span><br><span class="line">FROM keymetrics/pm2:latest-alpine</span><br><span class="line">WORKDIR /usr/src/app</span><br><span class="line">ADD . /usr/src/app</span><br><span class="line">RUN npm install</span><br><span class="line">EXPOSE 3000</span><br><span class="line"><span class="comment">#pm2在docker中使用命令为pm2-docker</span></span><br><span class="line">CMD [<span class="string">"pm2-runtime"</span>, <span class="string">"start"</span>, <span class="string">"process.yml"</span>]</span><br></pre></td></tr></table></figure>

<h3 id="定制镜像-2"><a href="#定制镜像-2" class="headerlink" title="定制镜像"></a>定制镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t mypm2 .</span><br></pre></td></tr></table></figure>

<h3 id="创建并启动容器"><a href="#创建并启动容器" class="headerlink" title="创建并启动容器"></a>创建并启动容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 3000:3000 -d mypm2</span><br></pre></td></tr></table></figure>

<h1 id="Docker-compose"><a href="#Docker-compose" class="headerlink" title="Docker-compose"></a>Docker-compose</h1><p>Docker-compose 是Docker官方开源的项目,负责实现对Docker容器集群的快速编排(一次启动多个容器).</p>
<h2 id="安装稳定版"><a href="#安装稳定版" class="headerlink" title="安装稳定版"></a>安装稳定版</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ sudo curl -L <span class="string">"https://github.com/docker/compose/releases/download/1.26.2/docker-compose-<span class="variable">$(uname -s)</span>-<span class="variable">$(uname -m)</span>"</span> -o /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line"><span class="comment"># 可执行</span></span><br><span class="line">$ sudo chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line"><span class="comment"># 软链接</span></span><br><span class="line">$ sudo ln -s /usr/<span class="built_in">local</span>/bin/docker-compose /usr/bin/docker-compose</span><br></pre></td></tr></table></figure>

<h2 id="新建docker-compose-yml文件"><a href="#新建docker-compose-yml文件" class="headerlink" title="新建docker-compose.yml文件"></a>新建docker-compose.yml文件</h2><p>docker-compose.yml文件描述了docker-compose按顺序启动的容器的相关配置.<br>例子如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">'3.1'</span></span><br><span class="line">services:</span><br><span class="line">    mongo: <span class="comment"># 服务名</span></span><br><span class="line">        image: mongo <span class="comment"># 镜像名 </span></span><br><span class="line">        restart: always</span><br><span class="line">        ports:</span><br><span class="line">            - 27017:27017</span><br><span class="line">    mongo-express:</span><br><span class="line">        image: mongo-express</span><br><span class="line">        restart: always</span><br><span class="line">        ports:</span><br><span class="line">        - 8000:8081</span><br></pre></td></tr></table></figure>

<h2 id="docker-compose命令"><a href="#docker-compose命令" class="headerlink" title="docker-compose命令"></a>docker-compose命令</h2><p>必须在docker-compose.yml所在的文件夹下启动如下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启</span></span><br><span class="line">docker-compose up</span><br><span class="line"><span class="comment"># 关闭</span></span><br><span class="line">docker-compse down</span><br></pre></td></tr></table></figure>

<h1 id="构建前后端分离的项目"><a href="#构建前后端分离的项目" class="headerlink" title="构建前后端分离的项目"></a>构建前后端分离的项目</h1><p>项目基本目录结构: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-   backend  <span class="comment"># 后端代码</span></span><br><span class="line">        -models <span class="comment"># 数据库</span></span><br><span class="line">-   frontend <span class="comment"># 前端代码</span></span><br><span class="line">-   nginx/conf.d <span class="comment"># nginx 静态服务配置</span></span><br><span class="line">        -   docker.conf</span><br></pre></td></tr></table></figure>

<ol>
<li><p>nginx静态服务配置<br>/nginx/conf.d/default.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx 静态服务</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /var/www/html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.(gif|jpg|png)$ &#123;</span><br><span class="line">        root /static;</span><br><span class="line">        index index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 反向代理</span></span><br><span class="line">    <span class="comment"># http://app-pm2 是docker内部的一个子网域名 对应Docker-compose.yml里面的service 下面的每个 service name</span></span><br><span class="line">    location /api &#123;</span><br><span class="line">            proxy_pass  http://app-pm2:3000;</span><br><span class="line">            proxy_redirect     off;</span><br><span class="line">            proxy_set_header   Host             <span class="variable">$host</span>;</span><br><span class="line">            proxy_set_header   X-Real-IP        <span class="variable">$remote_addr</span>;</span><br><span class="line">            proxy_set_header   X-Forwarded-For  <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>docker-compose.yml<br>新建 /docker-compose.yml<br>之后使用docker-compose up 命令执行该脚本,完成创建镜像,启动容器的一系列工作.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">'3.1'</span></span><br><span class="line">services:</span><br><span class="line">  app-pm2:</span><br><span class="line">      container_name: app-pm2</span><br><span class="line">      <span class="comment">#构建容器</span></span><br><span class="line">      build: ./backend</span><br><span class="line">      ports:</span><br><span class="line">        - <span class="string">"3000:3000"</span></span><br><span class="line">  mongo:</span><br><span class="line">    image: mongo</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 27017:27017</span><br><span class="line">  mongo-express:</span><br><span class="line">    image: mongo-express</span><br><span class="line">    restart: always </span><br><span class="line">    ports:</span><br><span class="line">      - 8081:8081</span><br><span class="line">  nginx:</span><br><span class="line">    restart: always</span><br><span class="line">    image: nginx</span><br><span class="line">    ports:</span><br><span class="line">      - 8091:80</span><br><span class="line">    volumes:</span><br><span class="line">      <span class="comment"># 将主机nginx的配置文件 挂载到 nginx镜像的目录下</span></span><br><span class="line">      - ./nginx/conf.d/:/etc/nginx/conf.d </span><br><span class="line">      <span class="comment"># 将主机前端代码 挂载 到 nginx镜像目录下</span></span><br><span class="line">      - ./frontend/dist:/var/www/html/</span><br><span class="line">      <span class="comment"># 将主机静态文件目录 挂载到nginx镜像的目录下</span></span><br><span class="line">      - ./static/:/static/</span><br></pre></td></tr></table></figure>
</li>
<li><p>process.yml<br>新建/backend/process.yml,<br>pm2启动之后要执行的脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apps:</span><br><span class="line"> - script : server.js</span><br><span class="line">  instances: 2</span><br><span class="line">  watch : <span class="literal">true</span></span><br><span class="line">  env   :</span><br><span class="line">    NODE_ENV: production</span><br></pre></td></tr></table></figure>
</li>
<li><p>Dockerfile<br>新建/backend/Dockerfile用于定制PM2镜像,并执行一些命令.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FROM keymetrics/pm2:latest-alpine</span><br><span class="line">WORKDIR /usr/src/app</span><br><span class="line">ADD . /usr/src/app</span><br><span class="line">RUN npm config <span class="built_in">set</span> registry https://registry.npm.taobao.org/ &amp;&amp; \  </span><br><span class="line">   npm i</span><br><span class="line">EXPOSE 3000</span><br><span class="line"><span class="comment">#pm2在docker中使用命令为pm2-docker</span></span><br><span class="line">CMD [<span class="string">"pm2-runtime"</span>, <span class="string">"start"</span>,  <span class="string">"process.yml"</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>.dockerignore<br>新建/backend/.dockerignore文件<br>用于添加文件到镜像时,忽略node_module文件夹.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_module</span><br></pre></td></tr></table></figure>
</li>
<li><p>数据库配置<br>用于配置后端数据库<br>/backend/models/conf.js</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">    url: <span class="string">"mongodb://mongo:27017"</span>, <span class="comment"># docker 内部的mongo域名, 对应docker-compose.yml中声明的名字</span></span><br><span class="line">    dbName: <span class="string">'taro'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="CI持续集成"><a href="#CI持续集成" class="headerlink" title="CI持续集成"></a>CI持续集成</h1><p>代码提交到代码库(production分支), 服务器就自动拉取代码更新.<br>使用到了github的webhooks,来获取github代码库的更新的相关信息,在执行服务器代码拉取最新代码,完成服务器代码部署.</p>
<h2 id="webhooks"><a href="#webhooks" class="headerlink" title="webhooks"></a>webhooks</h2><ol>
<li>在github的代码库里新建一个webhooks</li>
<li>新建本地代码webhooks.js获取push操作.</li>
<li>新建deploy-dev.sh 用于webhooks执行后,检查到代码库的更新,然后就会去执行deploy-dev.sh脚本,这个脚本会去执行部署到服务器的一些操作(拉取代码, 重新编译docker容器)</li>
</ol>
<h3 id="Add-webhook"><a href="#Add-webhook" class="headerlink" title="Add webhook"></a>Add webhook</h3><p>在github代码库里面添加webhooks<br>settings&gt;add webhooks</p>
<ol>
<li>Payload URL<br>接收webhook POST请求的服务器地址, 我们自己的web应用的url</li>
<li>Content type<br>指定我们从github接收的数据类型.</li>
<li>Secret<br>为保证安全设置的密码,在我们的web应用请求webhooks,也需要设置相同的secret.</li>
<li>Events<br>Events是webhook的核心。只要对存储库执行某项操作，就会触发这些webhook，服务器的有效负载URL会拦截并执行操作。</li>
</ol>
<h3 id="服务端接受webhooks-回调信息-并做出操作"><a href="#服务端接受webhooks-回调信息-并做出操作" class="headerlink" title="服务端接受webhooks 回调信息,并做出操作"></a>服务端接受webhooks 回调信息,并做出操作</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">var</span> createHandler = <span class="built_in">require</span>(<span class="string">'github-webhook-handler'</span>)</span><br><span class="line"><span class="keyword">var</span> handler = createHandler(&#123; <span class="attr">path</span>: <span class="string">'/webhooks'</span>, <span class="attr">secret</span>: <span class="string">'myHashSecret'</span> &#125;)</span><br><span class="line"><span class="comment">// 上面的 secret 保持和 GitHub 后台设置的一致</span></span><br><span class="line"><span class="comment">// spawn 用于执行命令</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run_cmd</span>(<span class="params">cmd, args, callback</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> spawn = <span class="built_in">require</span>(<span class="string">'child_process'</span>).spawn;</span><br><span class="line">    <span class="keyword">var</span> child = spawn(cmd, args);</span><br><span class="line">    <span class="keyword">var</span> resp = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    child.stdout.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">buffer</span>) </span>&#123; resp += buffer.toString(); &#125;);</span><br><span class="line">    child.stdout.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; callback(resp) &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// debug用</span></span><br><span class="line"><span class="comment">// run_cmd('sh', ['./deploy-dev.sh'], function(text)&#123; console.log(text) &#125;);</span></span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    handler(req, res, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">        res.statusCode = <span class="number">404</span></span><br><span class="line">        res.end(<span class="string">'no such location'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;).listen(<span class="number">7777</span>,() =&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'WebHooks Listern at 7777'</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">handler.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">'Error:'</span>, err.message)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">handler.on(<span class="string">'*'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Received *'</span>, event.payload.action);</span><br><span class="line">    <span class="comment">//   run_cmd('sh', ['./deploy-dev.sh'], function(text)&#123; console.log(text) &#125;);</span></span><br><span class="line">&#125;)</span><br><span class="line"> </span><br><span class="line">handler.on(<span class="string">'push'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Received a push event for %s to %s'</span>,</span><br><span class="line">        event.payload.repository.name,</span><br><span class="line">        event.payload.ref);</span><br><span class="line">        <span class="comment">// 分支判断</span></span><br><span class="line">        <span class="keyword">if</span>(event.payload.ref === <span class="string">'refs/heads/master'</span>)&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'deploy master..'</span>)</span><br><span class="line">            run_cmd(<span class="string">'sh'</span>, [<span class="string">'./deploy-dev.sh'</span>], <span class="function"><span class="keyword">function</span>(<span class="params">text</span>)</span>&#123; <span class="built_in">console</span>.log(text) &#125;);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">handler.on(<span class="string">'issues'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Received an issue event for % action=%s: #%d %s'</span>,</span><br><span class="line">        event.payload.repository.name,</span><br><span class="line">        event.payload.action,</span><br><span class="line">        event.payload.issue.number,</span><br><span class="line">        event.payload.issue.title)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/02/25/Docker/" data-id="ckh5kzavt0005tgv2rzchl93k" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-数据持久化之Mysql" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/22/数据持久化之Mysql/" class="article-date">
  <time datetime="2020-01-22T06:36:07.000Z" itemprop="datePublished">2020-01-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/22/数据持久化之Mysql/">数据持久化之Mysql</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Node-js中实现数据持久化的多种方法"><a href="#Node-js中实现数据持久化的多种方法" class="headerlink" title="Node.js中实现数据持久化的多种方法"></a>Node.js中实现数据持久化的多种方法</h1><ul>
<li>文件系统fs</li>
<li>数据库</li>
</ul>
<ol>
<li>关系型数据库–mysql</li>
<li>文档型数据库–mongodb</li>
<li>键值对数据库–redis</li>
</ol>
<h2 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h2><p>原理: 将数据保存在json文件中,通过读取文件,修改文件的方式,完成数据持久化.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现一个文件系统读写数据库</span></span><br><span class="line"><span class="comment">// readline 模块属于node核心模块,可以读取命令行的字符串</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>)</span><br><span class="line"><span class="keyword">const</span> readline = <span class="built_in">require</span>(<span class="string">"readline"</span>)</span><br><span class="line"><span class="keyword">const</span> rl = readline.createInterface(&#123;</span><br><span class="line">    input: process.stdin,</span><br><span class="line">    output: process.stdout</span><br><span class="line">&#125;)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">    fs.readFile(<span class="string">"./db.json"</span>, (err, data) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> json =<span class="built_in">JSON</span>.parse(data)</span><br><span class="line">        <span class="built_in">console</span>.log(json[key])</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">key, value</span>) </span>&#123;</span><br><span class="line">    fs.readFile(<span class="string">'./db.json'</span>, (err, data) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 空文件,设置为空对象</span></span><br><span class="line">        <span class="keyword">const</span> json = data ? <span class="built_in">JSON</span>.parse(data) : &#123;&#125;</span><br><span class="line">        json[key] = value</span><br><span class="line">        <span class="comment">// 重新写入文件</span></span><br><span class="line">        fs.writeFile(<span class="string">"./db.json"</span>, <span class="built_in">JSON</span>.stringify(json), err =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(err)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"写入成功!"</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">rl.on(<span class="string">"line"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> [op, key, value] = input.split(<span class="string">" "</span>)</span><br><span class="line">    <span class="keyword">if</span> (op == <span class="string">"get"</span>) &#123;</span><br><span class="line">        <span class="keyword">get</span>(key)</span><br><span class="line">    &#125; else if (op == "<span class="keyword">set</span>") &#123;</span><br><span class="line">        <span class="keyword">set</span>(key,value)</span><br><span class="line">    &#125; else if (op == 'quit') &#123;</span><br><span class="line">        rl.close()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"没有该操作"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">rl.on(<span class="string">"close"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"程序结束"</span>)</span><br><span class="line">    process.exit(<span class="number">0</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h2><h3 id="nodeJS操作mysql"><a href="#nodeJS操作mysql" class="headerlink" title="nodeJS操作mysql"></a>nodeJS操作mysql</h3><h4 id="安装mysql模块"><a href="#安装mysql模块" class="headerlink" title="安装mysql模块"></a>安装mysql模块</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i mysql --save</span><br></pre></td></tr></table></figure>

<h4 id="mysql模块基本使用"><a href="#mysql模块基本使用" class="headerlink" title="mysql模块基本使用"></a>mysql模块基本使用</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">'mysql'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    host: <span class="string">"localhost"</span>,</span><br><span class="line">    user: <span class="string">"zhyq"</span>,</span><br><span class="line">    password: <span class="string">"123456"</span>,</span><br><span class="line">    database: <span class="string">"test"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> connect = mysql.createConnection(config)</span><br><span class="line"></span><br><span class="line">connect.connect(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">throw</span> err</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"连接成功!"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> CREATE_SQL = <span class="string">`CREATE TABLE IF NOT EXISTS test (</span></span><br><span class="line"><span class="string">    id INT NOT NULL AUTO_INCREMENT,</span></span><br><span class="line"><span class="string">    message VARCHAR(45) NULL,</span></span><br><span class="line"><span class="string">    PRIMARY KEY (id))`</span>;</span><br><span class="line"><span class="keyword">const</span> INSERT_SQL = <span class="string">`INSERT INTO test(message) VALUES(?)`</span>;</span><br><span class="line"><span class="keyword">const</span> SELECT_SQL = <span class="string">`SELECT * FROM test`</span>;</span><br><span class="line">connect.query(CREATE_SQL, err =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">throw</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 插入数据</span></span><br><span class="line">    connect.query(INSERT_SQL, <span class="string">"hello,world"</span>, (err, result) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="keyword">throw</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(result);</span><br><span class="line">        connect.query(SELECT_SQL, (err, results) =&gt; &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(results));</span><br><span class="line">            connect.end(); <span class="comment">// 若query语句有嵌套，则end需在此执行</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>ES6写法:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">'mysql2/promise'</span>)</span><br><span class="line">    <span class="comment">// 连接配置</span></span><br><span class="line">    <span class="keyword">const</span> cfg = &#123;</span><br><span class="line">        host: <span class="string">"localhost"</span>,</span><br><span class="line">        user: <span class="string">"zhyq"</span>,</span><br><span class="line">        password: <span class="string">"123456"</span>, <span class="comment">// 修改为你的密码</span></span><br><span class="line">        database: <span class="string">"test"</span> <span class="comment">// 请确保数据库存在</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> connection = <span class="keyword">await</span> mysql.createConnection(cfg)</span><br><span class="line">    <span class="keyword">let</span> ret = <span class="keyword">await</span> connection.execute(<span class="string">`</span></span><br><span class="line"><span class="string">        CREATE TABLE IF NOT EXISTS test (</span></span><br><span class="line"><span class="string">            id INT NOT NULL AUTO_INCREMENT,</span></span><br><span class="line"><span class="string">            message VARCHAR(45) NULL,</span></span><br><span class="line"><span class="string">        PRIMARY KEY (id))</span></span><br><span class="line"><span class="string">    `</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'create'</span>, ret)</span><br><span class="line">    ret = <span class="keyword">await</span> connection.execute(<span class="string">`</span></span><br><span class="line"><span class="string">            INSERT INTO test(message)</span></span><br><span class="line"><span class="string">            VALUES(?)</span></span><br><span class="line"><span class="string">    `</span>, [<span class="string">'ABC'</span>])</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'insert:'</span>, ret)</span><br><span class="line">    ret = <span class="keyword">await</span> connection.execute(<span class="string">`</span></span><br><span class="line"><span class="string">            SELECT * FROM test</span></span><br><span class="line"><span class="string">    `</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(ret[<span class="number">0</span>]))</span><br><span class="line">    <span class="comment">// console.log(ret[1])</span></span><br><span class="line">    connection.end()</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h3 id="Mysql详细教程"><a href="#Mysql详细教程" class="headerlink" title="Mysql详细教程"></a>Mysql详细教程</h3><p><a href="https://www.runoob.com/mysql/mysql-tutorial.html" target="_blank" rel="noopener">https://www.runoob.com/mysql/mysql-tutorial.html</a></p>
<h3 id="Mysql命令行操作"><a href="#Mysql命令行操作" class="headerlink" title="Mysql命令行操作"></a>Mysql命令行操作</h3><h4 id="启动数据库服务（windows）"><a href="#启动数据库服务（windows）" class="headerlink" title="启动数据库服务（windows）"></a>启动数据库服务（windows）</h4><ol>
<li><p>先进入mysql安装目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> C:\mysql-8.0.11\bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld --initialize --console</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行完成后会输出root用户的初始默认密码<br>APWCY5ws&amp;hjQ 就是初始密码，后续登录时需要用到，也可以在登录后修改密码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2018-04-20T02:35:05.464644Z 5 [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: APWCY5ws&amp;hjQ</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld install</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动mysql 服务命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net start mysql</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="登录Mysql"><a href="#登录Mysql" class="headerlink" title="登录Mysql"></a>登录Mysql</h4><p>当 MySQL 服务已经运行时，可以通过 MySQL 自带的客户端工具登录到 MySQL 数据库中, 首先打开命令提示符, 输入以下命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -h localhost -u root -p</span><br></pre></td></tr></table></figure>

<p>-h: 主机名<br>-u：用户名<br>-p：告诉服务器将会使用一个密码来登录, 如果所要登录的用户名密码为空, 可以忽略此选项。</p>
<p>登录本机的Mysql数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure>

<p>若密码存在, 输入密码登录, 不存在则直接按回车登录。登录成功后你将会看到 Welcome to the MySQL monitor… 的提示语。</p>
<p>然后命令提示符会一直以 mysq&gt; 加一个闪烁的光标等待命令的输入, 输入 exit 或 quit 退出登录。</p>
<h4 id="管理Mysql的命令"><a href="#管理Mysql的命令" class="headerlink" title="管理Mysql的命令"></a>管理Mysql的命令</h4><ol>
<li><p>列出 MySQL 数据库管理系统的数据库列表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示全部：</span></span><br><span class="line">show databases;</span><br><span class="line"><span class="comment"># 显示部分：</span></span><br><span class="line">show databases like ‘匹配模式’;</span><br><span class="line"><span class="comment"># _:匹配当前位置单个字符</span></span><br><span class="line"><span class="comment"># %:匹配指定位置多个字符</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>显示数据库创建语句</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show create database 数据库名字;</span><br></pre></td></tr></table></figure>
</li>
<li><p>选择要操作的Mysql数据库，使用该命令后所有Mysql命令都只针对该数据库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use databaseName;</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示指定数据库的数据表，使用该命令前需要使用 use 命令来选择要操作的数据库。<br>类似于数据库，每创建一个表会在对应的数据库下创建一些文件（与存储引擎有关）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示所有的表</span></span><br><span class="line">show tables;</span><br><span class="line"><span class="comment"># 匹配显示表</span></span><br><span class="line">show tables like ‘匹配模式’</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示数据表的属性，属性类型，主键信息 ，是否为 NULL，默认值等其他信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show columns from dataTableName;(表名)</span><br><span class="line"><span class="comment"># 效果等同于以下命令</span></span><br><span class="line">desc tableName;</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示数据表的详细索引信息，包括PRIMARY KEY（主键）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show index from dataTableName;(表名)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="操作Mysql-库和表的命令"><a href="#操作Mysql-库和表的命令" class="headerlink" title="操作Mysql 库和表的命令"></a>操作Mysql 库和表的命令</h4><ol>
<li>创建数据库<br>create database  数据库名字[库选项]<br>库选项：数据库的相关属性<br>字符集：charset  代表着当前数据库下的所有表存储的数据默认指定的字符集(如果不指定，那么采用DBMS默认的)<br>校对集：collate </li>
</ol>
<p>通过SQL指令创建的数据库-&gt;data-&gt;opt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database 数据库名;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>删除数据库<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop database 数据库名;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>删除之后对应的文件夹也会删除（opt也被删除）</p>
<ol start="3">
<li>修改数据库<br>修改的数据库字符集（库选项）：字符集和校对集<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter database 数据库名字 charset=字符集</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>修改成功后对应的opt会体现<br>4. 创建数据表<br>create table 表名(字段名 字段类型 [字段属性],…)[表选项]<br>    表必须放到对应的数据库下：有两种方式<br>        1  用‘.’连接：数据库.数据表<br>        2  在创建表之前先进入到具体的数据库：use 数据库名字<br>    表选项（表属性）：与数据库类似<br>    Engine：存储引擎（存储数据的方式，默认是innodb）<br>    Charset：字符集 只对当前自己表有效<br>    Collate：校对集</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create table table_name (column_name column_type);</span><br></pre></td></tr></table></figure>

<p>例子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE IF NOT EXISTS `book`(</span><br><span class="line">   `id` INT UNSIGNED AUTO_INCREMENT,</span><br><span class="line">   `title` VARCHAR(100) NOT NULL,</span><br><span class="line">   `author` VARCHAR(40) NOT NULL,</span><br><span class="line">   `date` DATE,</span><br><span class="line">   PRIMARY KEY ( `id` )</span><br><span class="line">)ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>复制已有表结构<br>从已有的表中复制一份（只复制结构，不复制数据）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create table 新表名 like 表名</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>只要使用数据库.表名，就可以在任何数据库下访问其他数据库的表</p>
<ol start="6">
<li>常用的表操作</li>
</ol>
<ul>
<li><p>显示表结构<br>本质：显示表中所包含的字段信息（名字，类型，属性等）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    Describe 表名</span><br><span class="line">	Desc 表名</span><br><span class="line">	show columns from 表名</span><br><span class="line">```	</span><br><span class="line">* 显示表创建语句</span><br><span class="line">```bash</span><br><span class="line">	show create table 表名</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改表结构</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改表名：</span></span><br><span class="line">rename table 旧表名 to 新表名</span><br><span class="line"><span class="comment"># 设置表属性</span></span><br><span class="line"><span class="comment"># 若数据库已确定,不要轻易修改表选项(字符集影响不大)</span></span><br><span class="line">alert table 表名 表选项 [=] 值</span><br><span class="line"><span class="comment"># 新增字段</span></span><br><span class="line"><span class="comment"># 字段位置：字段想要存放的位置</span></span><br><span class="line"><span class="comment"># first：在xx之前（最前面），第一个字段</span></span><br><span class="line"><span class="comment"># after字段名：放在某个具体的字段之后（默认的）</span></span><br><span class="line">alter table 表名 add[column]新字段名 列类型 [列属性] [位置first/after字段名]</span><br><span class="line"><span class="comment"># 修改字段名：</span></span><br><span class="line">alter table 表名 change 旧字段名 新字段名 字段类型[列属性][新位置]</span><br><span class="line"><span class="comment"># 修改字段类型（属性）</span></span><br><span class="line">alter table 表名 modify 字段名 [新属性][新位置]</span><br><span class="line"><span class="comment"># 删除字段</span></span><br><span class="line">alter table 表名 drop 字段名</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="6">
<li>删除数据表<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">drop table tableName;</span><br><span class="line"><span class="comment"># 可同时删除多个表</span></span><br><span class="line">drop table 表名[表名2...]</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="操作数据的命令"><a href="#操作数据的命令" class="headerlink" title="操作数据的命令"></a>操作数据的命令</h4><p>本质是sql语句</p>
<ol>
<li>插入数据<br>数据是字符型，必须使用单引号或者双引号，如：”value”。<br>向表中指定字段插入数据<br>insert into 表名[(字段列表)] values (对应字段列表)</li>
</ol>
<p>向表中所有字段插入数据<br>inset into 表名 values(对应表结构)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO table_name ( field1, field2,...fieldN )</span><br><span class="line">                VALUES ( value1, value2,...valueN );</span><br></pre></td></tr></table></figure>

<p>例子<br>NOW() 是一个 MySQL 函数，该函数返回日期和时间.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO book (runoob_title, runoob_author, submission_date)</span><br><span class="line">            VALUES (<span class="string">"mysql"</span>, <span class="string">"richard"</span>, NOW());</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查询数据<br>查询表中全部数据:<br>select * from 表名  * 表示匹配所有字段<br>查询表中部分字段: (mysql中没有==符号）<br>select 字段列表/* from 表名 where 字段名 = 值<br>例子:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT column_name,column_name</span><br><span class="line">FROM table_name</span><br><span class="line">[WHERE Clause]</span><br><span class="line">[LIMIT N][ OFFSET M];</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>查询语句中使用一个或者多个表，表之间使用逗号(,)分割，并使用WHERE语句来设定查询条件。<br>SELECT 命令可以读取一条或者多条记录。<br>使用星号（*）来代替其他字段，SELECT语句会返回表的所有字段数据<br>使用 WHERE 语句来包含任何条件。<br>使用 LIMIT 属性来设定返回的记录数。<br>通过OFFSET指定SELECT语句开始查询的数据偏移量。默认情况下偏移量为0。</p>
<p>例子<br>返回数据表 books 的所有记录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from books;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>更新数据<br>将数据进行修改(通常是修改部分字段数据)<br>updata 表名 set 字段名=新值[where条件]<br>如果没有where条件，那么所有的表中对应的那个字段都会被修改成统一值<br>例子:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPDATE table_name SET field1=new-value1, field2=new-value2</span><br><span class="line">[WHERE Clause];</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>同时更新一个或多个字段, WHERE 子句中指定任何条件。</p>
<p>例子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE books SET title=<span class="string">'学习 C++'</span> WHERE id=3;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>删除数据<br>delete from 表名 [where条件]<br>如果没有where条件，意味着系统会自动删除该表所有数据<br>例子:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM table_name [WHERE Clause];</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>例子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM books WHERE id=3;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>主键(primary key)</li>
</ol>
<ul>
<li><p>创建主键<br>随表主键:<br>1：在需要当做主键的字段后面增加primary key<br>2：在所有字段之后增加primary key选项<br>表后增加:<br>alter table 表名 add primary key(字段)</p>
</li>
<li><p>查看主键<br>1：查看表结构<br>2：查看表的创建语句</p>
</li>
<li><p>删除主键<br>alter table 表名 drop primary key</p>
</li>
<li><p>复合主键<br>主键约束:<br>主键一旦确定，那么对对应的字段有数据要求<br>1：当前字段对应的数据不能为空<br>2：当前字段对应的数据不能有任何重复</p>
</li>
<li><p>主键分类<br>采用的是主键所对应的字段的业务意义分类<br>业务主键：主键所在的字段具有业务意义<br>逻辑主键：自然增长的整型</p>
</li>
<li><p>自动增长(auto_increment)<br>使用自动增长:<br>在字段之后增加一个属性 auto_increment<br>插入数据：触发自动增长，不能给定具体值</p>
</li>
</ul>
<h4 id="高级数据操作"><a href="#高级数据操作" class="headerlink" title="高级数据操作"></a>高级数据操作</h4><ol>
<li>新增数据</li>
</ol>
<ul>
<li>多数据插入<br>  insert into表名 [(字段列表)] vlues(值列表),(值列表)…</li>
<li>主键冲突解决方案<br>1：主键冲突更新<br>insert into 表名[(字段列表)]values(值列表)on duplicate key update 字段=新值<br>2：主键冲突替换<br>干掉原来的数据，重新插入进去<br>replace into[(字段列表)]values(值列表)</li>
<li>蠕虫复制<br>insert into 表名 [(字段列表)]select*/字段列表 from 表</li>
</ul>
<ol start="2">
<li>更新数据<br>1：通常一定是跟随条件更新<br>update 表名 set 字段名=新值 where 判断条件<br>2：如果没有条件，是全表更新数据，但可以用limit来限制更新数量<br>update 表名 set字段名=新值[where 判断条件]limit 数量</li>
<li>删除数据<br>1：尽量不要全部删除，应该使用where进行判定<br>2：可以使用limit来限制要删除的具体数量</li>
</ol>
<p>delete删除数据的时候无法重置auto_increment<br>重置自增长的语法：<br>truncate 表名;  ==》drop===》create<br>4. 查询数据<br>select select选项 字段列表 from数据源 where条件 group by 分组 having 条件 order by 排序 limit限制</p>
<ul>
<li>select选项：系统该如何对待查询得到的结果<br>all：默认的 表示保存所有的记录<br>distinct：去重 只留一条</li>
<li>字段列表：需要将同名的改为不同的<br>语法：字段名[as]别名</li>
<li>from数据源<br>单表数据: from 表名<br>多表数据: from 表1,表2…….<br>动态数据: from (select 字段列表 from表)as 别名</li>
<li>where子句</li>
<li>group by子句<br>分组统计: group by 字段名<br>多分组:   group by字段1,字段2;<br>分组排序 (默认是升序):     group by[asc|desc],字段[dsc|desc]<br>回溯统计: group by 字段[asc|desc]with rollup;</li>
<li>having子句  (本质和where一样)<br>强调：having在group by之后  group by 在where之后</li>
<li>order by子句<br>order by 字段[asc|desc] //asc升序  默认的<br>order by 字段1 规则, 字段2 规则</li>
<li>limit子句  (限制获取的数量，从第一条到指定的数量)<br>limit 数量</li>
<li>分页<br>limit offset,length; //offset 偏移量：从哪开始 ,length具体获取多少条记录<h3 id="ORM-Object-Relation-Mapping-Sequlize"><a href="#ORM-Object-Relation-Mapping-Sequlize" class="headerlink" title="ORM(Object Relation Mapping) - Sequlize"></a>ORM(Object Relation Mapping) - Sequlize</h3></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/22/数据持久化之Mysql/" data-id="ckh5kzax8001ltgv2g91b8l8u" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-网络编程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/06/网络编程/" class="article-date">
  <time datetime="2020-01-06T06:25:47.000Z" itemprop="datePublished">2020-01-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/06/网络编程/">网络编程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="OSI模型-网络七层模型"><a href="#OSI模型-网络七层模型" class="headerlink" title="OSI模型(网络七层模型)"></a>OSI模型(网络七层模型)</h1><p>OSI(Open System Interconnection)模型,意为开放式系统互联.简单来说就是为了使计算机之间的通信标准化,然后划分出了网络七层模型,为了更好的理解网络通信如何工作.</p>
<p>基本划分:<br>七层划分: 物理层,数据链路层,网络层,传输层,会话层,表示层,应用层<br>五层划分: 物理层,数据链路层,网络层,传输层,应用层<br>四层划分: 网络接口层,网路层,传输层,应用层</p>
<p>在四层划分中,应用层包括了 应用层,表示层,会话层; 网络接口层包括了物理层,数据链路层</p>
<h2 id="物理层"><a href="#物理层" class="headerlink" title="物理层"></a>物理层</h2><p>物理层主要是指硬件,包括网线,光纤,网卡,路由器,网络通信设备等硬件设备用来将计算机连接起来的物理手段.它规定了网络的一些电气特性,作用是负责传送0和1的电信号.</p>
<h2 id="数据链路层-以太网协议"><a href="#数据链路层-以太网协议" class="headerlink" title="数据链路层 (以太网协议)"></a>数据链路层 (以太网协议)</h2><p>电信号中单纯的0和1是没有意义的,必须规定解读方式:多少个电信号为一组?每个电信号的有何意义?这就是数据链路层的功能,它在实体层的上方,确定了0和1 的分组方式.</p>
<p>数据链路层对电信号做分组,形成了以太网协议Ethernet.<br>数据链路层的工作方式–广播.</p>
<p>仅通过广播的方式,在数据链路层就可以完成同一局域网内通信,MAC地址之间通过广播的方式.但在不同的局域网之间实现跨网络通信,就需要在网络层了.</p>
<h2 id="网络层-IP协议"><a href="#网络层-IP协议" class="headerlink" title="网络层 (IP协议)"></a>网络层 (IP协议)</h2><p>网络层定义了IP协议.通过IP地址,可以知道你所在的局域网,通过MAC地址可以知道你在局域网内的地址.</p>
<p>在计算机通信时,会判断你所在的局域网,对方所在的局域网,如果在同一个局域网内,基于MAC地址广播发包就可以.</p>
<p>如果不在同一个局域网,即跨网络发包,就会先把你的包交给网关来转发.IP地址和MAC地址唯一标识了你在互联网中的位置.</p>
<p>数据链路层中会把网络层的数据包封装到数据链路层的数据位置，然后再添加上自己的包头，再发给物理层，物理层发给网关，网关再发给对方局域网的网关，对方局域网的网关收到后在那个局域网内做广播。</p>
<h2 id="传输层-TCP协议和UDP协议"><a href="#传输层-TCP协议和UDP协议" class="headerlink" title="传输层 (TCP协议和UDP协议)"></a>传输层 (TCP协议和UDP协议)</h2><p>有了MAC地址和IP地址,我们还需要port端口号,表示这个数据包到底供哪个程序(进程)使用.</p>
<p>网络层的ip地址帮我们区分局域网,数据链路层的mac地址帮我们找到主机,传输层通过port端口标识主机上的应用程序.(端口即应用程序与网卡关联的编号).</p>
<p>传输层功能: 建立端口到端口的通信</p>
<p>端口范围: 0-65535,0-1023为系统占用端口.</p>
<p>传输层的两个重要协议:TCP协议和UDP协议</p>
<ul>
<li><p>TCP协议<br>面向连接的,占用资源多,速度相对较慢,提供可靠的数据传输服务</p>
</li>
<li><p>UDP协议<br>无连接,占用资源较小,速度非常快不可靠的数据传输,这在一些对数据可靠性较低的场景中是非常有用的，比如音视频服务，物联网数据上报服务等.</p>
<h2 id="会话层"><a href="#会话层" class="headerlink" title="会话层"></a>会话层</h2><p>负责建立和断开通信连接,以及数据的分割等数据传输相关的管理.(何时建立连接?何时断开连接?以及保持多久的连接)</p>
<h2 id="表示层"><a href="#表示层" class="headerlink" title="表示层"></a>表示层</h2><p>设备固有的数据格式与网络标准数据格式之间的转换(接受不同的信息,如文字流,图像,声音)</p>
<h2 id="应用层-HTTP-SSH-FTP"><a href="#应用层-HTTP-SSH-FTP" class="headerlink" title="应用层 (HTTP,SSH,FTP)"></a>应用层 (HTTP,SSH,FTP)</h2><p>针对特定应用的协议,电子邮件协议E-mail,远程登陆协议SSH,文件传输协议FTP,网络请求协议HTTP.</p>
</li>
</ul>
<h1 id="TCP协议-实现即时通讯IM"><a href="#TCP协议-实现即时通讯IM" class="headerlink" title="TCP协议-实现即时通讯IM"></a>TCP协议-实现即时通讯IM</h1><h2 id="Socket实现"><a href="#Socket实现" class="headerlink" title="Socket实现"></a>Socket实现</h2><p>原理: Net模块提供一个异步API能够创建基于流的TCP服务器,客户端与服务器建立连接后,服务器可以获得一个全双工Socket对象,服务器可以保存Socket对象列表,在接受某客户端消息时,推送给其他客户端.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>)</span><br><span class="line"><span class="keyword">const</span> chatServer = net.createServer()</span><br><span class="line"><span class="keyword">const</span> clientList = []</span><br><span class="line">chatServer.on(<span class="string">'connection'</span>, client =&gt; &#123;</span><br><span class="line">    client.write(<span class="string">'Hi\n'</span>)</span><br><span class="line">    clientList.push(client)</span><br><span class="line">    client.on(<span class="string">'data'</span>, data =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'receive: '</span>, data.toString())</span><br><span class="line">        clientList.forEach(<span class="function"><span class="params">v</span> =&gt;</span> &#123;</span><br><span class="line">            v.write(data)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">chatServer.listen(<span class="number">9000</span>)</span><br></pre></td></tr></table></figure>

<p>通过telnet连接服务器,命令行输出如下命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet localhost 9000</span><br></pre></td></tr></table></figure>

<h2 id="Http实现"><a href="#Http实现" class="headerlink" title="Http实现"></a>Http实现</h2><p>原理:客户端通过ajax方式发送数据给http服务器,服务器缓存消息,其他客户端通过轮询的方式查询最新的数据并更新列表.</p>
<ul>
<li><p>创建index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.jsdelivr.net/npm/vue/dist/vue.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/axios/dist/axios.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">v-model</span>=<span class="string">"message"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"send"</span>&gt;</span>发送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"clear"</span>&gt;</span>清空<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-for</span>=<span class="string">"item in list"</span>&gt;</span>&#123;&#123; item &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> host = <span class="string">'http://localhost:3000'</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">            el: <span class="string">'#app'</span>,</span></span><br><span class="line">            data: &#123;</span><br><span class="line">                list: [],</span><br><span class="line"><span class="javascript">                message: <span class="string">'hello world'</span></span></span><br><span class="line">            &#125;,</span><br><span class="line">            methods: &#123;</span><br><span class="line"><span class="javascript">                send: <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">let</span> res = <span class="keyword">await</span> axios.post(host + <span class="string">'/send'</span>, &#123;<span class="attr">message</span>: <span class="keyword">this</span>.message&#125;)</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">this</span>.list = res.data</span></span><br><span class="line">                &#125;,</span><br><span class="line"><span class="javascript">                clear: <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">let</span> res = <span class="keyword">await</span> axios.post(host + <span class="string">'/clear'</span>)</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">this</span>.list = res.data</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            mounted() &#123;</span><br><span class="line"><span class="javascript">                setInterval(<span class="keyword">async</span> () =&gt; &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">const</span> res = <span class="keyword">await</span> axios.get(host + <span class="string">'/list'</span>)</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">this</span>.list = res.data</span></span><br><span class="line">                &#125;, 1000)</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line">app.use(bodyParser.json())</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> list = [<span class="string">'ccc'</span>, <span class="string">'ddd'</span>]</span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    res.sendFile(path.resolve(<span class="string">'./index.html'</span>))</span><br><span class="line">&#125;)</span><br><span class="line">app.get(<span class="string">'/list'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    res.end(<span class="built_in">JSON</span>.stringify(list))</span><br><span class="line">&#125;)</span><br><span class="line">app.post(<span class="string">'/send'</span>,(req, res) =&gt; &#123;</span><br><span class="line">    list.push(req.body.message)</span><br><span class="line">    res.end(<span class="built_in">JSON</span>.stringify(list))</span><br><span class="line">&#125;)</span><br><span class="line">app.post(<span class="string">'/clear'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    list.length = <span class="number">0</span></span><br><span class="line">    res.end(<span class="built_in">JSON</span>.stringify(list))</span><br><span class="line">&#125;)</span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="socket-io-实现"><a href="#socket-io-实现" class="headerlink" title="socket.io 实现"></a>socket.io 实现</h2><ul>
<li>安装socket.io<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install socket.io -S</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>socket.io模块: <a href="https://github.com/socketio/socket.io" target="_blank" rel="noopener">https://github.com/socketio/socket.io</a><br>客户端socket.io-client: <a href="https://github.com/socketio/socket.io-client" target="_blank" rel="noopener">https://github.com/socketio/socket.io-client</a></p>
<ul>
<li><p>服务端 index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">'express'</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>).Server(app);</span><br><span class="line"><span class="keyword">var</span> io = <span class="built_in">require</span>(<span class="string">'socket.io'</span>)(http);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">  res.sendFile(__dirname + <span class="string">'/index.html'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">io.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">socket</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'a user connected'</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//响应某用户发送消息</span></span><br><span class="line">  socket.on(<span class="string">'chat message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>)</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'chat message:'</span> + msg);</span><br><span class="line">      </span><br><span class="line">    <span class="comment">// 广播给所有人</span></span><br><span class="line">    io.emit(<span class="string">'chat message'</span>, msg);</span><br><span class="line">    <span class="comment">// 广播给除了发送者外所有人</span></span><br><span class="line">    <span class="comment">// socket.broadcast.emit('chat message', msg)</span></span><br><span class="line">  &#125;);  </span><br><span class="line"></span><br><span class="line">  socket.on(<span class="string">'disconnect'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'user disconnected'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">http.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'listening on *:3000'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端 index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Socket.io chat<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://libs.baidu.com/jquery/2.1.1/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        * &#123;</span><br><span class="line">          margin: 0;</span><br><span class="line">          padding: 0;</span><br><span class="line">          box-sizing: border-box;</span><br><span class="line">        &#125;</span><br><span class="line">        body &#123;</span><br><span class="line">          font: 13px Helvetica, Arial;</span><br><span class="line">        &#125;</span><br><span class="line">        form &#123;</span><br><span class="line"><span class="css">          <span class="selector-tag">background</span>: <span class="selector-id">#000</span>;</span></span><br><span class="line">          padding: 3px;</span><br><span class="line">          position: fixed;</span><br><span class="line">          bottom: 0;</span><br><span class="line">          width: 100%;</span><br><span class="line">        &#125;</span><br><span class="line">        form input &#123;</span><br><span class="line">          border: 0;</span><br><span class="line">          padding: 10px;</span><br><span class="line">          width: 90%;</span><br><span class="line"><span class="css">          <span class="selector-tag">margin-right</span>: 0<span class="selector-class">.5</span>%;</span></span><br><span class="line">        &#125;</span><br><span class="line">        form button &#123;</span><br><span class="line">          width: 9%;</span><br><span class="line">          background: rgb(130, 224, 255);</span><br><span class="line">          border: none;</span><br><span class="line">          padding: 10px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-id">#messages</span> &#123;</span></span><br><span class="line">          list-style-type: none;</span><br><span class="line">          margin: 0;</span><br><span class="line">          padding: 0;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-id">#messages</span> <span class="selector-tag">li</span> &#123;</span></span><br><span class="line">          padding: 5px 10px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-id">#messages</span> <span class="selector-tag">li</span><span class="selector-pseudo">:nth-child(odd)</span> &#123;</span></span><br><span class="line"><span class="css">          <span class="selector-tag">background</span>: <span class="selector-id">#eee</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"messages"</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"m"</span> <span class="attr">autocomplete</span>=<span class="string">"off"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span>&gt;</span>Send<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> socket = io();</span></span><br><span class="line"><span class="javascript">            $(<span class="string">"form"</span>).submit(<span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                e.preventDefault(); <span class="comment">// 禁止表单提交的默认行为</span></span></span><br><span class="line"><span class="javascript">                socket.emit(<span class="string">"chat message"</span>, $(<span class="string">"#m"</span>).val())</span></span><br><span class="line"><span class="javascript">                $(<span class="string">"#m"</span>).val(<span class="string">""</span>)</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> <span class="literal">false</span></span></span><br><span class="line">            &#125;)</span><br><span class="line"><span class="javascript">            socket.on(<span class="string">"chat message"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">msg</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                $(<span class="string">"#messages"</span>).append($(<span class="string">"&lt;li&gt;"</span>).text(msg))</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="跨域-浏览器同源策略引起的接口调用问题"><a href="#跨域-浏览器同源策略引起的接口调用问题" class="headerlink" title="跨域:浏览器同源策略引起的接口调用问题"></a>跨域:浏览器同源策略引起的接口调用问题</h1><p>跨域产生的原因:</p>
<ol>
<li>浏览器同源策略</li>
<li>页面发送ajax请求</li>
</ol>
<h2 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h2><p>浏览器规定两个资源之间进行交互,这两个资源必须处于相同的协议(http,https),相同的主机(host),相同的端口(port),这就称两个资源同源.</p>
<h2 id="跨源网络访问"><a href="#跨源网络访问" class="headerlink" title="跨源网络访问"></a>跨源网络访问</h2><p>当一个页面使用了ajax请求另一不同源的网站数据,浏览器就会提示以下错误:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XMLHttpRequest cannot load http://你请求的域名. No &apos;Access-Control-Allow-Origin&apos; header is present on the requested resource. Origin &apos;http://当前页的域名&apos; is therefore not allowed access.</span><br></pre></td></tr></table></figure>

<h2 id="解决跨域问题"><a href="#解决跨域问题" class="headerlink" title="解决跨域问题"></a>解决跨域问题</h2><h3 id="JSONP-JSON-with-Padding-前端-后端方案-绕过跨域"><a href="#JSONP-JSON-with-Padding-前端-后端方案-绕过跨域" class="headerlink" title="JSONP(JSON with Padding),前端+后端方案,绕过跨域"></a>JSONP(JSON with Padding),前端+后端方案,绕过跨域</h3><p>JSONP(JSON with Padding) 是json的一种使用方式,目的是让网页从别的域名(网站)获取数据,即跨域获取数据.</p>
<p>原理: 因为script标签的src属性不受同源策略的影响,所以通过动态的创建script标签,将想要请求数据的服务器url写入src属性,并传递一个callback参数, 然后服务端返回数据时会将这个callback参数作为函数名来包裹数据,这样客户端就可以定制自己的函数来处理返回的数据.</p>
<p>缺点: script标签只能发送get请求.(与XMLHttpRequest对象实现的Ajax请求无关)<br>实现:<br>客户端:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>JSONP 实例<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"divCustomers"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">callbackFunction</span>(<span class="params">result, methodName</span>)</span></span></span><br><span class="line">&#123;</span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> html = <span class="string">'&lt;ul&gt;'</span>;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; result.length; i++)</span></span><br><span class="line">    &#123;</span><br><span class="line"><span class="javascript">        html += <span class="string">'&lt;li&gt;'</span> + result[i] + <span class="string">'&lt;/li&gt;'</span>;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    html += <span class="string">'&lt;/ul&gt;'</span>;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">'divCustomers'</span>).innerHTML = html;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"https://www.xxxx.com/test/jsonp.php?jsoncallback=callbackFunction"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>服务器端:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'Content-type: application/json'</span>);</span><br><span class="line"><span class="comment">//获取回调函数名</span></span><br><span class="line">$jsoncallback = htmlspecialchars($_REQUEST [<span class="string">'jsoncallback'</span>]);</span><br><span class="line"><span class="comment">//json数据</span></span><br><span class="line">$json_data = <span class="string">'["customername1","customername2"]'</span>;</span><br><span class="line"><span class="comment">//输出jsonp格式的数据, 这个函数最后会在客户端调用,将json数据传入函数,做定制化处理</span></span><br><span class="line"><span class="keyword">echo</span> $jsoncallback . <span class="string">"("</span> . $json_data . <span class="string">")"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="代理服务器"><a href="#代理服务器" class="headerlink" title="代理服务器"></a>代理服务器</h3><p>请求同源服务器,通过该服务器转发请求至目标服务器,得到结果再转发给前端.</p>
<p>使用proxy middleware: http-proxy-middleware</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i http-proxy-middleware</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="comment">// http-proxy-middleware 用于将请求转发给其它服务器。</span></span><br><span class="line"><span class="keyword">let</span> proxy = <span class="built_in">require</span>(<span class="string">'http-proxy-middleware'</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line">app.use(express.static(__dirname + <span class="string">'/'</span>))</span><br><span class="line">app.use(<span class="string">'/api'</span>, proxy(&#123; <span class="attr">target</span>: <span class="string">'http://localhost:4000'</span>, <span class="attr">changeOrigin</span>: <span class="literal">false</span>&#125;))</span><br><span class="line"> <span class="built_in">module</span>.exports = app</span><br></pre></td></tr></table></figure>

<p>前端开发中测试服务器的代理功能就是采用的该解决方案,但是最终发布上线时如果web应用和接口服务器不在一起仍然会跨域.<br>对比nginx与webpack devserver</p>
<ul>
<li><p>webpack devServer</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vue.config.js</span></span><br><span class="line">modele.exports = &#123;</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        disableHostCheck: <span class="literal">true</span>,</span><br><span class="line">        compress: <span class="literal">true</span>,</span><br><span class="line">        port: <span class="number">5000</span>,</span><br><span class="line">        proxy: &#123;</span><br><span class="line">            <span class="string">'/api/'</span>: &#123;</span><br><span class="line">                target: <span class="string">'http://localhost:4000'</span>,</span><br><span class="line">                changeOrigin: <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>nginx</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    # server_name www.xxx.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /<span class="keyword">var</span>/www/html;</span><br><span class="line">        index index.html index.htm;</span><br><span class="line">        try_files $uri $uri/ <span class="regexp">/index.html;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    location /</span>api &#123;</span><br><span class="line">        proxy_pass http:<span class="comment">//127.0.0.1:3000;</span></span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="CORS-Cross-Origin-Resource-Share-跨域资源共享-后端方案-解决跨域"><a href="#CORS-Cross-Origin-Resource-Share-跨域资源共享-后端方案-解决跨域" class="headerlink" title="CORS(Cross Origin Resource Share) 跨域资源共享,后端方案,解决跨域"></a>CORS(Cross Origin Resource Share) 跨域资源共享,后端方案,解决跨域</h3><p>浏览器的同源策略出于安全考虑,浏览器会限制从脚本发起的跨域HTTP请求,像XMLHttpRequest和Fetch都遵循同源策略.</p>
<p>浏览器限制发起跨域请求的两种方式:</p>
<ol>
<li>浏览器限制发起跨域请求</li>
<li>跨域请求可以正常发起,但是返回的结果被浏览器拦截了</li>
</ol>
<p>一般浏览器都是第二种方式限制跨域请求,那就是说请求已到达服务器,并有可能对数据库里的数据进行了操作,但是返回的结果被浏览器拦截了,那么我们就获取不到返回结果,这是一次失败的请求,但是可能对数据库里的数据产生了影响。</p>
<p>为了防止这种情况的发生,规范要求,对这种可能对服务器数据产生副作用的HTTP请求方法,浏览器必须先使用OPTIONS方法发起一个预检请求,从而获知服务器是否允许该跨域请求.如果允许,就发送带数据的真实请求;如果不允许,则阻止发送带数据的真实请求.</p>
<p>cors是W3C规范,真正意义上解决跨域问题.它需要服务器对请求进行检查并对响应头做相应处理,从<br>而允许跨域请求.</p>
<h4 id="预检请求-preflight-request-浏览器发出的接口请求会发两次"><a href="#预检请求-preflight-request-浏览器发出的接口请求会发两次" class="headerlink" title="预检请求(preflight request): 浏览器发出的接口请求会发两次"></a>预检请求(preflight request): 浏览器发出的接口请求会发两次</h4><p>一个 CORS 预检请求是用于检查服务器是否支持 CORS 即跨域资源共享.</p>
<ol>
<li>简单请求</li>
</ol>
<ul>
<li>请求方式为:GET, POST, HEAD(HEAD请求和GET本质一样,但是HEAD请求不含数据,只有HTTP头部信息)之一.</li>
<li>HTTP请求Header信息没有自定义的头部字段,Content-Type (只有三个值application/x-www-form-urlencoded, multipart/form-data, text/plain).</li>
</ul>
<p>符合以上两个条件就可以认为是一个简单请求.<br>2. 非简单请求</p>
<ul>
<li><p>请求方式为: PUT, DELETE</p>
</li>
<li><p>自定义头部字段</p>
</li>
<li><p>发送json格式数据</p>
</li>
<li><p>正式通信之前,浏览器会先发送OPTION请求,进行预检,这一次的请求称为”预检请求”,状态响应码204 No Content</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//Request Headers 包含以下字段</span><br><span class="line">Access-Control-Request-Headers: authorization</span><br><span class="line">Access-Control-Request-Method: GET</span><br><span class="line">Origin: http://www.test.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务器成功响应预检请求之后才会发送真正的请求,并返回真实数据.</p>
</li>
</ul>
<h4 id="CORS-具体设置"><a href="#CORS-具体设置" class="headerlink" title="CORS 具体设置"></a>CORS 具体设置</h4><ul>
<li><p>响应简单请求: method为GET / POST / HEAD, 没有自定义请求头, Content-Type是application/x-www-form-urlencoded, multipart/form-data, text/plain之一,通过在服务器端添加以下响应头解决.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通配符* 代表任何</span></span><br><span class="line">res.setHeader(<span class="string">'Access-Control-Allow-Origin'</span>, <span class="string">'http://localhost:3000'</span>)</span><br><span class="line">res.setHeader(<span class="string">'Access-Control-Allow-Origin'</span>, <span class="string">'*'</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>响应非简单请求,需要响应浏览器发出的OPTIONS请求(预检请求),并根据情况设置响应头,则服务器需要允许X-Token<br>若请求为post,还传递了参数,服务器还需要允许content-type请求头</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (method == <span class="string">"OPTIONS"</span> &amp;&amp; url == <span class="string">"/api/users"</span>) &#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">        <span class="string">"Access-Control-Allow-Origin"</span>: <span class="string">"http://localhost:3000"</span>,</span><br><span class="line">        <span class="string">"Access-Control-Allow-Headers"</span>: <span class="string">"X-Token,Content-Type"</span>,</span><br><span class="line">        <span class="string">"Access-Control-Allow-Methods"</span>: <span class="string">"PUT"</span></span><br><span class="line">    &#125;)</span><br><span class="line">    res.end()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果要携带cookie信息,则请求变为credential请求</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 预检请求和/api/users接口中均需要添加</span></span><br><span class="line">res.setHeader(<span class="string">'Access-Control-Allow-Credentials'</span>, <span class="string">'true'</span>)</span><br><span class="line"><span class="comment">// 设置cookie</span></span><br><span class="line">res.setHeader(<span class="string">'Set-Cookie'</span>, <span class="string">'cookie1=va222;'</span>)</span><br><span class="line"><span class="comment">// 跨域访问需要发送cookie时一定要加axios.defaults.withCredentials = true</span></span><br><span class="line">axios.defaults.withCredentials = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Body-parser"><a href="#Body-parser" class="headerlink" title="Body-parser"></a>Body-parser</h2><p>Body-parser中间件的作用是给req添加属性body,属性值为对象,以键值对的形式存储请求体中的参数.<br>Body-parser只处理POST请求.</p>
<h3 id="Body-parser-的四个处理方法"><a href="#Body-parser-的四个处理方法" class="headerlink" title="Body-parser 的四个处理方法"></a>Body-parser 的四个处理方法</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bodyParser.json(options)        <span class="comment">// 处理json数据</span></span><br><span class="line">bodyParse.raw(options)          <span class="comment">// 处理Buffer流数据</span></span><br><span class="line">bodyParse.text(options)         <span class="comment">// 处理文本数据</span></span><br><span class="line">bodyParse.urlencoded(options)   <span class="comment">// 处理UTF-8编码的数据</span></span><br></pre></td></tr></table></figure>

<h3 id="Body-parser-的使用"><a href="#Body-parser-的使用" class="headerlink" title="Body-parser 的使用"></a>Body-parser 的使用</h3><ul>
<li><p>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install express body-parser</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">let</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line"><span class="comment">// parse application/x-www-form-urlencoded</span></span><br><span class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// parse application/json</span></span><br><span class="line">app.use(bodyParser.json())</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>)</span><br><span class="line">    res.write(<span class="string">'hello'</span>)</span><br><span class="line">    res.end(<span class="built_in">JSON</span>.stringify(req.body, <span class="literal">null</span>, <span class="number">2</span>))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>express 的use方法调用body-parser实例,在use方法中没有设置路由路径时,body-parse实例会对该app所有的请求进行拦截和解析.</p>
<ul>
<li><p>设置Content-Type 属性:用于修改和设定中间件解析的body内容类型。<br>Content-Type内容类型,用于定义网络文件的类型和网页的编码,决定浏览器将以什么形似,什么编码读取这个文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parse various different custom JSON types as JSON</span></span><br><span class="line">app.use(bodyParser.json(&#123; <span class="attr">type</span>: <span class="string">'application/*+json'</span>&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// parse some custom thing to a Buffer</span></span><br><span class="line">app.use(bodyParser.raw(&#123; <span class="attr">type</span>: <span class="string">'application/vnd.custom-type'</span>&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// parse an html body into string</span></span><br><span class="line">app.use(bodyParser.text(&#123; <span class="attr">type</span>: <span class="string">'text/html'</span> &#125;))</span><br></pre></td></tr></table></figure>
</li>
<li><p>发送请求body的类型:application/x-www-form-urlencoded </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/api/save"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"abc"</span> <span class="attr">value</span>=<span class="string">"123"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"save"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// api.js</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (method === <span class="string">"POST"</span> &amp;&amp; url === <span class="string">"/api/save"</span>) &#123;</span><br><span class="line"> <span class="keyword">let</span> reqData = [];</span><br><span class="line"> <span class="keyword">let</span> size = <span class="number">0</span>;</span><br><span class="line"> req.on(<span class="string">'data'</span>, data =&gt; &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'&gt;&gt;&gt;req on'</span>, data);</span><br><span class="line">   reqData.push(data);</span><br><span class="line">   size += data.length;</span><br><span class="line"> &#125;);</span><br><span class="line"> req.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'end'</span>)</span><br><span class="line">   <span class="keyword">const</span> data = Buffer.concat(reqData, size);</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'data:'</span>, size, data.toString())</span><br><span class="line">   res.end(<span class="string">`formdata:<span class="subst">$&#123;data.toString()&#125;</span>`</span>)</span><br><span class="line"> &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟application/x-www-form-urlencoded</span></span><br><span class="line"><span class="keyword">await</span> axios.post(<span class="string">"/api/save"</span>, <span class="string">'a=1&amp;b=3'</span>, &#123;<span class="attr">headers</span>: &#123;<span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>发送请求的body的类型: application/json<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> axios.post(<span class="string">"/api/save"</span>, &#123;<span class="attr">a</span>:<span class="number">1</span>, <span class="attr">b</span>:<span class="number">2</span>&#125;)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><h2 id="创建index-html"><a href="#创建index-html" class="headerlink" title="创建index.html"></a>创建index.html</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>file upload<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">'file1'</span> <span class="attr">type</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> files = <span class="built_in">document</span>.getElementsByTagName(<span class="string">'input'</span>)</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">'files'</span>, files)</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> length = files.length</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> file</span></span><br><span class="line"><span class="javascript">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span></span><br><span class="line">            file = files[i]</span><br><span class="line"><span class="javascript">            <span class="comment">// 判断文件类型, type不是file的input元素跳过</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> (file.type !== <span class="string">'file'</span>) <span class="keyword">continue</span></span></span><br><span class="line"><span class="javascript">            <span class="comment">// 触发input的onchange事件时,执行如下回调函数 </span></span></span><br><span class="line"><span class="javascript">            file.onchange = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// this.files 是选择文件之后的文件集合 fileList</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> _files = <span class="keyword">this</span>.files</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 没有选择文件退出</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (!_files.length) <span class="keyword">return</span></span></span><br><span class="line"><span class="javascript">                <span class="comment">// 选择单个文件</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (_files.length === <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest()</span></span><br><span class="line"><span class="javascript">                    <span class="comment">// 前端发送POST请求 到接口 http://localhost:3000/upload 下</span></span></span><br><span class="line"><span class="javascript">                    xhr.open(<span class="string">'POST'</span>, <span class="string">'http://localhost:3000/upload'</span>)</span></span><br><span class="line"><span class="javascript">                    <span class="comment">// 获取文件的路径</span></span></span><br><span class="line"><span class="javascript">                    <span class="comment">// 在触发onchange事件,已经选定文件后,files这个DOM元素集中的这个DOM元素的value就有值了</span></span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> filePath = files[<span class="number">0</span>].value</span></span><br><span class="line"><span class="javascript">                    <span class="comment">// 设置请求头 "file-nmae": "xxxx.yy"</span></span></span><br><span class="line"><span class="javascript">                    xhr.setRequestHeader(<span class="string">'file-name'</span>, filePath.substring(filePath.lastIndexOf(<span class="string">'\\'</span>) + <span class="number">1</span>))</span></span><br><span class="line"><span class="javascript">                    <span class="comment">// 发送文件</span></span></span><br><span class="line">                    xhr.send(_files[0])</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="创建index-js"><a href="#创建index-js" class="headerlink" title="创建index.js"></a>创建index.js</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="comment">// 创建http server</span></span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">request, response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; pathname &#125; = <span class="built_in">require</span>(<span class="string">'url'</span>).parse(request.url)</span><br><span class="line">    <span class="keyword">if</span> (pathname === <span class="string">'/upload'</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'upload...'</span>)</span><br><span class="line">        <span class="comment">// 获取文件名 来自request headers</span></span><br><span class="line">        <span class="keyword">const</span> fileName = request.headers[<span class="string">'file-name'</span>] ? request.headers[<span class="string">'file-name'</span>] : <span class="string">'abc.png'</span></span><br><span class="line">        <span class="comment">// 设置文件保存在服务器的某路径下</span></span><br><span class="line">        <span class="keyword">const</span> outputFile = path.resolve(__dirname, fileName)</span><br><span class="line">        <span class="comment">// 创建一个可写的文件流</span></span><br><span class="line">        <span class="keyword">const</span> writeFileStream = fs.createWriteStream(outputFile)</span><br><span class="line">        <span class="comment">// 管道拼接</span></span><br><span class="line">        request.pipe(writeFileStream)</span><br><span class="line">        response.end()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> filename = pathname === <span class="string">'/'</span> ? <span class="string">'index.html'</span> : pathname.substring(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">var</span> type = (<span class="function"><span class="keyword">function</span> (<span class="params">_type</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (_type) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'html'</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'htm'</span>: <span class="keyword">return</span> <span class="string">'text/html charset=UTF-8'</span></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'js'</span>: <span class="keyword">return</span> <span class="string">'application/javascript charset=UTF-8'</span></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'css'</span>: <span class="keyword">return</span> <span class="string">'text/css charset=UTF-8'</span></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'txt'</span>: <span class="keyword">return</span> <span class="string">'text/plain charset=UTF-8'</span></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'manifest'</span>: <span class="keyword">return</span> <span class="string">'text/cache-manifest charset=UTF-8'</span></span><br><span class="line">                <span class="keyword">default</span>: <span class="keyword">return</span> <span class="string">'application/octet-stream'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)(filename.substring(filename.lastIndexOf(<span class="string">'.'</span>) + <span class="number">1</span>))</span><br><span class="line">        <span class="comment">// 异步读取文件,并将内容作为单独的数据块传回给回调函数</span></span><br><span class="line">        <span class="comment">// 对于确实很大的文件,使用API fs.createReadStream()更好</span></span><br><span class="line">        fs.readFile(filename, <span class="function"><span class="keyword">function</span> (<span class="params">err, content</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="comment">// 报错 无法读取文件时</span></span><br><span class="line">                response.writeHead(<span class="number">404</span>, &#123; <span class="string">'Content-type'</span>: <span class="string">'text/plain charset=UTF-8'</span> &#125;)</span><br><span class="line">                response.write(err, message)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 读取文件成功, 把文件内容作为响应主体</span></span><br><span class="line">                response.writeHead(<span class="number">200</span>, &#123; <span class="string">'Content-type'</span>: type &#125;)</span><br><span class="line">                response.write(content)</span><br><span class="line">            &#125;</span><br><span class="line">            response.end()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">server.listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Buffer-connect"><a href="#Buffer-connect" class="headerlink" title="Buffer connect"></a>Buffer connect</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> size = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> chunk = []</span><br><span class="line"><span class="comment">// 监听data事件,执行回调函数</span></span><br><span class="line">request.on(<span class="string">'data'</span>, data =&gt; &#123;</span><br><span class="line">    <span class="comment">// data是数据块</span></span><br><span class="line">    chunk.push(data)</span><br><span class="line">    size += data.length</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'data:'</span>, data, size)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 监听end事件,执行回调函数</span></span><br><span class="line">request.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'end...'</span>)</span><br><span class="line">    <span class="keyword">const</span> buffer = Buffer.concat(chunk, size)</span><br><span class="line">    size = <span class="number">0</span></span><br><span class="line">    <span class="comment">// 同步写入文件</span></span><br><span class="line">    fs.writeFileSync(outputfile, buffer)</span><br><span class="line">    response.end()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="流事件写入"><a href="#流事件写入" class="headerlink" title="流事件写入"></a>流事件写入</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">request.on(<span class="string">'data'</span>, data =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'data:'</span>, data)</span><br><span class="line">    writeFileStream.write(data)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">request.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">    writeFileStream.end()</span><br><span class="line">    response.end()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="实现简单爬虫"><a href="#实现简单爬虫" class="headerlink" title="实现简单爬虫"></a>实现简单爬虫</h1><p>原理:模拟浏览器发送请求到目标服务器获取页面的内容并解析,获取其中的数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># request库 发送请求</span></span><br><span class="line">npm install request -S</span><br><span class="line"></span><br><span class="line"><span class="comment"># cheerio库 操作dom</span></span><br><span class="line">npm install cheerio -S</span><br><span class="line"></span><br><span class="line"><span class="comment"># iconv-lite库 用于字符编码转换</span></span><br><span class="line">npm install iconv-lite -S</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> originRequest = <span class="built_in">require</span>(<span class="string">"request"</span>)</span><br><span class="line"><span class="keyword">const</span> cheerio = <span class="built_in">require</span>(<span class="string">"cheerio"</span>)</span><br><span class="line"><span class="keyword">const</span> iconv = <span class="built_in">require</span>(<span class="string">"iconv-lite"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">request</span>(<span class="params">url, callback</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> options = &#123;</span><br><span class="line">        url: url,</span><br><span class="line">        encoding: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    originRequest(url, options, callback)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">100553</span>; i &lt; <span class="number">100563</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> url = <span class="string">`https://www.dy2018.com/i/<span class="subst">$&#123;i&#125;</span>.html`</span></span><br><span class="line">    request(url, <span class="function"><span class="keyword">function</span> (<span class="params">err, res, body</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> html = iconv.decode(body, <span class="string">"gb2312"</span>)</span><br><span class="line">        <span class="keyword">const</span> $ = cheerio.load(html)</span><br><span class="line">        <span class="built_in">console</span>.log($(<span class="string">".title_all h1"</span>).text())</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Https"><a href="#Https" class="headerlink" title="Https"></a>Https</h1><p>创建证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建私钥</span></span><br><span class="line">openssl genrsa -out privatekey.pem 1024</span><br><span class="line"><span class="comment"># 创建证书签名请求</span></span><br><span class="line">openssl req -new -key privatekey.pem -out certrequest.csr</span><br><span class="line"><span class="comment"># 获取证书,线上证书需要经过证书授证中心签名的文件;下面只创建一个学习使用证书</span></span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> certrequest.csr -signkey privatekey.pem -out</span><br><span class="line">certificate.pem</span><br><span class="line"><span class="comment"># 创建pfx文件</span></span><br><span class="line">openssl pkcs12 -<span class="built_in">export</span> -<span class="keyword">in</span> certificate.pem -inkey privatekey.pem -out</span><br><span class="line">certificate.pfx</span><br></pre></td></tr></table></figure>

<h1 id="Http2"><a href="#Http2" class="headerlink" title="Http2"></a>Http2</h1><p>多路复用- 雪碧图,多域名CDN,接口合并</p>
<ul>
<li>多路复用允许同时通过单一的HTTP/2连接发起多重的请求-响应消息;而HTTP/1.1协议中,浏览器客户端在同一时间,针对同一域名下的请求有一定数量限制.超过限制数目的请求会被阻塞.</li>
<li>首部压缩<br>http/1.x的header由于cookie和user agent很容易膨胀,而且每次都要重复发送.<br>http/2使用的encoder来减少需要传输的header大小,通讯双方各自cache一份 header fields表,既避免了重复header传输,又减小了需要传输的大小.高效的压缩算法可以很大的压缩header,减少发送包的数量从而降低延迟</li>
<li>服务端推送<br>在HTTP/2中,服务器可以对客户端的一个请求发送多个响应.举个例子,如果一个请<br>求请求的是index.html,服务器很可能会同时响应index.html、logo.jpg 以及 css 和 js文件.因为它知道客户端会用到这些东西.相当于在一个HTML文档内集合了所有的资源.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/06/网络编程/" data-id="ckh5kzaxa001ptgv2z67gg1td" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-http协议" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/02/http协议/" class="article-date">
  <time datetime="2020-01-02T05:32:31.000Z" itemprop="datePublished">2020-01-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/02/http协议/">http协议</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="HTTP协议"><a href="#HTTP协议" class="headerlink" title="HTTP协议"></a>HTTP协议</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>HTTP是一一个属于应用层的面向对象的协议,由于其简捷、快速的方式,适用于分布式超媒体信息系<br>统。<br>HTTP协议的主要特点:</p>
<ol>
<li>支持客户/服务器模式(C/S)</li>
<li>简单快速: 客户想服务器请求服务时, 只需传送方法和路径.请求方法常用有GET,POST等.每种方法规定了客户与服务器联系的类型不同.由于HTTP协议简单,使得HTTP服务器的程序规模小,因而通信速度很快.</li>
<li>灵活: HTTP允许传输任意类型的数据对象.正在传输的类型由Content-Type加以标记.</li>
<li>无连接: 无连接的含义是限制每次连接只处理一个请求.服务器处理完客户的请求,并收到客户的应答后,即断开连接.采用这种方式可以节省传输时间.</li>
<li>无状态: HTTP协议是无状态的协议. 无状态是指协议对于事务处理没有记忆能力.缺少状态意味着如果后续处理需要前面的信息,则必须重传,这样可能导致每次连接传送的数据量增大.另一方面,在服务器不需要先前信息时,它的应答就较快.</li>
</ol>
<h2 id="HTTP协议详解之URL"><a href="#HTTP协议详解之URL" class="headerlink" title="HTTP协议详解之URL"></a>HTTP协议详解之URL</h2><p>HTTP URL (URL是一种特殊类型的URI,包含了用于查找某个资源的足够的信息,统一资源定位符)的格式如下:</p>
<p><a href="http://host:port/abs_path" target="_blank" rel="noopener">http://host:port/abs_path</a></p>
<p>http: 表示要通过HTTP协议来定位网络资源(还有https)<br>host: 表示合法的Internet主机域名或者IP地址(127.0.0.1)<br>port: 指定一个端口号,为空则默认使用端口80<br>abs_path: 指定请求资源的URI;如果URL中没有给出abs_path,那么当它作为请求URI时,必须以”/“的形式给出,通常这个工作浏览器自动帮我们完成.<br>如: 输入 <a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a> 浏览器自动转换成 <a href="http://www.baidu.com/" target="_blank" rel="noopener">www.baidu.com/</a></p>
<h2 id="HTTP协议详解之请求篇"><a href="#HTTP协议详解之请求篇" class="headerlink" title="HTTP协议详解之请求篇"></a>HTTP协议详解之请求篇</h2><p>http请求由三部分组成,分别是: 请求行,消息报头,请求正文</p>
<ol>
<li>请求行以一个方法符号开头,以空格分开,后面跟着请求的URI和协议的版本,格式如下:<br>Method  Request-URI  HTTP-Version  CRLF<br>Method表示请求方法<br>Request-URI是一个统一资源定位符<br>HTTP-Version表示请求的HTTP协议版本<br>CRLF表示回车和换行(除了作为结尾的CRLF外,不允许出现单独的CR或LF字符)</li>
</ol>
<p>请求方法(所有的方法都是大写):<br>GET     请求获取Request-URI所标识的资源<br>POST    在Request-URI所标识的资源后附加新的资源<br>HEAD    请求获取由Request-URI所标识的资源的响应消息报头<br>PUT     请求服务器存储一个资源,并用Request-URI作为其标识<br>DELETE  请求服务器删除Request-URI所标识的资源<br>TRACE   请求服务器回送受到的请求信息,主要用于测试或者诊断<br>CONNECT 保留将来使用<br>OPTIONS 请求查询服务器的性能,或者查询与资源相关的选项和需求</p>
<p>例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: localhost:4000</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.97 Safari/537.36</span><br><span class="line">Sec-Fetch-User: ?1</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class="line">Sec-Fetch-Site: none</span><br><span class="line">Sec-Fetch-Mode: navigate</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: zh,en-US;q=0.9,en;q=0.8,zh-CN;q=0.7</span><br><span class="line">Cookie: xxxxxxxxxxxx</span><br></pre></td></tr></table></figure>

<p>HEAD方法与GET方法几乎是一样的,对于HEAD请求的回应部分来说,它的HTTP头部中包含的信息与通过GET请求所得到的信息是相同的.利用这个方法,不必传输整个资源内容,就可以得到Request-URI所标识的资源信息.该方法常用于测试超链接的有效性,是否可以访问,以及最近是否更新.</p>
<h2 id="HTTP协议详解之响应篇"><a href="#HTTP协议详解之响应篇" class="headerlink" title="HTTP协议详解之响应篇"></a>HTTP协议详解之响应篇</h2><p>在接受和解析请求消息后,服务器返回一个HTTP响应消息<br>HTTP响应也是由三个部分组成, 分别是: 状态行, 消息报头,响应正文</p>
<ol>
<li>状态行 格式如下:<br>HTTP-Version Status-Code Reason-Phrase (CRLF)</li>
</ol>
<p>HTTP-Version表示服务器HTTP协议版本<br>Status-Code表示服务器发回的状态响应码<br>Reason-Phrase 表示状态代码的文本描述</p>
<p>状态码由三位数字组成,第一个数字定义了响应的类别,且有五种可能取值:<br>1xx: 指示信息–表示请求已接收,继续处理<br>2xx: 成功– 表示请求已被成功接受<br>3xx: 重定向–要完成请求必须进行更进一步的操作<br>4xx: 客户端错误–请求有语法错误或请求了不存在的资源,请求无法实现<br>5xx: 服务器端错误–服务器未能实现合法的请求<br>常见的状态代码,状态描述,说明:<br>200 OK //客户端请求成功<br>400 Bad Request //客户端请求有语法错误,不能被服务器理解<br>401 Unauthorized // 请求未经授权,这个状态代码必须和www-Authenticate报头域一起使用<br>403 Forbidden //服务器收到请求,但是拒绝提供服务<br>404 Not Found //请求资源不存在, 输入了错误的URL<br>500 Internal Server Error // 服务器发生不可预期的错误<br>503 Server Unavailabilable // 服务器当前不能处理客户端的请求,一段时间后可能恢复正常</p>
<p>例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br></pre></td></tr></table></figure>

<h2 id="HTTP协议详解之消息报头篇"><a href="#HTTP协议详解之消息报头篇" class="headerlink" title="HTTP协议详解之消息报头篇"></a>HTTP协议详解之消息报头篇</h2><p>HTTP消息由客户端到服务器的请求和服务器到客户端的响应组成。请求消息和响应消息都是由开始行<br>(对于请求消息,开始行就是请求行,对于响应消息,开始行就是状态行),消息报头(可选),空行<br>(只有CRLF的行),消息正文(可选)组成。</p>
<p>HTTP消息报头包括普通报头、请求报头、响应报头、实体报头。<br>每一个报头域都是由 名字 + : + 空格+ 值组成, 消息报头域的名字是和大小写无关的.</p>
<ol>
<li>普通报头<br>在普通报头域中,有少数的报头域用于所有的请求和响应消息,但并不用于被传输的实体,只用于传输的消息</li>
</ol>
<p>Cache-Control 用用于指定缓存指令,缓存指令是单向的(响应中出现的缓存指令在请求中未必会出<br>现),且是独立的(一个消息的缓存指令不会影响另一个消息处理的缓存机制),HTTP1.0使用的类似<br>的报头域为Pragma.</p>
<p>请求时的缓存指令包括:no-cache(用于指示请求或响应消息不能缓存)、no-store、max-age、<br>max-stale、min-fresh、only-if-cached;<br>响应时的缓存指令包括:public、private、no-cache、no-store、no-transform、must-revalidate、<br>proxy-revalidate、max-age、s-maxage.</p>
<p>为了指示浏览器(客户端)不要缓存页面,服务器端的node.js程序可以如下编写:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response.setHeader(<span class="string">"Cache-Control"</span>, <span class="string">"no-cache"</span>)</span><br></pre></td></tr></table></figure>

<p>这句代码将在发送的响应消息中设置普通报头域:Cache-Control:no-cache</p>
<p>Date普通报头域表示消息产生的日期和时间</p>
<p>Connection普通报头域允许发送指定连接的选项。例如指定连接是”keep-alive”连续,或者指定“close”选项,通知服务器,在响应完成后,关闭连接.</p>
<ol start="2">
<li>请求报头<br>请求报头允许客户端向服务器端传递请求的附加信息以及客户端自身的信息.</li>
</ol>
<p>常用的请求报头:</p>
<ul>
<li><p>Accept<br>Accept请求报头域用于指定客户端接受哪些类型的信息.<br>Accept:image/gif,表明客户端希望接受GIF图象格式的资源<br>Accept:text/html,表明客户端希望接受html文本</p>
</li>
<li><p>Accept-Charset<br>Accept-Charset请求报头域用于指定客户端接受的字符集.<br>Accept-Charset:iso-8859-1,gb2312.如果在请求消息中没有设置这个域,默认是任何字符集都可以接受.</p>
</li>
<li><p>Accept-Encoding<br>Accept-Encoding请求报头域类似于Accept,但是它是用于指定可接受的内容编码<br>Accept-Encoding:gzip.deflate.如果请求消息中没有设置这个域服务器假定客户端对各种内容编码都可以接受.</p>
</li>
<li><p>Accept-Language<br>Accept-Language请求报头域类似于Accept,但是它是用于指定一种自然语言<br>Accept-Language:zh-cn.如果请求消息中没有设置这个报头域,服务器假定客户端对各种语言言都可以接受.</p>
</li>
<li><p>Authorization<br>请求报头域主要用于证明客户端有权查看某个资源.当浏览器访问一个页面时,如果收到服务器的响应代码为401(未授权),可以发送一个包含Authorization请求报头域的请求,要求服务器对其进行验证.</p>
</li>
</ul>
<p>Host (发送请求时,该报头域是必需的)<br>Host请求报头域主要用于指定被请求资源的Internet主机和端口号,它通常从HTTP URL中提取出来的.<br>例子: 浏览器中输入: <a href="http://www.baidu.com/" target="_blank" rel="noopener">http://www.baidu.com/</a><br>浏览器发送请求消息中,就会包含Host请求报头域: Host: <a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a><br>此处使用了缺省端口号80,若指定了端口号,则变成Host: <a href="http://www.baidu.com:port" target="_blank" rel="noopener">www.baidu.com:port</a></p>
<p>User-Agent (用户代理)<br>访问某些网页时,网页其中列出了你的操作系统的名称和版本,你所使用的浏览器的名称和版本,实际上,服务器应用程序就是从User-Agent这<br>个请求报头域中获取到这些信息。User-Agent请求报头域允许客户端将它的操作系统、浏览器和其它属<br>性告诉服务器。不过,这个报头域不是必需的,不使用User-Agent请求报头域发送http请求时,那么服务器端就无法得知我们的信息了。</p>
<ol start="3">
<li>响应报头<br>响应报头允许服务器传递不能放在状态行中的附加响应信息,以及关于服务器的信息和对Request-URI所标识的资源进行下一步访问的信息.<br>常用的响应报头<h1 id="Location"><a href="#Location" class="headerlink" title="Location"></a>Location</h1>Loacation响应报头域用于重定向接受者到一个新的位置.Location响应报头域常用在更换域名的时候.<h1 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h1>Server响应报头域包含了服务器用来处理请求的软件信息.与User-Agent请求报头域是相对应的.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Server: Apache-Coyote/1.1</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="WWW-Authenticate"><a href="#WWW-Authenticate" class="headerlink" title="WWW-Authenticate"></a>WWW-Authenticate</h1><p>WWW-Authenticate响应报头域必须被包含在401(未授权的)响应消息中,客户端收到401响应消息<br>时候,并发送Authorization报头域请求服务器对其进行验证时,服务端响应报头就包含该报头域。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WWW-Authenticate:Basic realm=&quot;Basic Auth Test!&quot; //可以看出服务器对请求资源采用的是基本验证机制</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>实体报头<br>请求和响应消息都可以传送一个实体.一个实体由实体报头域和实体正文组成,但并不是说实体报头域和实体正文要在一起发送,可以只发送实体报头域.<br>实体报头定义了关于实体正文(有无实体正文)和请求所标识的资源的元信息.</li>
</ol>
<p>常用的实体报头</p>
<h1 id="Content-Encoding"><a href="#Content-Encoding" class="headerlink" title="Content-Encoding"></a>Content-Encoding</h1><p>Content-Encoding实体报头域被用作于媒体类型的修饰符,它的值指示了已经被应用到实体正文的附加内容的编码,因而要获得Content-Type报头域中所引用的媒体类型,必须采用相应的解码机制.Content-Encoding这样用于记录文档的压缩方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Encoding: gzip</span><br></pre></td></tr></table></figure>

<h1 id="Content-Language"><a href="#Content-Language" class="headerlink" title="Content-Language"></a>Content-Language</h1><p>Content-Language实体报头域描述了资源所用的自然语言.没有设置该域则认为实体内容将提供给所有的语言阅读.</p>
<h1 id="Content-Length"><a href="#Content-Length" class="headerlink" title="Content-Length"></a>Content-Length</h1><p>Content-Length 实体报头域被用于指明实体正文的长度,以字节方式存储的十进制数字来表示.</p>
<h1 id="Content-Type"><a href="#Content-Type" class="headerlink" title="Content-Type"></a>Content-Type</h1><p>Contetn-Type实体报头域用于指明发送给接收者的实体正文的媒体类型.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Content-Type:text/html;charset=UTF-8</span><br><span class="line">Content-Type:application/json;charset=UTF-8</span><br></pre></td></tr></table></figure>

<h1 id="Last-Modified"><a href="#Last-Modified" class="headerlink" title="Last-Modified"></a>Last-Modified</h1><p>Last-Modified实体报头域用于指示资源的最后修改日期和时间</p>
<h1 id="Expires"><a href="#Expires" class="headerlink" title="Expires"></a>Expires</h1><p>Expires 实体报头域给出响应过期的日期和时间.为了让代理服务器或浏览器在一段时间以后更新缓存中的页面(再次访问曾访问过的页面时,直接从缓存中加载,缩短响应时间和降低服务器负载).可以使用Expires实体报头域指定页面过期的时间.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Expires: Thu,15 Sep 2006 16:23:12 GMT</span><br></pre></td></tr></table></figure>

<p>HTTP1.1的客户端和缓存必须将其他非法的日期格式(包括0)看作已经过期。为了让浏览器不要缓存⻚面,我们也可以利用Expires实体报头域,设置为0</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.setHeader(<span class="string">"Expires"</span>, <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="built_in">Date</span>.now() + <span class="number">2592000000</span>).toUTCString());</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/02/http协议/" data-id="ckh5kzawn000ytgv2w2dnf1ap" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; 上一页</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/">CSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DOM/">DOM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DS-js-数据驱动/">DS.js 数据驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/How-to-use-hexo-create-a-blog/">How to use hexo create a blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/canvas-基础/">canvas 基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/CSS/" style="font-size: 20px;">CSS</a> <a href="/tags/DOM/" style="font-size: 10px;">DOM</a> <a href="/tags/DS-js-数据驱动/" style="font-size: 10px;">DS.js 数据驱动</a> <a href="/tags/How-to-use-hexo-create-a-blog/" style="font-size: 10px;">How to use hexo create a blog</a> <a href="/tags/canvas-基础/" style="font-size: 10px;">canvas 基础</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/11/05/D3/">D3</a>
          </li>
        
          <li>
            <a href="/2020/10/09/DOM/">DOM</a>
          </li>
        
          <li>
            <a href="/2020/10/09/CSS总结/">CSS总结</a>
          </li>
        
          <li>
            <a href="/2020/10/09/canvas基础/">canvas</a>
          </li>
        
          <li>
            <a href="/2020/10/09/设计模式/">设计模式</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Richard.Zhao<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>