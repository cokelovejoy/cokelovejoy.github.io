<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>RICHARD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Technology Blog">
<meta name="keywords" content="Python, JS, Vue, NodeJS">
<meta property="og:type" content="website">
<meta property="og:title" content="RICHARD">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="RICHARD">
<meta property="og:description" content="Technology Blog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RICHARD">
<meta name="twitter:description" content="Technology Blog">
  
    <link rel="alternate" href="/atom.xml" title="RICHARD" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">RICHARD</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">RICHARD BLOG</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Node-Koa2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/23/Node-Koa2/" class="article-date">
  <time datetime="2019-12-23T06:09:02.000Z" itemprop="datePublished">2019-12-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/23/Node-Koa2/">Node Koa2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="koa-简介"><a href="#koa-简介" class="headerlink" title="koa 简介"></a>koa 简介</h2><ul>
<li><p>概述: Koa 基于Nodejs平台的web框架,koa 不在内核方法中绑定任何中间件，它仅提供一个轻量的函数库,更有效率的编写服务端应用程序.</p>
</li>
<li><p>特点:</p>
<ul>
<li>轻量,无捆绑</li>
<li>中间件架构</li>
<li>优雅的API设计</li>
<li>增强的错误处理</li>
</ul>
</li>
<li><p>安装<br>Koa 依赖 node v7.6.0</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i koa</span><br></pre></td></tr></table></figure>
</li>
<li><p>应用<br>中间件机制、请求、响应处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.body = [&#123;<span class="attr">name</span>: <span class="string">'Tom'</span>&#125;]</span><br><span class="line">    next()</span><br><span class="line">&#125;)</span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'url '</span>, ctx.url)</span><br><span class="line">    <span class="keyword">if</span> (ctx.url === <span class="string">'/html'</span>) &#123;</span><br><span class="line">        ctx.type = <span class="string">'text/html;charset=utf-8'</span></span><br><span class="line">        ctx.body = <span class="string">`my name is <span class="subst">$&#123;ctx.body[<span class="number">0</span>].name&#125;</span>`</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Context-上下文"><a href="#Context-上下文" class="headerlink" title="Context(上下文)"></a>Context(上下文)</h2><p>Koa Context 将 node 的 request 和 response 对象封装在一个单独的对象里面，其为编写 web 应用和 API 提供了很多有用的方法.</p>
<p>context 在每个 request 请求时被创建，在中间件中作为接收器(receiver)来引用.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  ctx; <span class="comment">// is the Context</span></span><br><span class="line">  ctx.request; <span class="comment">// is a koa Request</span></span><br><span class="line">  ctx.response; <span class="comment">// is a koa Response</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>许多 context 的访问器和方法为了便于访问和调用，简单的委托给他们的 ctx.request 和 ctx.response 所对应的等价方法， 比如说 ctx.type 和 ctx.length 代理了 response 对象中对应的方法，ctx.path 和 ctx.method 代理了 request 对象中对应的方法。</p>
<h3 id="ctx对象常用"><a href="#ctx对象常用" class="headerlink" title="ctx对象常用"></a>ctx对象常用</h3><p>ctx对象 可以用来获取header和设置响应body等等.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ctx = &#123;</span><br><span class="line">    <span class="comment">// 请求 koa request</span></span><br><span class="line">    request: &#123;</span><br><span class="line">        method: <span class="string">'GET'</span>,</span><br><span class="line">        url: <span class="string">'/'</span>,</span><br><span class="line">        header: &#123;</span><br><span class="line">            host: <span class="string">'localhost:3000'</span>,</span><br><span class="line">            connection: <span class="string">'keep-alive'</span>,</span><br><span class="line">            <span class="string">'upgrade-insecure-requests'</span>: <span class="string">'1'</span>,</span><br><span class="line">            <span class="string">'user-agent'</span>: <span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.97 Safari/537.36'</span>,</span><br><span class="line">            <span class="string">'sec-fetch-user'</span>: <span class="string">'?1'</span>,</span><br><span class="line">            accept: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3'</span>,</span><br><span class="line">            <span class="string">'sec-fetch-site'</span>: <span class="string">'none'</span>,</span><br><span class="line">            <span class="string">'sec-fetch-mode'</span>: <span class="string">'navigate'</span>,</span><br><span class="line">            <span class="string">'accept-encoding'</span>: <span class="string">'gzip, deflate, br'</span>,</span><br><span class="line">            <span class="string">'accept-language'</span>: <span class="string">'zh,en-US;q=0.9,en;q=0.8,zh-CN;q=0.7'</span>,</span><br><span class="line">            cookie: <span class="string">'_hjid=5c5ad555-0426-41d4-8249-f4d47d617f24; ABTasty=uid=19090212351428483&amp;fst=1567398914410&amp;pst=1576572507769&amp;cst=1576743674400&amp;ns=916&amp;pvt=1188&amp;pvis=301&amp;th=493794.619463.308.27.151.1.1573042428637.1576743943914.1_505478.0.261.7.122.1.1573463931498.1576488639383.1_509169.0.281.1.40.1.1574068957131.1576572507782.1_515682.644756.118.6.17.1.1575885466806.1576744825251.1'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 响应 koa response</span></span><br><span class="line">    response: &#123;</span><br><span class="line">        status: <span class="number">200</span>,</span><br><span class="line">        message: <span class="string">'OK'</span>,</span><br><span class="line">        header: &#123;</span><br><span class="line">            <span class="string">'content-type'</span>: <span class="string">'application/json; charset=utf-8'</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">    app: &#123;</span><br><span class="line">        subdomainOffset: <span class="number">2</span>,</span><br><span class="line">        proxy: <span class="literal">false</span>,</span><br><span class="line">        env: <span class="string">'development'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    originalUrl: <span class="string">'/'</span>,</span><br><span class="line">    <span class="comment">// 原生Node的request对象</span></span><br><span class="line">    req: <span class="string">'&lt;original node req&gt;'</span>,</span><br><span class="line">    <span class="comment">// 原生Node的response对象</span></span><br><span class="line">    res: <span class="string">'&lt;original node res&gt;'</span>,</span><br><span class="line">    socket: <span class="string">'&lt;original node socket&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>区分request,response,req, res</li>
</ol>
<ul>
<li>request   koa的请求对象</li>
<li>response  koa的响应对象</li>
<li>req       Node的请求对象</li>
<li>res       Node的响应对象<br>避免使用Node属性和方法.</li>
</ul>
<ol start="2">
<li><p>ctx.app<br>应用实例引用</p>
</li>
<li><p>ctx.state<br>命名空间,用于通过中间件传递信息到前端视图.(保存某些data,然后全局可用)</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ctx.state.user = &#123;</span><br><span class="line">    name: <span class="string">'Tom'</span>,</span><br><span class="line">    age: <span class="number">18</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><p>Koa中的路由和Express不同,Express内部集成了路由,而Koa则需要通过koa-router模块使用路由.</p>
<ol>
<li><p>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install koa-router -S</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router()</span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.body = <span class="string">'hello world'</span></span><br><span class="line">    next()</span><br><span class="line">&#125;)</span><br><span class="line">router.get(<span class="string">'/string'</span>, <span class="keyword">async</span> (ctx,next) =&gt; &#123;</span><br><span class="line">    ctx.body = <span class="string">'koa2 string'</span></span><br><span class="line">    next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/json'</span>, <span class="keyword">async</span> (ctx,next) =&gt; &#123;</span><br><span class="line">    ctx.body = &#123;<span class="attr">title</span>: <span class="string">'koa2 json'</span>&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.use(router.routes())</span><br><span class="line">app.listen(<span class="number">3002</span>)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><p>Koa中间件机制就是函数组合的概念,将一组需要顺序执行的函数复合为一个函数,外层函数的参数实际是内层函数的返回值。洋葱圈模型可以形象表示这种机制.<br>使用app.use()加载中间件。每个中间件接收两个参数，ctx对象和next函数，通过调用next将执行权交给下一个中间件。<br><img src="/static/img/middleware.png"></p>
<p>中间件分为:</p>
<ul>
<li><p>应用级中间件<br>任何路由都会先经过应用级中间件，当执行完成next后再去匹配相应的路由。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用级中间件</span></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">    ctx.body = <span class="string">'hello koa'</span>;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动路由</span></span><br><span class="line">app.use(router.routes()).use(router.allowedMethods());</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, err =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'runing...'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>路由级中间件<br>路由匹配过程中，对于相同路由会从上往下依次执行中间件，直到最后一个没有next参数的中间件为止。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">'/user'</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">111</span>)</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/user'</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">222</span>)</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/user'</span>, <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">333</span>)</span><br><span class="line">    ctx.body = <span class="string">'Hello'</span></span><br><span class="line">&#125;)  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 依次打印</span></span><br><span class="line"><span class="comment">// 111</span></span><br><span class="line"><span class="comment">// 222</span></span><br><span class="line"><span class="comment">// 333</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>错误处理中间件</p>
</li>
</ul>
<p>路由在匹配成功并执行完相应的操作后还会再次进入应用级中间件执行 next 之后的逻辑。所以对于404、500等错误可以在最外层的（第一个）应用级中间件的next之后做相应的处理。<br>如果只有一个应用级中间件的话，顺序就无所谓所有路由中间的之前之后了.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="keyword">async</span> (ctx, next)=&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    <span class="keyword">if</span>(ctx.status === <span class="number">404</span>)&#123;</span><br><span class="line">        ctx.body=<span class="string">"404页面"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>第三方中间件<br>类似于koa-router、koa-bodyparser等就是第三方中间件。</p>
</li>
<li><p>合成中间件<br>koa-compose 模块可以将多个中间件合成为一个。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> compose = <span class="built_in">require</span>(<span class="string">'koa-compose'</span>)</span><br><span class="line"><span class="keyword">const</span> first = asycn (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> second = <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">    ctx.body = <span class="string">'Hello'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> middle = compose([first, second]);</span><br><span class="line">app.use(middle);</span><br></pre></td></tr></table></figure>
</li>
<li><p>koa执行顺序<br>每一个app.use(),传入use内的是一个中间件函数(异步函数,使用async),代码从上往下依次执行每个app.use()内部的中间件函数.当中间件内部遇到next()函数时,该函数后续代码的执行会被暂停,先去执行下一个app.use()内的中间件函数,如此继续进行,直到所有的中间件执行完后,再返回从下往上依次执行每个中间件中被暂停挂起的后续代码(从最底层向最顶层执行).</p>
</li>
</ul>
<p>多个中间件会形成堆栈结构，按先进后出顺序执行.</p>
<h2 id="获取数据"><a href="#获取数据" class="headerlink" title="获取数据"></a>获取数据</h2><ol>
<li>GET传值<br>Koa中GET传值通过request接受,两种方式: query 和querystring.<br>query:返回的是参数对象.{name: ‘tom’, age: 18},<br>querystring: 返回的是请求字符串. ‘name=tom&amp;age=12’</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 从ctx.request下获取</span></span><br><span class="line"><span class="keyword">let</span> query = ctx.request.query;</span><br><span class="line"><span class="keyword">let</span> querystring = ctx.request.querystring;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 直接ctx获取</span></span><br><span class="line">ctx.query</span><br><span class="line">ctx.querystring</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>POST传值<br>通过原生Node处理<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> data = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ctx.req实际上就是原生node中的req</span></span><br><span class="line">            ctx.req.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">                data += chunk;</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            ctx.req.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">                data = querystring.parse(data);</span><br><span class="line">                resolve(data);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            reject(err);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>使用 koa-bodyparser模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>);</span><br><span class="line">app.use(bodyParser());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取</span></span><br><span class="line">ctx.request.body</span><br></pre></td></tr></table></figure>

<h2 id="处理静态资源"><a href="#处理静态资源" class="headerlink" title="处理静态资源"></a>处理静态资源</h2><p>对于js,css,img等静态资源采用koa-static中间件处理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install koa-static</span><br></pre></td></tr></table></figure>

<p>配置:<br>静态目录为static</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'koa-static'</span>)(__dirname + <span class="string">'/static'</span>))</span><br></pre></td></tr></table></figure>

<p>在模板中即可访问:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/css/header.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/image/account.eb695dc.png"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/23/Node-Koa2/" data-id="ckh44mzsy00084sv2qwxrs1a2" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-NodeJS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/18/NodeJS/" class="article-date">
  <time datetime="2019-12-18T09:48:24.000Z" itemprop="datePublished">2019-12-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/18/NodeJS/">NodeJS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="NodeJs"><a href="#NodeJs" class="headerlink" title="NodeJs"></a>NodeJs</h1><h2 id="理解NodeJS是什么"><a href="#理解NodeJS是什么" class="headerlink" title="理解NodeJS是什么"></a>理解NodeJS是什么</h2><p>官方的话:Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行时。<br>自己的话: Node.js 就是javaScript的运行环境,不同于ECMAScript,node.js里面提供了许多能进行系统编程,网络编程的库(如:fs, os, net, http,等等)这样子就能操作我们的主机了. 可以类比C语言,JAVA语言,他们都能对系统进行操作,而NodeJs出现就是为了让javaScript有能力操作我们的系统.</p>
<p>类比理解运行时的概念: </p>
<ul>
<li>JRE java运行时环境</li>
<li>C Runtime</li>
<li>.Net Common Language Runtime</li>
</ul>
<p>运行时： runtime 就是 程序运行的时候.<br>运行时库： 就是程序运行的时候所需要依赖的库.</p>
<p>运行的时候指的是指令加载到内存并由CPU执行的时候.<br>C代码编译成可执行文件的时候, 指令没有被CPU执行, 这个时候是编译时,就是编译的时候.</p>
<h2 id="Nodejs"><a href="#Nodejs" class="headerlink" title="Nodejs"></a>Nodejs</h2><p>Nodejs操作对象：os(操作系统)，process(进程)，fs(文件系统)，net(网络通讯)<br>JavaScript操作对象：BOM/DOM，XMLHttpRequest/fetch(网络通讯)</p>
<h2 id="NodeJS特性-本质就是JavaScript的特性"><a href="#NodeJS特性-本质就是JavaScript的特性" class="headerlink" title="NodeJS特性 (本质就是JavaScript的特性)"></a>NodeJS特性 (本质就是JavaScript的特性)</h2><ul>
<li>非阻塞I/O</li>
<li>事件驱动</li>
</ul>
<h2 id="NodeJS程序"><a href="#NodeJS程序" class="headerlink" title="NodeJS程序"></a>NodeJS程序</h2><p>运行js代码命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node xxxx.js</span><br></pre></td></tr></table></figure>

<p>每次修改js文件需要重新执行才能生效,安装nodemon可以监视文件改动,自动重启:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -g nodemon</span><br></pre></td></tr></table></figure>

<p>然后用nodemon 运行js代码:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nodemon xxx.js</span><br></pre></td></tr></table></figure>

<h3 id="module-模块"><a href="#module-模块" class="headerlink" title="module(模块)"></a>module(模块)</h3><p>模块分为核心模块,内置模块,第三方模块<br>模块操作: require(), module.exports = {}, exports.xxxFunc = () =&gt; {}</p>
<h4 id="核心模块"><a href="#核心模块" class="headerlink" title="核心模块"></a>核心模块</h4><p>核心模块不需要引用,可以通过关键字直接使用</p>
<ul>
<li><p>Buffer<br>Buffer - 用于在 TCP 流、文件系统操作、以及其他上下文中与八位字节流进行交互。 八位字<br>节组成的数组,可以有效的在JS中存储二进制数据<br>方法: alloc(), from(), write(), concat(), toString()</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个长度为10 字节 以0填充的内存空间, Buffer 的大小在创建时确定，且无法更改.</span></span><br><span class="line"><span class="keyword">const</span> buf1 = Buffer.alloc(<span class="number">10</span>) </span><br><span class="line"><span class="built_in">console</span>.log(buf1)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个Buffer包含ascii字符</span></span><br><span class="line"><span class="keyword">const</span> buf2 = Buffer.from(<span class="string">'a'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(buf2, buf2.toString())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建Buffer包含UTF-8字节</span></span><br><span class="line"><span class="comment">// UFT-8:一种变长的编码方案,使用 1~6 个字节来存储;</span></span><br><span class="line"><span class="comment">// UFT-32:一种固定长度的编码方案,不管字符编号大小,始终使用 4 个字节来存储;</span></span><br><span class="line"><span class="comment">// UTF-16:介于 UTF-8 和 UTF-32 之间,使用 2 个或者 4 个字节来存储,长度既固定又可变</span></span><br><span class="line"><span class="keyword">const</span> buf3 = Buffer.from(<span class="string">'中文'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(buf3, buf3.toString())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写入Buffer数据</span></span><br><span class="line">buf1.write(<span class="string">'hello'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(buf1)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取Buffer数据</span></span><br><span class="line"><span class="built_in">console</span>.log(buf1.toString())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并Buffer</span></span><br><span class="line"><span class="keyword">const</span> buf4 = Buffer.concat([buf1, buf3]);</span><br><span class="line"><span class="built_in">console</span>.log(buf4.toString())</span><br></pre></td></tr></table></figure>
</li>
<li><p>process</p>
</li>
</ul>
<h4 id="内置模块"><a href="#内置模块" class="headerlink" title="内置模块"></a>内置模块</h4><p>内置模块不需要使用npm install 安装,但是需要使用require引入</p>
<ul>
<li><p>os</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> os = <span class="built_in">require</span>(<span class="string">'os'</span>)</span><br><span class="line"><span class="keyword">const</span> mem = os.freemem() / os.totalmem() * <span class="number">100</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`内存占用率<span class="subst">$&#123;mem.toFixed(<span class="number">2</span>)&#125;</span>%`</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>fs<br>fs是文件系统,提供了一系列操作文件的方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="comment">// 同步调用 readFileSync()方法</span></span><br><span class="line"><span class="keyword">const</span> data = fs.readFileSync(<span class="string">'./download.js'</span>) <span class="comment">// 返回的是Buffer</span></span><br><span class="line"><span class="built_in">console</span>.log(data.toString())    </span><br><span class="line"></span><br><span class="line"><span class="comment">// 异步调用 readFile()方法</span></span><br><span class="line">fs.readFile(<span class="string">'./download.js'</span>, (err, data) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err</span><br><span class="line">    <span class="built_in">console</span>.log(data.toString())</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// fs常常搭配path 使用</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line">fs.readFile(path.resolve(path.resolve(__dirname, <span class="string">'./download.js'</span>)), (err, data) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(data.toString());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// promisify</span></span><br><span class="line"><span class="keyword">const</span> &#123; promisify &#125; = <span class="built_in">require</span>(<span class="string">'util'</span>)</span><br><span class="line"><span class="keyword">const</span> readFile = promisify(fs.readFile)</span><br><span class="line">readFile(<span class="string">'./download.js'</span>).then(<span class="function"><span class="params">data</span> =&gt;</span> <span class="built_in">console</span>.log(data.toString()))</span><br><span class="line"></span><br><span class="line"><span class="comment">// fs Promises API node v10</span></span><br><span class="line"><span class="keyword">const</span> fsp = <span class="built_in">require</span>(<span class="string">"fs"</span>).promises;</span><br><span class="line">fsp.readFile(<span class="string">"./download.js"</span>)</span><br><span class="line">    .then(<span class="function"><span class="params">data</span> =&gt;</span> <span class="built_in">console</span>.log(data.toString()))</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err));</span><br><span class="line"></span><br><span class="line"><span class="comment">// async await</span></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line">    <span class="keyword">const</span> &#123; promisify &#125; = <span class="built_in">require</span>(<span class="string">'util'</span>)</span><br><span class="line">    <span class="keyword">const</span> readFile = promisify(fs.readFile)</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> readFile(<span class="string">'./download.js'</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'data'</span>, data.toString())</span><br><span class="line"> &#125;)()</span><br></pre></td></tr></table></figure>
</li>
<li><p>path</p>
</li>
<li><p>http<br>http: 用于创建web服务器的模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个http服务器</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">request, response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'there is a request come in'</span>)</span><br><span class="line">    response.end(<span class="string">'a response from server'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">server.listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>有路由控制的简单web服务器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">request, response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// request 和 response 都是stream流</span></span><br><span class="line">    <span class="keyword">const</span> &#123;url, method&#125; = request</span><br><span class="line">    <span class="keyword">if</span> (url === <span class="string">'/'</span> &amp;&amp; method === <span class="string">'GET'</span>) &#123;</span><br><span class="line">        fs.readFile(<span class="string">'index.html'</span>, (err, data) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                response.writeHead(<span class="number">500</span>, &#123;<span class="string">'Content-Type'</span>:<span class="string">'text/plain;charset=utf8'</span>&#125;)</span><br><span class="line">                response.end(<span class="string">'500 服务器错误'</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            response.statusCode = <span class="number">200</span></span><br><span class="line">            response.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/html'</span>)</span><br><span class="line">            response.end(data)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        response.statusCode = <span class="number">404</span></span><br><span class="line">        response.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/plain;charset=utf8'</span>)</span><br><span class="line">        response.end(<span class="string">' 404 not found'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">server.listen(<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>

<p>编写一个请求接口</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (url === <span class="string">'/users'</span> &amp;&amp; method == <span class="string">'GET'</span>) &#123;</span><br><span class="line">    response.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>&#125;)</span><br><span class="line">    response.end(<span class="built_in">JSON</span>.stringify([</span><br><span class="line">        &#123;</span><br><span class="line">            name: <span class="string">'tom'</span>,</span><br><span class="line">            age: <span class="number">20</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>event</li>
<li>stream<br>流（stream）是 Node.js 中处理流式数据的抽象接口。 stream 模块用于构建实现了流接口的对象。<br>流可以是可读的、可写的、或者可读可写的。 所有的流都是 EventEmitter 的实例。<br>Node.js 创建的流都是运作在字符串和 Buffer（或 Uint8Array）上。 当然，流的实现也可以使用其它类型的 JavaScript 值（除了 null）。 这些流会以“对象模式”进行操作。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> stream = <span class="built_in">require</span>(<span class="string">'stream'</span>)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  创建输入输出流</span></span><br><span class="line"><span class="keyword">const</span> rs = fs.createReadStream(<span class="string">'./config.js'</span>)</span><br><span class="line"><span class="keyword">const</span> ws = fs.createWriteStream(<span class="string">'./config.js'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 图片操作</span></span><br><span class="line"><span class="keyword">const</span> rs2 = fs.createReadStream(<span class="string">'./01.png'</span>)</span><br><span class="line"><span class="keyword">const</span> ws2 = fs.createReadStream(<span class="string">'./new.png'</span>)</span><br><span class="line">rs2.pipe(ws2) <span class="comment">// 将可读流 对接 可写流, (实现复制01.png为new.png)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应图片请求</span></span><br><span class="line"><span class="keyword">const</span> &#123; url, method, headers &#125; = request</span><br><span class="line"><span class="keyword">if</span> (method === <span class="string">'GET'</span> &amp;&amp; headers.accept.indexOf(<span class="string">'image/*'</span>) !== <span class="number">-1</span>) &#123;</span><br><span class="line">    fs.createReadStream(<span class="string">'.'</span> + url).pipe(response)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Accept代表发送端(客户端)希望接受的数据类型。 比如:Accept:text/xml; 代表客户端希望</span></span><br><span class="line"><span class="comment">接受的数据类型是xml类型。</span></span><br><span class="line"><span class="comment">Content-Type代表发送端(客户端|服务器)发送的实体数据的数据类型。 比如:Content-</span></span><br><span class="line"><span class="comment">Type:text/html; 代表发送端发送的数据格式是html。</span></span><br><span class="line"><span class="comment">二者合起来, Accept:text/xml; Content-Type:text/html ,即代表希望接受的数据类型是xml格</span></span><br><span class="line"><span class="comment">式,本次请求发送的数据的数据格式是html。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>使用流实现了一个 HTTP 服务器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// req 是一个 http.IncomingMessage 实例，它是可读流。</span></span><br><span class="line">    <span class="comment">// res 是一个 http.ServerResponse 实例，它是可写流。</span></span><br><span class="line">    <span class="keyword">let</span> body = <span class="string">''</span>;</span><br><span class="line">    <span class="comment">// 接收数据为 utf8 字符串，</span></span><br><span class="line">    <span class="comment">// 如果没有设置字符编码，则会接收到 Buffer 对象。</span></span><br><span class="line">    req.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line">    <span class="comment">// 如果添加了监听器，则可读流会触发 'data' 事件。</span></span><br><span class="line">    <span class="comment">// 把数据流分成一块一块来传输,这其中一块就用chunk表示</span></span><br><span class="line">    req.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">        body += chunk;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 'end' 事件表明整个请求体已被接收。 </span></span><br><span class="line">    req.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> data = <span class="built_in">JSON</span>.parse(body);</span><br><span class="line">            <span class="comment">// 响应信息给用户。</span></span><br><span class="line">            res.write(<span class="keyword">typeof</span> data);</span><br><span class="line">            res.end();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (er) &#123;</span><br><span class="line">            <span class="comment">// json 解析失败。</span></span><br><span class="line">            res.statusCode = <span class="number">400</span>;</span><br><span class="line">            <span class="keyword">return</span> res.end(<span class="string">`错误: <span class="subst">$&#123;er.message&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="number">1337</span>);</span><br></pre></td></tr></table></figure>

<h4 id="第三方模块"><a href="#第三方模块" class="headerlink" title="第三方模块"></a>第三方模块</h4><p>第三方模块需要npm install, 然后require</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// download-git-repo 用于下载git代码库</span></span><br><span class="line"><span class="comment">// ora 命令行出现图形化loading</span></span><br><span class="line"><span class="keyword">const</span> download = <span class="built_in">require</span>(<span class="string">'download-git-repo'</span>)</span><br><span class="line"><span class="keyword">const</span> ora = <span class="built_in">require</span>(<span class="string">'ora'</span>)</span><br><span class="line"><span class="keyword">const</span> process = ora(<span class="string">`下载.....项目`</span>)</span><br><span class="line">process.start()</span><br><span class="line">download(<span class="string">'github:su37josephxia/vue-template'</span>, <span class="string">'test'</span>, err =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        process.fail()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        process.succeed()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="自定义模块"><a href="#自定义模块" class="headerlink" title="自定义模块"></a>自定义模块</h4><p>自定义模块导出: module.exports = {}<br>自定义模块导入: require()</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义模块导出</span></span><br><span class="line"><span class="comment">// promisify 用于返回promise对象</span></span><br><span class="line"><span class="comment">// 让异步任务串行化, await async</span></span><br><span class="line"><span class="built_in">module</span>.exports.clone = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">repo, desc</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; promisify &#125; = <span class="built_in">require</span>(<span class="string">'util'</span>)</span><br><span class="line">    <span class="comment">// 使用promisify包裹 返回 promise对象.</span></span><br><span class="line">    <span class="keyword">const</span> download = promisify(<span class="built_in">require</span>(<span class="string">'download-git-repo'</span>))</span><br><span class="line">    <span class="keyword">const</span> ora = <span class="built_in">require</span>(<span class="string">'ora'</span>)</span><br><span class="line">    <span class="keyword">const</span> process = ora(<span class="string">'下载项目...开始'</span>)</span><br><span class="line">    process.start()</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> download(repo, desc)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        process.fail()</span><br><span class="line">    &#125;</span><br><span class="line">    process.succeed()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义模块导入</span></span><br><span class="line"><span class="keyword">const</span> &#123; clone &#125; = <span class="built_in">require</span>(<span class="string">'./download'</span>)</span><br><span class="line">clone()</span><br></pre></td></tr></table></figure>

<h1 id="自己实现一个vue-auto-router-cli"><a href="#自己实现一个vue-auto-router-cli" class="headerlink" title="自己实现一个vue-auto-router-cli"></a>自己实现一个vue-auto-router-cli</h1><p>vue-auto-router-cli: 根据路由目录结构生成路由配置文件.</p>
<h2 id="项目准备"><a href="#项目准备" class="headerlink" title="项目准备"></a>项目准备</h2><ul>
<li><p>mkdir vue-auto-router-cli</p>
</li>
<li><p>cd vue-auto-router-cli</p>
</li>
<li><p>npm init -y 生成package.json</p>
</li>
<li><p>安装要使用的第三方模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命令行操作工具</span></span><br><span class="line">npm install commander -S </span><br><span class="line"><span class="comment"># 下载git库工具</span></span><br><span class="line">npm install download-git-repo -S </span><br><span class="line"><span class="comment"># 命令行进度条图形化显示工具</span></span><br><span class="line">npm install ora -S</span><br><span class="line"><span class="comment"># 模板引擎,用于生成代码</span></span><br><span class="line">npm install handlerbars -S</span><br><span class="line"><span class="comment"># 命令行文字颜色设置</span></span><br><span class="line">npm install chalk -S</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><ol>
<li>新建文件夹bin,存放shell命令脚本文件kkb, kkb-init, kkb-refresh(不需要后缀名)<br>bin/kkb<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"><span class="keyword">const</span> program = <span class="built_in">require</span>(<span class="string">'commander'</span>)</span><br><span class="line">program.version(<span class="built_in">require</span>(<span class="string">'../package'</span>).version)</span><br><span class="line">    .command(<span class="string">'init &lt;name&gt;'</span>, <span class="string">'init project'</span>)</span><br><span class="line">    .command(<span class="string">'refresh'</span>, <span class="string">'refresh routes...'</span>)</span><br><span class="line">program.parse(process.argv)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>bin/kkb-init</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"><span class="keyword">const</span> program = <span class="built_in">require</span>(<span class="string">'commander'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;clone &#125; = <span class="built_in">require</span>(<span class="string">'../lib/download.js'</span>)</span><br><span class="line"><span class="keyword">const</span> repo = <span class="string">'github:su37josephxia/vue-template'</span></span><br><span class="line"><span class="keyword">const</span> des = <span class="string">'test'</span></span><br><span class="line"></span><br><span class="line">program.action(<span class="keyword">async</span> name =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'创建项目: '</span> + name)</span><br><span class="line">    <span class="keyword">await</span> clone(repo, des)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">program.parse(process.argv)</span><br></pre></td></tr></table></figure>

<p>bin/kkb-refresh</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> program = <span class="built_in">require</span>(<span class="string">'commander'</span>)</span><br><span class="line"><span class="keyword">const</span> symbols = <span class="built_in">require</span>(<span class="string">'log-symbols'</span>)</span><br><span class="line"><span class="keyword">const</span> chalk = <span class="built_in">require</span>(<span class="string">'chalk'</span>)</span><br><span class="line"></span><br><span class="line">program.action(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'refresh...'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">program.parse(process.argv)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取文件夹中有多少文件</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> handlebars = <span class="built_in">require</span>(<span class="string">'handlebars'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> list = fs.readdirSync(<span class="string">'./src/views'</span>)</span><br><span class="line">    .filter(<span class="function"><span class="params">v</span> =&gt;</span> v != <span class="string">'Home.vue'</span>)</span><br><span class="line">    .map(<span class="function"><span class="params">v</span> =&gt;</span> (&#123;</span><br><span class="line">        name : v.replace(<span class="string">'.vue'</span>, <span class="string">''</span>).toLowerCase(),</span><br><span class="line">        file : v</span><br><span class="line">    &#125;))</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compile</span>(<span class="params">meta, filePath, templatePath</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (fs.existsSync(templatePath)) &#123;</span><br><span class="line">        <span class="keyword">const</span> content = fs.readFileSync(templatePath).toString()</span><br><span class="line">        <span class="keyword">const</span> result = handlebars.compile(content)(meta)</span><br><span class="line">        fs.writeFileSync(filePath, result)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(symbols.success, chalk.green(<span class="string">`<span class="subst">$&#123;filePath&#125;</span>创建成功`</span>))</span><br><span class="line">&#125;</span><br><span class="line">compile(&#123;list&#125;, <span class="string">'./src/router.js'</span>, <span class="string">'./template/router.js.hbs'</span>)</span><br><span class="line">compile(&#123;list&#125;, <span class="string">'./src/App.vue'</span>, <span class="string">'./template/App.vue.hbs'</span>)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>新建文件夹lib,新建文件download.js用于下载git库<br>lib/download.js</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> download = <span class="built_in">require</span>(<span class="string">'download-git-repo'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; promisify &#125; = <span class="built_in">require</span>(<span class="string">'util'</span>)</span><br><span class="line"><span class="keyword">const</span> ora = <span class="built_in">require</span>(<span class="string">'ora'</span>)</span><br><span class="line"><span class="comment">// const repo = 'github:su37josephxia/vue-template'</span></span><br><span class="line"><span class="comment">// const des = 'test'</span></span><br><span class="line"><span class="keyword">const</span> downPromise = promisify(download)</span><br><span class="line"><span class="built_in">module</span>.exports.clone = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">repo, des</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> process = ora(<span class="string">`正在下载...<span class="subst">$&#123;repo&#125;</span>`</span>)</span><br><span class="line">    process.start()</span><br><span class="line">    <span class="keyword">await</span> downPromise(repo, des)</span><br><span class="line">    process.succeed()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>运行命令 npm link<br>执行 npm link 命令,内部做了如下操作.</li>
</ol>
<ul>
<li>可以将执行命令当前目录下作为npm包写入到/home/richard/npm-global/lib/node_modules/下<br>(/home/richard/npm-global/lib/node_modules/vue-auto-router-cli -&gt; /home/richard/Desktop/VueLearn/vue-auto-router-cli)</li>
<li>建立了软链接从/usr/local/bin/kkb —&gt; /home/richard/npm-global/bin/kkb,从而可以全局使用命令执行脚本.</li>
</ul>
<ol start="4">
<li><p>运行命令 chmod +x bin/*</p>
</li>
<li><p>使用kkb init 和 kkb refresh<br>然后可以通过运行命令kkb init testProject,下载vue-template项目从github.每次在testProject/src/views 下新增vue文件后, 然后执行命令kkb refresh命令可以根据views下的文件自动配置router.js</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/18/NodeJS/" data-id="ckh44mztc000f4sv2jgw4xn6e" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Vue项目测试" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/18/Vue项目测试/" class="article-date">
  <time datetime="2019-12-18T06:49:02.000Z" itemprop="datePublished">2019-12-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/18/Vue项目测试/">Vue项目测试</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="项目测试"><a href="#项目测试" class="headerlink" title="项目测试"></a>项目测试</h1><h2 id="测试分类"><a href="#测试分类" class="headerlink" title="测试分类"></a>测试分类</h2><p>常见的开发流程里,都有测试人员,他们不管内部实现机制,只看最外层的输入输出,这种我们称为黑<br>盒测试。比如你写一个加法的页面,会设计N个用例,测试加法的正确性,这种测试我们称之为E2E测<br>试。<br>还有一种测试叫做白盒测试,我们针对一些内部核心实现逻辑编写测试代码,称之为单元测试。<br>更负责一些的我们称之为集成测试,就是集合多个测试过的单元一起测试。</p>
<h2 id="编写测试代码的好处"><a href="#编写测试代码的好处" class="headerlink" title="编写测试代码的好处"></a>编写测试代码的好处</h2><ul>
<li>提供描述组件行为的文档</li>
<li>节省手动测试的时间</li>
<li>减少研发新特性时产生的bug</li>
<li>改进设计</li>
<li>促进重构<br>自动化测试使得团队中的开发者可以维护复杂的基础代码.</li>
</ul>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>在Vue中,推荐使用Mocha + Chai或者(Jest).要完成测试任务,需要测试框架(跑测试), 断言库(编写测试) 和变成框架特有的测试套件.Mocha是测试框架, Chai是断言库,Jest同时包含两者.</p>
<p>vue中的组件等测试代码的编写需要vue-test-utils套件支持。</p>
<h3 id="新建vue项目时"><a href="#新建vue项目时" class="headerlink" title="新建vue项目时"></a>新建vue项目时</h3><ul>
<li>选择特性 Unit Testing 和E2E Testing<img src="/static/img/test1.png"></li>
<li>单元测试解决方案选择: Jest<img src="/static/img/test2.png"></li>
<li>端到端测试解决方案选择:Cypress<img src="/static/img/test3.png">
### 在已存在的项目中集成
运行命令:
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue add @vue/unit-jest 和 vue add @vue/e2e-cypress</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="编写单元测试"><a href="#编写单元测试" class="headerlink" title="编写单元测试"></a>编写单元测试</h2><p>单元测试(unit testing), 是指对软件中的最小可测试单元进行检查和验证.</p>
<ul>
<li>新建 test/unit/xxx.spec.js (.spec.js后缀名是命名规范)</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">num1, num2</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> num1 + num2</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 测试套件 test suite</span></span><br><span class="line">describe(<span class="string">'Kaikeba'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// 测试用例 test case</span></span><br><span class="line">    it(<span class="string">'测试add函数'</span>, () =&gt; &#123;</span><br><span class="line">        <span class="comment">// 断言 assert</span></span><br><span class="line">        expect(add(<span class="number">1</span>, <span class="number">3</span>)).toBe(<span class="number">3</span>)</span><br><span class="line">        expect(add(<span class="number">1</span>, <span class="number">3</span>)).toBe(<span class="number">4</span>)</span><br><span class="line">        expect(add(<span class="number">-2</span>, <span class="number">3</span>)).toBe(<span class="number">1</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="执行单元测试"><a href="#执行单元测试" class="headerlink" title="执行单元测试"></a>执行单元测试</h2><p>执行命令: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run <span class="built_in">test</span>:unit</span><br></pre></td></tr></table></figure>

<h2 id="断言API简介"><a href="#断言API简介" class="headerlink" title="断言API简介"></a>断言API简介</h2><ul>
<li>describe: 定义一个测试套件</li>
<li>it: 定义一个测试用例</li>
<li>expect: 断言的判断条件(Doc: <a href="https://jestjs.io/docs/zh-Hans/expect" target="_blank" rel="noopener">https://jestjs.io/docs/zh-Hans/expect</a>)</li>
</ul>
<h2 id="测试Vue组件"><a href="#测试Vue组件" class="headerlink" title="测试Vue组件"></a>测试Vue组件</h2><p>vue官方提供了用于单元测试的使用工具库 @vue/test-utils (Doc: <a href="https://vue-test-utils.vuejs.org/zh/guides/" target="_blank" rel="noopener">https://vue-test-utils.vuejs.org/zh/guides/</a>)</p>
<p>创建一个vue组件components/click.vue</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; message &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"changeMsg"</span>&gt;</span>点击<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">        data() &#123;</span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">                message: <span class="string">'vue-text'</span></span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        created() &#123;</span><br><span class="line"><span class="javascript">            <span class="keyword">this</span>.message = <span class="string">'hello'</span></span></span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line">            changeMsg() &#123;</span><br><span class="line"><span class="javascript">                <span class="keyword">this</span>.message = <span class="string">'按钮点击'</span></span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试该组件, test/unit/click.spec.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> click <span class="keyword">from</span> <span class="string">'@/components/click.vue'</span></span><br><span class="line">describe(<span class="string">'click.vue'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// 检查组件选项</span></span><br><span class="line">    it(<span class="string">'要求设置created生命周期'</span>, () =&gt; &#123;</span><br><span class="line">        expect(<span class="keyword">typeof</span> click.created).toBe(<span class="string">'function'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    it(<span class="string">'message初始值是vue-test'</span>, () =&gt; &#123;</span><br><span class="line">        <span class="comment">// 检查data函数存在性</span></span><br><span class="line">        expect(<span class="keyword">typeof</span> click.data).toBe(<span class="string">'function'</span>)</span><br><span class="line">        <span class="comment">// 检查data返回的默认值</span></span><br><span class="line">        <span class="keyword">const</span> defaultData = click.data()</span><br><span class="line">        expect(defaultData.message).toBe(<span class="string">'vue-test'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="检查mounted之后预期结果"><a href="#检查mounted之后预期结果" class="headerlink" title="检查mounted之后预期结果"></a>检查mounted之后预期结果</h3><p>使用@vue/test-utils挂载组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; mount &#125; <span class="keyword">from</span> <span class="string">'@vue/test-utils'</span></span><br><span class="line"><span class="keyword">import</span> clickComp <span class="keyword">from</span> <span class="string">'@/components/click.vue'</span></span><br><span class="line"></span><br><span class="line">it(<span class="string">'mount之后测data是hello'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> vm = <span class="keyword">new</span> Vue(clickComp).$mount()</span><br><span class="line">    expect(vm.message).toBe(<span class="string">'hello'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">it(<span class="string">"按钮点击后"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> wrapper = mount(clickComp);</span><br><span class="line">    wrapper.find(<span class="string">"button"</span>).trigger(<span class="string">"click"</span>);</span><br><span class="line">    <span class="comment">// 测试数据变化</span></span><br><span class="line">    expect(wrapper.vm.message).toBe(<span class="string">"按钮点击"</span>);</span><br><span class="line">    <span class="comment">// 测试html渲染结果</span></span><br><span class="line">    expect(wrapper.find(<span class="string">"span"</span>).html()).toBe(<span class="string">"&lt;span&gt;按钮点击&lt;/span&gt;"</span>);</span><br><span class="line">    <span class="comment">// 等效的方式</span></span><br><span class="line">    expect(wrapper.find(<span class="string">"span"</span>).text()).toBe(<span class="string">"按钮点击"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="测试覆盖率"><a href="#测试覆盖率" class="headerlink" title="测试覆盖率"></a>测试覆盖率</h3><p>jest自带覆盖率,如果用的mocha,需要使用istanbul来统计覆盖率<br>package.json里修改jest配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"jest"</span>: &#123;</span><br><span class="line">        <span class="string">"collectCoverage"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"collectCoverageFrom"</span>: [<span class="string">"src/**/*.&#123;js,vue&#125;"</span>],</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若采用独立配置, 则修改jest.config.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="string">"collectCoverage"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"collectCoverageFrom"</span>: [<span class="string">"src/**/*.&#123;js,vue&#125;"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再执行 npm run test:unit</p>
<ul>
<li>%stmts是语句覆盖率(statement coverage):是不是每个语句都执行了?</li>
<li>%Branch分支覆盖率(branch coverage):是不是每个if代码块都执行了?</li>
<li>%Funcs函数覆盖率(function coverage):是不是每个函数都调用了?</li>
<li>%Lines行覆盖率(line coverage):是不是每一行都执行了?</li>
</ul>
<p>Vue组件单元测试cookbook(Doc: <a href="https://cn.vuejs.org/v2/cookbook/unit-testing-vue-components.html" target="_blank" rel="noopener">https://cn.vuejs.org/v2/cookbook/unit-testing-vue-components.html</a>)<br>VueTestUtils使用指南(Doc: <a href="https://vue-test-utils.vuejs.org/zh/" target="_blank" rel="noopener">https://vue-test-utils.vuejs.org/zh/</a>)</p>
<h2 id="E2E测试"><a href="#E2E测试" class="headerlink" title="E2E测试"></a>E2E测试</h2><p>借用浏览器的能力,站在用户测试人员的角度,输入框,点击按钮等,完全模拟用户, 这个和具体的框架关系不大,完全模拟浏览器行为.</p>
<h3 id="运行E2E测试"><a href="#运行E2E测试" class="headerlink" title="运行E2E测试"></a>运行E2E测试</h3><p>cypress Doc : <a href="https://docs.cypress.io/api/introduction/api.html" target="_blank" rel="noopener">https://docs.cypress.io/api/introduction/api.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run <span class="built_in">test</span>:e2e</span><br></pre></td></tr></table></figure>

<p>修改e2e/spec/test.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">'端到端测试'</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">'访问'</span>, () =&gt; &#123;</span><br><span class="line">        cy.visit(<span class="string">'/'</span>)</span><br><span class="line">        cy.contains(<span class="string">'h1'</span>, <span class="string">'Welcome to Your Vue.js App'</span>)</span><br><span class="line">        cy.get(<span class="string">'button'</span>).click()</span><br><span class="line">        cy.contains(<span class="string">'span'</span>, <span class="string">'按钮点击'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/18/Vue项目测试/" data-id="ckh44mzts000s4sv2rc1rpi1l" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Vue项目最佳实践" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/13/Vue项目最佳实践/" class="article-date">
  <time datetime="2019-12-13T08:58:01.000Z" itemprop="datePublished">2019-12-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/13/Vue项目最佳实践/">Vue项目最佳实践</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="项目配置"><a href="#项目配置" class="headerlink" title="项目配置"></a>项目配置</h1><h2 id="使用Vue-cli"><a href="#使用Vue-cli" class="headerlink" title="使用Vue-cli"></a>使用Vue-cli</h2><p><a href="https://cli.vuejs.org/zh/" target="_blank" rel="noopener">Vue-Cli</a><br>Vue Cli 用于快速创建Vue项目的脚手架,安装之后使用vue命令创建项目,会生成一些默认的项目目录及配置文件.</p>
<h3 id="安装vue-cli-全局安装"><a href="#安装vue-cli-全局安装" class="headerlink" title="安装vue-cli (全局安装)"></a>安装vue-cli (全局安装)</h3><p>使用npm包管理器安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g @vue/cli</span><br></pre></td></tr></table></figure>

<p>测试vue-cli已经安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue --version</span><br></pre></td></tr></table></figure>

<p>可能出现的问题: 全局安装@vue/cli之后显示没有 找不到vue命令。<br>解决办法: 将安装的全局包建立软连接： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /home/richard/npm-global/bin/vue /usr/<span class="built_in">local</span>/bin/vue</span><br></pre></td></tr></table></figure>

<p>全局安装@vue/cli后,会在/home/richard/npm-global/bin下生成vue文件.<br>执行以上命令后会在/usr/local/bin下生成vue文件,然后就可以在终端使用vue命令.</p>
<h3 id="创建一个项目"><a href="#创建一个项目" class="headerlink" title="创建一个项目"></a>创建一个项目</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue create hello-world</span><br></pre></td></tr></table></figure>

<p>随后可以对一些配置选项自行选择.</p>
<h3 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h3><p>Vue CLI 使用了一套基于插件的架构。查阅一个新创建项目的 package.json，就会发现依赖都是以 @vue/cli-plugin- 开头的。插件可以修改 webpack 的内部配置，也可以向 vue-cli-service 注入命令。在项目创建的过程中，绝大部分列出的特性都是通过插件来实现的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue add eslint</span><br></pre></td></tr></table></figure>

<h3 id="简单配置"><a href="#简单配置" class="headerlink" title="简单配置"></a>简单配置</h3><p>vue.config.js 是一个可选的配置文件，如果项目的 (和 package.json 同级的) 根目录中存在这个文件，那么它会被 @vue/cli-service 自动加载。你也可以使用 package.json 中的 vue 字段，但是注意这种写法需要你严格遵照 JSON 的格式来写。</p>
<p>创建vue.config.js, 指定应用上下文, 端口号,主页title</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vue.config .js</span></span><br><span class="line"><span class="keyword">const</span> port = <span class="number">8080</span></span><br><span class="line"><span class="keyword">const</span> title = <span class="string">'vue项目最佳实践'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    publicPath: <span class="string">'/best-practice'</span>, <span class="comment">// 部署应用包时的基本URL</span></span><br><span class="line">    devServer: &#123;</span><br><span class="line">        port: port,</span><br><span class="line">    &#125;,</span><br><span class="line">    configureWebpack: &#123;</span><br><span class="line">        <span class="comment">// 向 index.html注入标题</span></span><br><span class="line">        name: title</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">webpackConfig.name</span> %&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以使用 vue inspect 来审查一个 Vue CLI 项目的 webpack config。vue inspect&gt;output.js 会输出到文件。</p>
<h3 id="链式操作"><a href="#链式操作" class="headerlink" title="链式操作"></a>链式操作</h3><p>文档: <a href="https://github.com/Yatoo2018/webpack-chain/tree/zh-cmn-Hans" target="_blank" rel="noopener">webpack-chain</a><br>案例: svg icon的引入<br>安装依赖: svg-sprite-loader</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i svg-sprite-loader -D</span><br></pre></td></tr></table></figure>

<p>下载图标保存在src/icons/svg目录下<br>配置 vue.config.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="comment">// resolver函数获取 绝对路径</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params">dir</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> path.join(__dirname, dir)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">chainWebpack(config) &#123;</span><br><span class="line">    <span class="comment">// 配置svg规则 排除icons目录中svg文件处理</span></span><br><span class="line">    config.module</span><br><span class="line">        .rule(<span class="string">"svg"</span>)</span><br><span class="line">        .exclude.add(resolve(<span class="string">"src/icons"</span>)).end()</span><br><span class="line">    <span class="comment">// 新增icons规则, 设置svg-sprite-loader 处理icons目录中的svg</span></span><br><span class="line">    config.module</span><br><span class="line">        .rule(<span class="string">"icons"</span>)</span><br><span class="line">            .test(<span class="regexp">/\.svg/</span>).include.add(resolve(<span class="string">"src/icons"</span>)).end()</span><br><span class="line">            .use(<span class="string">"svg-sprite-loader"</span>)</span><br><span class="line">            .loader(<span class="string">"svg-sprite-loader"</span>)</span><br><span class="line">            .options(&#123; <span class="attr">symbolId</span>: <span class="string">"icon-[name]"</span>&#125;)</span><br><span class="line">            .end()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>图标自动导入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// icons/index.js</span></span><br><span class="line"><span class="keyword">const</span> req = <span class="built_in">require</span>.context(<span class="string">'./svg'</span>, <span class="literal">false</span>, /\.svg/)</span><br><span class="line">req.keys().map(req)</span><br></pre></td></tr></table></figure>

<p>创建SvgIcon组件 ./components/SvgIcon.vue</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;svg :<span class="class"><span class="keyword">class</span></span>=<span class="string">"svgClass"</span> aria-hidden=<span class="string">"true"</span> v-on=<span class="string">"$listeners"</span>&gt;</span><br><span class="line">        &lt;use :xlink:href=<span class="string">"iconName"</span> /&gt;</span><br><span class="line">    &lt;<span class="regexp">/svg&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">        name: <span class="string">'SvgIcon'</span>,</span><br><span class="line">        props: &#123;</span><br><span class="line">            iconClass: &#123;</span><br><span class="line">                type: <span class="built_in">String</span>,</span><br><span class="line">                required: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            className: &#123;</span><br><span class="line">                type: <span class="built_in">String</span>,</span><br><span class="line">                <span class="keyword">default</span>: <span class="string">''</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        computed: &#123;</span><br><span class="line">            iconName() &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">`#icon-<span class="subst">$&#123;<span class="keyword">this</span>.iconClass&#125;</span>`</span></span><br><span class="line">            &#125;,</span><br><span class="line">            svgClass() &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.className) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">'svg-icon '</span> + <span class="keyword">this</span>.className</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">'svg-icon'</span></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;style scoped&gt;</span></span><br><span class="line"><span class="regexp">    .svg-icon &#123;</span></span><br><span class="line"><span class="regexp">        width: 1em;</span></span><br><span class="line"><span class="regexp">        height: 1em;</span></span><br><span class="line"><span class="regexp">        vertical-align: -0.15em;</span></span><br><span class="line"><span class="regexp">        fill: currentColor;</span></span><br><span class="line"><span class="regexp">        overflow: hidden;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&lt;/</span>style&gt;</span><br></pre></td></tr></table></figure>

<h2 id="权限控制和动态路由"><a href="#权限控制和动态路由" class="headerlink" title="权限控制和动态路由"></a>权限控制和动态路由</h2><h3 id="路由定义"><a href="#路由定义" class="headerlink" title="路由定义"></a>路由定义</h3><p>路由分为两种: constantRoutes 和 asyncRoutes</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router.js</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">"vue"</span>;</span><br><span class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">"vue-router"</span>;</span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">'@/layout'</span>; <span class="comment">// 布局页</span></span><br><span class="line">Vue.use(Router);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通用页面:不需要守卫,可直接访问</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> constRoutes = [</span><br><span class="line">    &#123;</span><br><span class="line">        path: <span class="string">"/login"</span>,</span><br><span class="line">        component: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">"@/views/Login"</span>),</span><br><span class="line">        hidden: <span class="literal">true</span> <span class="comment">// 导航菜单忽略该项</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        path: <span class="string">"/"</span>,</span><br><span class="line">        component: Layout,<span class="comment">// 应用布局</span></span><br><span class="line">        redirect: <span class="string">"/home"</span>,</span><br><span class="line">        children: [</span><br><span class="line">            &#123;</span><br><span class="line">                path: <span class="string">"home"</span>,</span><br><span class="line">                component: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: "home" */</span> <span class="string">"@/views/Home.vue"</span>),</span><br><span class="line">                name: <span class="string">"home"</span>,</span><br><span class="line">                meta: &#123;</span><br><span class="line">                    title: <span class="string">"Home"</span>, <span class="comment">// 导航菜单项标题</span></span><br><span class="line">                    icon: <span class="string">"qq"</span> <span class="comment">// 导航菜单项图标</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">];</span><br><span class="line"><span class="comment">// 权限页面:受保护页面,要求用户登录并拥有访问权限的角色才能访问</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> asyncRoutes = [</span><br><span class="line">    &#123;</span><br><span class="line">        path: <span class="string">"/about"</span>,</span><br><span class="line">        component: Layout,</span><br><span class="line">        redirect: <span class="string">"/about/index"</span>,    </span><br><span class="line">        children: [</span><br><span class="line">            &#123;</span><br><span class="line">            path: <span class="string">"index"</span>,</span><br><span class="line">                component: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: "home" */</span> <span class="string">"@/views/About.vue"</span>),</span><br><span class="line">                name: <span class="string">"about"</span>,</span><br><span class="line">                meta: &#123;</span><br><span class="line">                    title: <span class="string">"About"</span>,</span><br><span class="line">                    icon: <span class="string">"qq"</span>,</span><br><span class="line">                    roles: [<span class="string">'admin'</span>, <span class="string">'editor'</span>]</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">];</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Router(&#123;</span><br><span class="line">    mode: <span class="string">"history"</span>,</span><br><span class="line">    base: process.env.BASE_URL,</span><br><span class="line">    routes: constRoutes</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>创建布局页面, layout/index.vue</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"app-wrapper"</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- &lt;sidebar class="sidebar-container" /&gt; --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"main-container"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">router-view</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建用户登录页面, views/Login.vue</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">h2</span>&gt;</span>用户登录<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">v-model</span>=<span class="string">"username"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"login"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">    data() &#123;</span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">            username: <span class="string">"admin"</span></span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        login() &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="用户登录状态维护"><a href="#用户登录状态维护" class="headerlink" title="用户登录状态维护"></a>用户登录状态维护</h3><p>vuex 根模块实现 vuex/store.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">'vuex'</span></span><br><span class="line"><span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">'./modules/user'</span></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">    modules: &#123;user&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store</span><br></pre></td></tr></table></figure>

<p>user模块: 维护用户数据,处理用户登录等, vuex/modules/user.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">    token: localStorage.getItem(<span class="string">'token'</span>),</span><br><span class="line">    <span class="comment">// 其他用户信息</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> mutations = &#123;</span><br><span class="line">    SET_TOKEN: <span class="function">(<span class="params">state, token</span>) =&gt;</span> &#123;</span><br><span class="line">        state.token = token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> actions = &#123;</span><br><span class="line">    <span class="comment">// 模拟用户登录</span></span><br><span class="line">    login(&#123; commit &#125;, userInfo) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; username &#125; = userInfo;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (username === <span class="string">"admin"</span> || username === <span class="string">"jerry"</span>) &#123;</span><br><span class="line">                    commit(<span class="string">"SET_TOKEN"</span>, username);</span><br><span class="line">                    localStorage.setItem(<span class="string">'token'</span>, username);</span><br><span class="line">                    resolve();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    reject(<span class="string">"用户名、密码错误"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">1000</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    namespaced: <span class="literal">true</span>,</span><br><span class="line">    state,</span><br><span class="line">    mutations,</span><br><span class="line">    actions</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>请求登录, Login.vue</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 登录函数</span></span><br><span class="line">login() &#123;</span><br><span class="line">   <span class="keyword">this</span>.$store.dispatch(<span class="string">"user/login"</span>, &#123; <span class="attr">username</span>: <span class="keyword">this</span>.username &#125;)</span><br><span class="line">        .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.$router.push(&#123; <span class="attr">path</span>: <span class="keyword">this</span>.$route.query.redirect || <span class="string">"/"</span> &#125;);</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">            alert(error);</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="路由守卫"><a href="#路由守卫" class="headerlink" title="路由守卫"></a>路由守卫</h3><p>在进入路由前,先进行登录验证,如未登录,跳转至登录页面.<br>创建src/permission.js, 并在main.js中引入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./router'</span></span><br><span class="line"><span class="keyword">const</span> whiteList = [<span class="string">'/login'</span>] <span class="comment">// 无需令牌白名单</span></span><br><span class="line"><span class="comment">// 全局守卫</span></span><br><span class="line">router.beforeEach(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 获取令牌判断用户是否登录</span></span><br><span class="line">    <span class="keyword">const</span> hasToken = localStorage.getItem(<span class="string">'token'</span>)</span><br><span class="line">    <span class="comment">// 已登录</span></span><br><span class="line">    <span class="keyword">if</span> (hasToken) &#123;</span><br><span class="line">        <span class="keyword">if</span> (to.path === <span class="string">'/login'</span>) &#123;</span><br><span class="line">            <span class="comment">// 若已登录没有必要显示登录页,重定向至首页</span></span><br><span class="line">            next(&#123; <span class="attr">path</span>: <span class="string">'/'</span> &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;        </span><br><span class="line">            <span class="comment">// 去其他路由,暂时放过</span></span><br><span class="line">            next()  </span><br><span class="line">            <span class="comment">// 接下来执行用户角色逻辑, todo</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;<span class="comment">// 未登录</span></span><br><span class="line">        <span class="keyword">if</span> (whiteList.indexOf(to.path) !== <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="comment">// 白名单中路由放过</span></span><br><span class="line">            next()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 重定向至登录页</span></span><br><span class="line">            next(<span class="string">`/login?redirect=<span class="subst">$&#123;to.path&#125;</span>`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="用户角色获取和维护"><a href="#用户角色获取和维护" class="headerlink" title="用户角色获取和维护"></a>用户角色获取和维护</h3><p>添加用户角色和获取逻辑, vuex/modules/user.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line"> roles: []</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> mutations = &#123;</span><br><span class="line">    setRoles(state, roles) &#123;</span><br><span class="line">        state.roles = roles</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> actions = &#123;</span><br><span class="line">    <span class="comment">// 模拟获取用户信息,角色和令牌内容一致</span></span><br><span class="line">    getInfo(&#123; commit, state &#125;) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            SetTimerout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> roles = state.token ===<span class="string">'admin'</span> ? [<span class="string">'admin'</span>] : [<span class="string">'editor'</span>]</span><br><span class="line">                commit(<span class="string">"setRoles"</span>, roles)</span><br><span class="line">                resolve(&#123; roles &#125;)</span><br><span class="line">            &#125;, <span class="number">1000</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    state,</span><br><span class="line">    mutations,</span><br><span class="line">    actions</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取用户角色,判断用户是否拥有访问权限, permission.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">'./store.js'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hasRoles = store.state.user.roles &amp;&amp; store.state.user.roles.length &gt; <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> (hasRoles) &#123;</span><br><span class="line">    next() <span class="comment">//继续即可</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 先请求获取用户信息</span></span><br><span class="line">        <span class="keyword">const</span> &#123; roles &#125; = <span class="keyword">await</span> store.dispatch(<span class="string">'user/getInfo'</span>)</span><br><span class="line">        <span class="comment">// 动态路由生成</span></span><br><span class="line">        <span class="keyword">const</span> accessRoutes = <span class="keyword">await</span> store.dispatch(<span class="string">'permission/generateRoutes'</span>, roles)</span><br><span class="line">        <span class="comment">// 动态追加到router</span></span><br><span class="line">        router.addRoutes(accessRoutes)</span><br><span class="line">        <span class="comment">// 路由再进来一次</span></span><br><span class="line">        next(&#123;...to&#125;) </span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="comment">// 出错需重置令牌并重新登录(令牌过期, 网路错误等原因)</span></span><br><span class="line">        <span class="keyword">await</span> store.dispatch(<span class="string">'user/resetToken'</span>)</span><br><span class="line">        next(<span class="string">`/login?redirect=<span class="subst">$&#123;to.path&#125;</span>`</span>)</span><br><span class="line">        alert(error || <span class="string">'未知错误'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>令牌重置, vuex/modules/user.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 清除令牌 写在action中</span></span><br><span class="line">resetToken(&#123; commit &#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">       commit(<span class="string">"SET_TOKEN"</span>, <span class="string">""</span>);</span><br><span class="line">       commit(<span class="string">"SET_ROLES"</span>, []);</span><br><span class="line">       localStorage.removeItem(<span class="string">'token'</span>);</span><br><span class="line">       resolve();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加动态路由"><a href="#添加动态路由" class="headerlink" title="添加动态路由"></a>添加动态路由</h3><p>创建permission模块, vuex/modules/permission.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; asyncRoutes, constRoutes &#125; <span class="keyword">from</span> <span class="string">"@/router"</span>;</span><br><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">    routes: [], <span class="comment">// 完整路由表</span></span><br><span class="line">    addRoutes: [] <span class="comment">// 用户可访问路由表</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> mutations = &#123;</span><br><span class="line">    SET_ROUTES: <span class="function">(<span class="params">state, routes</span>) =&gt;</span> &#123;</span><br><span class="line">        state.addRoutes = routes;</span><br><span class="line">        state.routes = constRoutes.concat(routes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> actions = &#123;</span><br><span class="line">    <span class="comment">// 路由生成:在得到用户角色后会第一时间调用</span></span><br><span class="line">    generateRoutes(&#123; commit &#125;, roles) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 根据角色做过滤处理</span></span><br><span class="line">            <span class="keyword">const</span> accessedRoutes = filterAsyncRoutes(asyncRoutes, roles);;</span><br><span class="line">            commit(<span class="string">"SET_ROUTES"</span>, accessedRoutes);</span><br><span class="line">            resolve(accessedRoutes);</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">filterAsyncRoutes</span>(<span class="params">routes, roles</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> res = [];</span><br><span class="line">    routes.forEach(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 复制一份</span></span><br><span class="line">        <span class="keyword">const</span> tmp = &#123; ...route &#125;;</span><br><span class="line">        <span class="comment">// 如果用户有访问权则加入结果路由表</span></span><br><span class="line">        <span class="keyword">if</span> (hasPermission(roles, tmp)) &#123;</span><br><span class="line">            <span class="comment">// 如果存在子路由则递归过滤之</span></span><br><span class="line">            <span class="keyword">if</span> (tmp.children) &#123;</span><br><span class="line">                tmp.children = filterAsyncRoutes(tmp.children, roles);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            res.push(tmp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hasPermission</span>(<span class="params">roles, route</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 如果当前路由有roles字段则需判断用户访问权限</span></span><br><span class="line">    <span class="keyword">if</span> (route.meta &amp;&amp; route.meta.roles) &#123;</span><br><span class="line">        <span class="comment">// 若用户拥有的角色中有被包含在待判定路由角色表中的则拥有访问权</span></span><br><span class="line">        <span class="keyword">return</span> roles.some(<span class="function"><span class="params">role</span> =&gt;</span> route.meta.roles.includes(role));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 没有设置roles则无需判定即可访问</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    namespaced: <span class="literal">true</span>,</span><br><span class="line">    state,</span><br><span class="line">    mutations,</span><br><span class="line">    actions</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>调用路由生成逻辑, ./permission.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据当前用户角色动态生成路由</span></span><br><span class="line"><span class="keyword">const</span> accessRoutes = <span class="keyword">await</span> store.dispatch(<span class="string">'permission/generateRoutes'</span>, roles)</span><br><span class="line"><span class="comment">// 添加这些路由至路由器</span></span><br><span class="line">router.addRoutes(accessRoutes)</span><br><span class="line"><span class="comment">// 继续路由切换,确保addRoutes完成</span></span><br><span class="line">next(&#123; ...to, <span class="attr">replace</span>: <span class="literal">true</span> &#125;)</span><br></pre></td></tr></table></figure>

<p>异步从服务端获取的路由表</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 前端组件名和组件映射表</span></span><br><span class="line"><span class="keyword">const</span> map = &#123;</span><br><span class="line">    login: <span class="built_in">require</span>(<span class="string">'login/index'</span>).default <span class="comment">// 同步的方式</span></span><br><span class="line">    <span class="comment">// login: () =&gt; import('login/index')      // 异步的方式</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 服务端返回的map类似于</span></span><br><span class="line"><span class="keyword">const</span> serviceMap = [</span><br><span class="line">    &#123; <span class="attr">path</span>: <span class="string">'/login'</span>, <span class="attr">component</span>: <span class="string">'login'</span>, <span class="attr">hidden</span>: <span class="literal">true</span> &#125;</span><br><span class="line">]</span><br><span class="line"><span class="comment">// 遍历serviceMap,将component替换为map[component],动态生成asyncRoutes</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapComponent</span>(<span class="params">route</span>) </span>&#123;</span><br><span class="line">    route.component = serviceMap[route.component];</span><br><span class="line">    <span class="keyword">if</span> (route.children) &#123;</span><br><span class="line">        route.children = route.children.map(<span class="function"><span class="params">child</span> =&gt;</span> mapComponent(child))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> route</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="按钮权限"><a href="#按钮权限" class="headerlink" title="按钮权限"></a>按钮权限</h4><p>封装一个指令v-permission, 从而实现按钮级别的权限控制, src/directive/permission.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">"@/store"</span>;</span><br><span class="line"><span class="keyword">const</span> permission = &#123;</span><br><span class="line">    inserted(el, binding) &#123;</span><br><span class="line">        <span class="comment">// 获取指令的值:按钮要求的角色数组</span></span><br><span class="line">        <span class="keyword">const</span> &#123; <span class="attr">value</span>: pRoles &#125; = binding;</span><br><span class="line">        <span class="comment">// 获取用户角色</span></span><br><span class="line">        <span class="keyword">const</span> roles = store.getters &amp;&amp; store.getters.roles;</span><br><span class="line">        <span class="keyword">if</span> (pRoles &amp;&amp; pRoles <span class="keyword">instanceof</span> <span class="built_in">Array</span> &amp;&amp; pRoles.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 判断用户角色中是否有按钮要求的角色</span></span><br><span class="line">            <span class="keyword">const</span> hasPermission = roles.some(<span class="function"><span class="params">role</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> pRoles.includes(role);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 如果没有权限则删除当前dom</span></span><br><span class="line">            <span class="keyword">if</span> (!hasPermission) &#123;</span><br><span class="line">                el.parentNode &amp;&amp; el.parentNode.removeChild(el);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`需要指定按钮要求角色数组,如v-permission="['admin','editor']"`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> permission;</span><br></pre></td></tr></table></figure>

<p>注册指令, main.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> vPermission <span class="keyword">from</span> <span class="string">"./directive/permission"</span>;</span><br><span class="line">Vue.directive(<span class="string">"permission"</span>, vPermission);</span><br></pre></td></tr></table></figure>

<p>该指令只能删除挂载指令的元素,对于那些额外生成的和指令无关的元素无能为力,比如:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-tabs</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">el-tab-pane</span> <span class="attr">label</span>=<span class="string">"用户管理"</span> <span class="attr">name</span>=<span class="string">"first"</span> <span class="attr">v-permission</span>=<span class="string">"['admin','editor']"</span>&gt;</span>用户管理<span class="tag">&lt;/<span class="name">el-tab-pane</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">el-tab-pane</span> <span class="attr">label</span>=<span class="string">"配置管理"</span> <span class="attr">name</span>=<span class="string">"second"</span> <span class="attr">v-permission</span>=<span class="string">"['admin','editor']"</span>&gt;</span>配置管理<span class="tag">&lt;/<span class="name">el-tab-pane</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">el-tab-pane</span> <span class="attr">label</span>=<span class="string">"角色管理"</span> <span class="attr">name</span>=<span class="string">"third"</span> <span class="attr">v-permission</span>=<span class="string">"['admin']"</span>&gt;</span>角色管理<span class="tag">&lt;/<span class="name">el-tab-pane</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">el-tab-pane</span> <span class="attr">label</span>=<span class="string">"定时任务补偿"</span> <span class="attr">name</span>=<span class="string">"fourth"</span> <span class="attr">v-permission</span>=<span class="string">"['admin', 'editor']"</span>&gt;</span>定时任务补偿<span class="tag">&lt;/<span class="name">el-tab-pane</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">el-tabs</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>用v-if实现:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-tab-pane</span> <span class="attr">v-if</span>=<span class="string">"checkPermission(['admin'])"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">    methods: &#123;</span><br><span class="line">        checkPermission(permissionRoles) &#123;</span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> roles.some(<span class="function"><span class="params">role</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> permissionRoles.includes(role);</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>自定义指令参考: <a href="https://cn.vuejs.org/v2/guide/custom-directive.html" target="_blank" rel="noopener">https://cn.vuejs.org/v2/guide/custom-directive.html</a></p>
<h3 id="导航菜单生成"><a href="#导航菜单生成" class="headerlink" title="导航菜单生成"></a>导航菜单生成</h3><p>sideMenu/index.vue</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 2.遍历permission_routes --&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 传递base-path是由于子路由是相对地址 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">:model</span>=<span class="string">"route"</span> <span class="attr">v-for</span>=<span class="string">"route in permission_routes"</span> <span class="attr">:key</span>=<span class="string">"route.path"</span> <span class="attr">:base-path</span>=<span class="string">"route.path"</span>&gt;</span><span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">import</span> &#123; mapGetters &#125; <span class="keyword">from</span> <span class="string">"vuex"</span>;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">import</span> Item <span class="keyword">from</span> <span class="string">"./Item"</span>; <span class="comment">// 修改引入</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">        components: &#123; Item &#125;,</span><br><span class="line">        computed: &#123;</span><br><span class="line"><span class="javascript">            ...mapGetters([<span class="string">"permission_routes"</span>])</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Item.vue改造</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1.hidden存在则不显示 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-if</span>=<span class="string">"!model.hidden"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> @<span class="attr">click</span>=<span class="string">"toggle"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 2.设置icon才显示图标 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">svg-icon</span> <span class="attr">v-if</span>=<span class="string">"hasIcon"</span> <span class="attr">:icon-class</span>=<span class="string">"model.meta.icon"</span>&gt;</span><span class="tag">&lt;/<span class="name">svg-icon</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">v-if</span>=<span class="string">"isFolder"</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 3.设置标题才显示 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">v-if</span>=<span class="string">"hasTitle"</span>&gt;</span>&#123;&#123;model.meta.title&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                [&#123;&#123;open ? '-' : '+'&#125;&#125;]</span><br><span class="line">            <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 4.如果是叶子节点,显示为链接 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-else</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">:to</span>=<span class="string">"resolvePath(model.path)"</span>&gt;</span>&#123;&#123;title&#125;&#125;<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 5.子树设置base-path --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">v-show</span>=<span class="string">"open"</span> <span class="attr">v-if</span>=<span class="string">"isFolder"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">class</span>=<span class="string">"item"</span> <span class="attr">v-for</span>=<span class="string">"route in model.children"</span> <span class="attr">:model</span>=<span class="string">"route"</span> <span class="attr">:key</span>=<span class="string">"route.path"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">:base-path</span>=<span class="string">"resolvePath(model.path)"</span>&gt;</span><span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="comment">// resolvePath方法需要用到path库</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">'path'</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">        name: <span class="string">"Item"</span>,</span></span><br><span class="line">        props: &#123;</span><br><span class="line"><span class="javascript">            <span class="comment">// 新增basePath保存父路由path</span></span></span><br><span class="line">            basePath: &#123;</span><br><span class="line"><span class="javascript">                type: <span class="built_in">String</span>,</span></span><br><span class="line"><span class="javascript">                <span class="keyword">default</span>: <span class="string">''</span></span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        computed: &#123;</span><br><span class="line"><span class="javascript">            hasIcon() &#123; <span class="keyword">return</span> <span class="keyword">this</span>.model.meta &amp;&amp; <span class="keyword">this</span>.model.meta.icon &#125;,</span></span><br><span class="line"><span class="javascript">            hasTitle() &#123; <span class="keyword">return</span> <span class="keyword">this</span>.model.meta &amp;&amp; <span class="keyword">this</span>.model.meta.title &#125;,</span></span><br><span class="line">            title() &#123;</span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> <span class="keyword">this</span>.hasTitle</span></span><br><span class="line"><span class="javascript">                    ? <span class="keyword">this</span>.model.meta.title</span></span><br><span class="line"><span class="javascript">                    : <span class="keyword">this</span>.model.name</span></span><br><span class="line"><span class="javascript">                        ? <span class="keyword">this</span>.model.name</span></span><br><span class="line"><span class="javascript">                        : <span class="keyword">this</span>.model.path;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line"><span class="javascript">            <span class="comment">// 拼接子路由完整path</span></span></span><br><span class="line">            resolvePath(routePath) &#123;</span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> path.resolve(<span class="keyword">this</span>.basePath, routePath)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="利用element做一个更高规格的导航菜单"><a href="#利用element做一个更高规格的导航菜单" class="headerlink" title="利用element做一个更高规格的导航菜单"></a>利用element做一个更高规格的导航菜单</h4><p>创建侧边栏组件, components/sidebar/index.vue</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">el-scrollbar</span> <span class="attr">wrap-class</span>=<span class="string">"scrollbar-wrapper"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">el-menu</span> <span class="attr">:default-active</span>=<span class="string">"activeMenu"</span> <span class="attr">:background-color</span>=<span class="string">"variables.menuBg"</span> <span class="attr">:text-color</span>=<span class="string">"variables.menuText"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">:unique-opened</span>=<span class="string">"false"</span> <span class="attr">:active-text-color</span>=<span class="string">"variables.menuActiveText"</span> <span class="attr">:collapse-transition</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">mode</span>=<span class="string">"vertical"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">sidebar-item</span> <span class="attr">v-for</span>=<span class="string">"route in permission_routes"</span> <span class="attr">:key</span>=<span class="string">"route.path"</span> <span class="attr">:item</span>=<span class="string">"route"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">:base-path</span>=<span class="string">"route.path"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">el-menu</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">el-scrollbar</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">import</span> &#123; mapGetters &#125; <span class="keyword">from</span> <span class="string">"vuex"</span>;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">import</span> SidebarItem <span class="keyword">from</span> <span class="string">"./SidebarItem"</span>;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">        components: &#123; SidebarItem &#125;,</span><br><span class="line">        computed: &#123;</span><br><span class="line"><span class="javascript">            ...mapGetters([<span class="string">"permission_routes"</span>]),</span></span><br><span class="line">            activeMenu() &#123;</span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> route = <span class="keyword">this</span>.$route;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> &#123; meta, path &#125; = route;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 默认激活项</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (meta.activeMenu) &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">return</span> meta.activeMenu;</span></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> path;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            variables() &#123;</span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">                    menuText: <span class="string">"#bfcbd9"</span>,</span></span><br><span class="line"><span class="javascript">                    menuActiveText: <span class="string">"#409EFF"</span>,</span></span><br><span class="line"><span class="javascript">                    menuBg: <span class="string">"#304156"</span></span></span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建 侧边栏项目组件, layout/components/sidebar/sidebarItem.vue</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"!item.hidden"</span> <span class="attr">class</span>=<span class="string">"menu-wrapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-if</span>=<span class="string">"hasOneShowingChild(item.children,item) &amp;&amp; (!onlyOneChild.children||onlyOneChild.noShowingChildren)&amp;&amp;!item.alwaysShow"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">v-if</span>=<span class="string">"onlyOneChild.meta"</span> <span class="attr">:to</span>=<span class="string">"resolvePath(onlyOneChild.path)"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">el-menu-item</span> <span class="attr">:index</span>=<span class="string">"resolvePath(onlyOneChild.path)"</span> <span class="attr">:class</span>=<span class="string">"&#123;'submenu-title-noDropdown':!isNest&#125;"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">item</span> <span class="attr">:icon</span>=<span class="string">"onlyOneChild.meta.icon||(item.meta&amp;&amp;item.meta.icon)"</span> <span class="attr">:title</span>=<span class="string">"onlyOneChild.meta.title"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">el-menu-item</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">el-submenu</span> <span class="attr">v-else</span> <span class="attr">ref</span>=<span class="string">"subMenu"</span> <span class="attr">:index</span>=<span class="string">"resolvePath(item.path)"</span> <span class="attr">popper-</span> <span class="attr">append-to-body</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-slot:title</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">item</span> <span class="attr">v-if</span>=<span class="string">"item.meta"</span> <span class="attr">:icon</span>=<span class="string">"item.meta &amp;&amp; item.meta.icon"</span> <span class="attr">:title</span>=<span class="string">"item.meta.title"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">sidebar-item</span> <span class="attr">v-for</span>=<span class="string">"child in item.children"</span> <span class="attr">:key</span>=<span class="string">"child.path"</span> <span class="attr">:is-nest</span>=<span class="string">"true"</span> <span class="attr">:item</span>=<span class="string">"child"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">:base-path</span>=<span class="string">"resolvePath(child.path)"</span> <span class="attr">class</span>=<span class="string">"nest-menu"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">el-submenu</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">'path'</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">import</span> Item <span class="keyword">from</span> <span class="string">'./Item'</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">        name: <span class="string">'SidebarItem'</span>,</span></span><br><span class="line">        components: &#123; Item &#125;,</span><br><span class="line">        props: &#123;</span><br><span class="line"><span class="javascript">            <span class="comment">// route object</span></span></span><br><span class="line">            item: &#123;</span><br><span class="line"><span class="javascript">                type: <span class="built_in">Object</span>,</span></span><br><span class="line"><span class="javascript">                required: <span class="literal">true</span></span></span><br><span class="line"></span><br><span class="line">            &#125;,</span><br><span class="line">            isNest: &#123;</span><br><span class="line"><span class="javascript">                type: <span class="built_in">Boolean</span>,</span></span><br><span class="line"><span class="javascript">                <span class="keyword">default</span>: <span class="literal">false</span></span></span><br><span class="line"></span><br><span class="line">            &#125;,</span><br><span class="line">            basePath: &#123;</span><br><span class="line"><span class="javascript">                type: <span class="built_in">String</span>,</span></span><br><span class="line"><span class="javascript">                <span class="keyword">default</span>: <span class="string">''</span></span></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        data() &#123;</span><br><span class="line"><span class="javascript">            <span class="keyword">this</span>.onlyOneChild = <span class="literal">null</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> &#123;&#125;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line">            hasOneShowingChild(children = [], parent) &#123;</span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> showingChildren = children.filter(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">if</span> (item.hidden) &#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">return</span> <span class="literal">false</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">                    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">                        <span class="comment">// 如果只有一个子菜单时设置</span></span></span><br><span class="line"><span class="javascript">                        <span class="keyword">this</span>.onlyOneChild = item</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">return</span> <span class="literal">true</span></span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line"><span class="javascript">                <span class="comment">// 当只有一个子路由,该子路由默认显示</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (showingChildren.length === <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">return</span> <span class="literal">true</span></span></span><br><span class="line">                &#125;</span><br><span class="line"><span class="javascript">                <span class="comment">// 没有子路由则显示父路由</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (showingChildren.length === <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">this</span>.onlyOneChild = &#123; ...parent, <span class="attr">path</span>: <span class="string">''</span>, <span class="attr">noShowingChildren</span>: <span class="literal">true</span> &#125;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">return</span> <span class="literal">true</span></span></span><br><span class="line">                &#125;</span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> <span class="literal">false</span></span></span><br><span class="line">            &#125;,</span><br><span class="line">            resolvePath(routePath) &#123;</span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> path.resolve(<span class="keyword">this</span>.basePath, routePath)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建侧边栏菜单项组件, layout/components/sidebar/Item.vue</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">        name: <span class="string">'MenuItem'</span>,</span></span><br><span class="line"><span class="javascript">        functional: <span class="literal">true</span>,</span></span><br><span class="line">        props: &#123;</span><br><span class="line">            icon: &#123;</span><br><span class="line"><span class="javascript">                type: <span class="built_in">String</span>,</span></span><br><span class="line"><span class="javascript">                <span class="keyword">default</span>: <span class="string">''</span></span></span><br><span class="line">            &#125;,</span><br><span class="line">            title: &#123;</span><br><span class="line"><span class="javascript">                type: <span class="built_in">String</span>,</span></span><br><span class="line"><span class="javascript">                <span class="keyword">default</span>: <span class="string">''</span></span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        render(h, context) &#123;</span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> &#123; icon, title &#125; = context.props</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> vnodes = []</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> (icon) &#123;</span></span><br><span class="line"><span class="javascript">                vnodes.push(<span class="xml"><span class="tag">&lt;<span class="name">svg-icon</span> <span class="attr">icon-class</span>=<span class="string">&#123;icon&#125;</span> /&gt;</span>)</span></span></span><br><span class="line">            &#125;</span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> (title) &#123;</span></span><br><span class="line"><span class="javascript">                vnodes.push(<span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">slot</span>=<span class="string">'title'</span>&gt;</span>&#123;(title)&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>)</span></span><br><span class="line">            &#125;</span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> vnodes</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试: layout/index.vue中添加sidebar</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">import</span> Sidebar <span class="keyword">from</span> <span class="string">'@/components/sidebar'</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">        components: &#123;</span><br><span class="line">            Sidebar</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="面包屑导航"><a href="#面包屑导航" class="headerlink" title="面包屑导航"></a>面包屑导航</h3><p>面包屑导航通过$route.matched数组动态生成的.</p>
<p>简版实现, 创建./components/Bread.vue</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">v-for</span>=<span class="string">"(item, idx) in items"</span> <span class="attr">:key</span>=<span class="string">"item.path"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 最后一项时只显示文本 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">v-if</span>=<span class="string">"idx === items.length - 1"</span>&gt;</span>&#123;&#123;item.meta.title&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 否则显示超链接 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">v-else</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">:to</span>=<span class="string">"item"</span>&gt;</span>&#123;&#123;item.meta.title&#125;&#125;<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">        computed: &#123;</span><br><span class="line">            items() &#123;</span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="keyword">this</span>.$route.matched);</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 根据matched数组获取面包屑数组</span></span></span><br><span class="line"><span class="javascript">                <span class="comment">// 要求必须有title且breadcrumb不为false</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> <span class="keyword">this</span>.$route.matched.filter(</span></span><br><span class="line"><span class="javascript">                    item =&gt; item.meta &amp;&amp; item.meta.title &amp;&amp; item.meta.breadcrumb !== <span class="literal">false</span></span></span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建Breadcrumb, ./components/Breadcrumb.vue</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-breadcrumb</span> <span class="attr">class</span>=<span class="string">"app-breadcrumb"</span> <span class="attr">separator</span>=<span class="string">"/"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transition-group</span> <span class="attr">name</span>=<span class="string">"breadcrumb"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">el-breadcrumb-item</span> <span class="attr">v-for</span>=<span class="string">"(item,index) in levelList"</span> <span class="attr">:key</span>=<span class="string">"item.path"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">v-if</span>=<span class="string">"item.redirect==='noRedirect'||index==levelList.length-1"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">class</span>=<span class="string">"no-redirect"</span>&gt;</span>&#123;&#123; item.meta.title &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">v-else</span> @<span class="attr">click.prevent</span>=<span class="string">"handleLink(item)"</span>&gt;</span>&#123;&#123; item.meta.title &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">el-breadcrumb-item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">transition-group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-breadcrumb</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">import</span> pathToRegexp <span class="keyword">from</span> <span class="string">"path-to-regexp"</span>;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">        data() &#123;</span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">                levelList: <span class="literal">null</span></span></span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;,</span><br><span class="line">        watch: &#123;</span><br><span class="line">            $route: &#123;</span><br><span class="line">                handler(route) &#123;</span><br><span class="line"><span class="javascript">                    <span class="keyword">this</span>.getBreadcrumb();</span></span><br><span class="line">                &#125;,</span><br><span class="line"><span class="javascript">                immediate: <span class="literal">true</span></span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line">            getBreadcrumb() &#123;</span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="keyword">this</span>.$route.matched);</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 面包屑仅显示包含meta.title且item.meta.breadcrumb不为false的路由</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> matched = <span class="keyword">this</span>.$route.matched.filter(</span></span><br><span class="line"><span class="javascript">                    item =&gt; item.meta &amp;&amp; item.meta.title &amp;&amp; item.meta.breadcrumb !== <span class="literal">false</span></span></span><br><span class="line">                );</span><br><span class="line"><span class="javascript">                <span class="comment">// 根路由</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> first = matched[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 根匹配只要不是home,就作为home下一级</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (!<span class="keyword">this</span>.isHome(first)) &#123;</span></span><br><span class="line">                    matched = [&#123;</span><br><span class="line"><span class="javascript">                        path: <span class="string">'/'</span>, <span class="attr">redirect</span>: <span class="string">"/home"</span>, <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">"首页"</span> &#125;</span></span><br><span class="line">                    &#125;].concat(matched);</span><br><span class="line">                &#125;</span><br><span class="line"><span class="javascript">                <span class="comment">// 处理完指定到levelList</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">this</span>.levelList = matched</span></span><br><span class="line">            &#125;,</span><br><span class="line">            isHome(route) &#123;</span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> name = route &amp;&amp; route.name;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (!name) &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line">                &#125;</span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> name.trim().toLocaleLowerCase() === <span class="string">"home"</span>.toLocaleLowerCase();</span></span><br><span class="line">            &#125;,</span><br><span class="line">            pathCompile(path) &#123;</span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> &#123; params &#125; = <span class="keyword">this</span>.$route;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> toPath = pathToRegexp.compile(path);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> toPath(params);</span></span><br><span class="line">            &#125;,</span><br><span class="line">            handleLink(item) &#123;</span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> &#123; redirect, path &#125; = item;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 若存在重定向,按重定向走</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (redirect) &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">this</span>.$router.push(redirect);</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">return</span>;</span></span><br><span class="line">                &#125;</span><br><span class="line"><span class="javascript">                <span class="comment">// 编译path,避免存在路径参数</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">this</span>.$router.push(<span class="keyword">this</span>.pathCompile(path));</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span></span><br><span class="line"><span class="css">    <span class="selector-class">.app-breadcrumb</span><span class="selector-class">.el-breadcrumb</span> &#123;</span></span><br><span class="line">        display: inline-block;</span><br><span class="line">        font-size: 14px;</span><br><span class="line">        line-height: 50px;</span><br><span class="line">        margin-left: 8px;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="css">    <span class="selector-class">.app-breadcrumb</span><span class="selector-class">.el-breadcrumb</span> <span class="selector-class">.no-redirect</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">color</span>: <span class="selector-id">#97a8be</span>;</span></span><br><span class="line">        cursor: text;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="css">    <span class="comment">/* breadcrumb transition */</span></span></span><br><span class="line"><span class="css">    <span class="selector-class">.breadcrumb-enter-active</span>,</span></span><br><span class="line"><span class="css">    <span class="selector-class">.breadcrumb-leave-active</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">transition</span>: <span class="selector-tag">all</span> <span class="selector-class">.5s</span>;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="css">    <span class="selector-class">.breadcrumb-enter</span>,</span></span><br><span class="line"><span class="css">    <span class="selector-class">.breadcrumb-leave-active</span> &#123;</span></span><br><span class="line">        opacity: 0;</span><br><span class="line">        transform: translateX(20px);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="css">    <span class="selector-class">.breadcrumb-move</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">transition</span>: <span class="selector-tag">all</span> <span class="selector-class">.5s</span>;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="css">    <span class="selector-class">.breadcrumb-leave-active</span> &#123;</span></span><br><span class="line">        position: absolute;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="数据交互"><a href="#数据交互" class="headerlink" title="数据交互"></a>数据交互</h3><p>数据交互流程:<br>api service =&gt; requrest =&gt; local mock/esay-mock/server api</p>
<p>可能出现的问题分析:</p>
<ol>
<li>有时需要对请求头,响应进行统一预处理</li>
<li>请求不同数据源时url会变化, 需要能根据环境自动修改url</li>
<li>可能出现跨域的问题</li>
</ol>
<h4 id="封装request"><a href="#封装request" class="headerlink" title="封装request"></a>封装request</h4><p>解决前两个问题需要统一封装请求代码.</p>
<p>安装axios</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i axios -S</span><br></pre></td></tr></table></figure>

<p>创建 @/utils/request.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">"axios"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MessageBox, Message &#125; <span class="keyword">from</span> <span class="string">"element-ui"</span>;</span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">"@/store"</span>;</span><br><span class="line"><span class="comment">// 创建axios实例</span></span><br><span class="line"><span class="keyword">const</span> service = axios.create(&#123;</span><br><span class="line">    baseURL: process.env.VUE_APP_BASE_API, <span class="comment">// url基础地址,解决不同数据源url变化问题</span></span><br><span class="line">    <span class="comment">// withCredentials: true, // 跨域时若要发送cookies需设置该选项</span></span><br><span class="line">    timeout: <span class="number">5000</span> <span class="comment">// 超时</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 请求拦截</span></span><br><span class="line">service.interceptors.request.use(</span><br><span class="line">    config =&gt; &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">        <span class="keyword">const</span> token = localStorage.getItem(<span class="string">'token'</span>)</span><br><span class="line">        <span class="keyword">if</span> (token) &#123;</span><br><span class="line">            <span class="comment">// 设置令牌请求头</span></span><br><span class="line">            config.headers[<span class="string">"Authorization"</span>] = <span class="string">'Bearer '</span> + token;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;,</span><br><span class="line">    error =&gt; &#123;</span><br><span class="line">        <span class="comment">// 请求错误预处理</span></span><br><span class="line">        <span class="comment">//console.log(error) // for debug</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 响应拦截</span></span><br><span class="line">service.interceptors.response.use(</span><br><span class="line">    <span class="comment">// 通过自定义code判定响应状态,也可以通过HTTP状态码判定</span></span><br><span class="line">    response =&gt; &#123;</span><br><span class="line">        <span class="comment">// 仅返回数据部分</span></span><br><span class="line">        <span class="keyword">const</span> res = response.data;</span><br><span class="line">        <span class="comment">// code不为1则判定为一个错误</span></span><br><span class="line">        <span class="keyword">if</span> (res.code !== <span class="number">1</span>) &#123;</span><br><span class="line">            Message(&#123;</span><br><span class="line">                message: res.message || <span class="string">"Error"</span>,</span><br><span class="line">                type: <span class="string">"error"</span>,</span><br><span class="line">                duration: <span class="number">5</span> * <span class="number">1000</span></span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 假设:10008-非法令牌; 10012-其他客户端已登录; 10014-令牌过期;</span></span><br><span class="line">            <span class="keyword">if</span> (res.code === <span class="number">10008</span> || res.code === <span class="number">10012</span> || res.code === <span class="number">10014</span>) &#123;</span><br><span class="line">                <span class="comment">// 重新登录</span></span><br><span class="line">                MessageBox.confirm(</span><br><span class="line">                    <span class="string">"登录状态异常,请重新登录"</span>,</span><br><span class="line">                    <span class="string">"确认登录信息"</span>,</span><br><span class="line"></span><br><span class="line">                    &#123;</span><br><span class="line">                        confirmButtonText: <span class="string">"重新登录"</span>,</span><br><span class="line">                        cancelButtonText: <span class="string">"取消"</span>,</span><br><span class="line">                        type: <span class="string">"warning"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    store.dispatch(<span class="string">"user/resetToken"</span>).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                        location.reload();</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(res.message || <span class="string">"Error"</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    error =&gt; &#123;</span><br><span class="line">        <span class="comment">//console.log("err" + error); // for debug</span></span><br><span class="line">        Message(&#123;</span><br><span class="line">            message: error.message,</span><br><span class="line">            type: <span class="string">"error"</span>,</span><br><span class="line">            duration: <span class="number">5</span> * <span class="number">1000</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> service;</span><br></pre></td></tr></table></figure>

<p>设置VUE_APP_BASE_API环境变量, 创建.env.development文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># base api</span></span><br><span class="line">VUE_APP_BASE_API = <span class="string">'/dev-api'</span></span><br></pre></td></tr></table></figure>

<p>Vue下的环境变量和模式: <a href="https://cli.vuejs.org/zh/guide/mode-and-env.html#%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener">https://cli.vuejs.org/zh/guide/mode-and-env.html#%E6%A8%A1%E5%BC%8F</a></p>
<p>测试代码, 创建@/api/user.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">'@/utils/request'</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> request(&#123;</span><br><span class="line">        url: <span class="string">'/user/login'</span>,</span><br><span class="line">        method: <span class="string">'post'</span>,</span><br><span class="line">        data</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> request(&#123;</span><br><span class="line">        url: <span class="string">'/user/info'</span>,</span><br><span class="line">        method: <span class="string">'get'</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="mock数据"><a href="#mock数据" class="headerlink" title="mock数据"></a>mock数据</h4><p>数据模拟的两种常见的方式, 本地mock和线上easy-mock<br>本地mock: 修改vue.config.js, 给devServer添加相关代码<br>post请求需要额外安装依赖:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i body-parser -D</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">"body-parser"</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        before: <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">            app.use(bodyParser.json());</span><br><span class="line">            app.use(</span><br><span class="line">                bodyParser.urlencoded(&#123;</span><br><span class="line">                    extended: <span class="literal">true</span></span><br><span class="line">                &#125;)</span><br><span class="line">            );</span><br><span class="line">            app.post(<span class="string">"/dev-api/user/login"</span>, (req, res) =&gt; &#123;</span><br><span class="line">                <span class="keyword">const</span> &#123; username &#125; = req.body;</span><br><span class="line">                <span class="keyword">if</span> (username === <span class="string">"admin"</span> || username === <span class="string">"jerry"</span>) &#123;</span><br><span class="line">                    res.json(&#123;</span><br><span class="line">                        code: <span class="number">1</span>,</span><br><span class="line">                        data: username</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    res.json(&#123;</span><br><span class="line">                        code: <span class="number">10204</span>,</span><br><span class="line">                        message: <span class="string">"用户名或密码错误"</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            app.get(<span class="string">"/dev-api/user/info"</span>, (req, res) =&gt; &#123;</span><br><span class="line">                <span class="keyword">const</span> auth = req.headers[<span class="string">"authorization"</span>];</span><br><span class="line">                <span class="keyword">const</span> roles = auth.split(<span class="string">' '</span>)[<span class="number">1</span>] === <span class="string">"admin"</span> ? [<span class="string">"admin"</span>] : [<span class="string">"editor"</span>];</span><br><span class="line">                res.json(&#123;</span><br><span class="line">                    code: <span class="number">1</span>,</span><br><span class="line">                    data: roles</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>调用接口, @/vuex/modules/user.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; login, getInfo &#125; <span class="keyword">from</span> <span class="string">'@/api/user'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; login, getInfo &#125; <span class="keyword">from</span> <span class="string">'@/api/user'</span>;</span><br><span class="line"><span class="keyword">const</span> actions = &#123;</span><br><span class="line">    login(&#123; commit &#125;, userInfo) &#123;</span><br><span class="line">        <span class="comment">// 调用并处理结果,错误处理已拦截无需处理</span></span><br><span class="line">        <span class="keyword">return</span> login(userInfo).then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">            commit(<span class="string">"SET_TOKEN"</span>, res.data);</span><br><span class="line">            localStorage.setItem(<span class="string">"token"</span>, res.data);</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// ...之前代码不需要了</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// get user info</span></span><br><span class="line">    getInfo(&#123; commit, state &#125;) &#123;</span><br><span class="line">        <span class="keyword">return</span> getInfo(state.token).then(<span class="function">(<span class="params">&#123; data: roles &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">            commit(<span class="string">"SET_ROLES"</span>, roles);</span><br><span class="line">            <span class="keyword">return</span> &#123; roles &#125;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// ...之前代码不需要了</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="easy-mock"><a href="#easy-mock" class="headerlink" title="easy-mock"></a>easy-mock</h4><p>使用步骤:</p>
<ol>
<li><p>登录easy-mock: <a href="http://easy-mock.com/" target="_blank" rel="noopener">http://easy-mock.com/</a></p>
</li>
<li><p>创建一个项目</p>
</li>
<li><p>创建需要的接口</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/login</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"code"</span>: <span class="function"><span class="keyword">function</span>(<span class="params">&#123;_req&#125;</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; username &#125; = _req.body;</span><br><span class="line">        <span class="keyword">if</span> (username === <span class="string">"admin"</span> || username === <span class="string">"jerry"</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">10008</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"data"</span>: <span class="function"><span class="keyword">function</span>(<span class="params">&#123;_req&#125;</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; username &#125; = _req.body;</span><br><span class="line">        <span class="keyword">if</span> (username === <span class="string">"admin"</span> || username === <span class="string">"jerry"</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> username</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// user/info</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"code"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"data"</span>: <span class="function"><span class="keyword">function</span>(<span class="params">&#123;_req&#125;</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _req.headers[<span class="string">'authorization'</span>].split(<span class="string">' '</span>)[<span class="number">1</span>] === <span class="string">'admin'</span> ? [<span class="string">'admin'</span>] : [<span class="string">'editor'</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用: 修改base_url, .env.development</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VUE_APP_BASE_API = <span class="string">'https://easy-mock.com/mock/5cdcc3fdde625c6ccadfd70c/xxx-project'</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="解决跨域问题"><a href="#解决跨域问题" class="headerlink" title="解决跨域问题"></a>解决跨域问题</h4><p>如果请求的接口在另一台服务器上, 开发时则需要设置代理避免跨域问题:</p>
<p>方法一:添加代理配置, vue.config.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        port: port,</span><br><span class="line">        proxy: &#123;</span><br><span class="line">            <span class="comment">// 代理 /dev-api/user/login 到 http://127.0.0.1:3000/user/login</span></span><br><span class="line">            [process.env.VUE_APP_BASE_API]: &#123;</span><br><span class="line">                target: <span class="string">`http://127.0.0.1:3000/`</span>,</span><br><span class="line">                changeOrigin: <span class="literal">true</span>,</span><br><span class="line">                pathRewrite: &#123; [<span class="string">"^"</span> + process.env.VUE_APP_BASE_API]: <span class="string">""</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法二: 创建一个独立的接口服务器, ~/test-server/index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">"body-parser"</span>);</span><br><span class="line">app.use(bodyParser.json());</span><br><span class="line">app.use(</span><br><span class="line">    bodyParser.urlencoded(&#123;</span><br><span class="line">        extended: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">);</span><br><span class="line">app.post(<span class="string">"/user/login"</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; username &#125; = req.body;</span><br><span class="line">    <span class="keyword">if</span> (username === <span class="string">"admin"</span> || username === <span class="string">"jerry"</span>) &#123;</span><br><span class="line">        res.json(&#123;</span><br><span class="line">            code: <span class="number">1</span>,</span><br><span class="line">            data: username</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.json(&#123;</span><br><span class="line">            code: <span class="number">10204</span>,</span><br><span class="line">            message: <span class="string">"用户名或密码错误"</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">"/user/info"</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> roles = req.headers[<span class="string">'authorization'</span>].split(<span class="string">' '</span>)[<span class="number">1</span>] ? [<span class="string">"admin"</span>] :[<span class="string">"editor"</span>];</span><br><span class="line">    res.json(&#123;</span><br><span class="line">        code: <span class="number">1</span>,</span><br><span class="line">        data: roles</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/13/Vue项目最佳实践/" data-id="ckh44mzu600184sv2bd31r2pf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Vue源码分析三" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/22/Vue源码分析三/" class="article-date">
  <time datetime="2019-11-22T09:03:28.000Z" itemprop="datePublished">2019-11-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/22/Vue源码分析三/">Vue源码分析三</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="节点属性更新"><a href="#节点属性更新" class="headerlink" title="节点属性更新"></a>节点属性更新</h1><p>属性相关dom操作:将属性相关dom操作按hooks归类,在patchVnode时一起执行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义钩子数组</span></span><br><span class="line"><span class="keyword">const</span> hooks = [<span class="string">'create'</span>, <span class="string">'activate'</span>, <span class="string">'update'</span>, <span class="string">'remove'</span>, <span class="string">'destroy'</span>]</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createPatchFunction</span> (<span class="params">backend</span>) </span>&#123;</span><br><span class="line">   <span class="comment">// 平台特别节点操作、属性更新对象</span></span><br><span class="line">   <span class="keyword">const</span> &#123; modules, nodeOps &#125; = backend</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; hooks.length; ++i) &#123;</span><br><span class="line">       <span class="comment">// 指定到cbs对象上:cbs.create = []</span></span><br><span class="line">       cbs[hooks[i]] = []</span><br><span class="line">       <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; modules.length; ++j) &#123;</span><br><span class="line">           <span class="keyword">if</span> (isDef(modules[j][hooks[i]])) &#123;</span><br><span class="line">               <span class="comment">// 添加到相应数组中:</span></span><br><span class="line">               <span class="comment">// cbs.create = [fn1,fn2,...]</span></span><br><span class="line">               <span class="comment">// cbs.update = [fn1,fn2,...]</span></span><br><span class="line">               cbs[hooks[i]].push(modules[j][hooks[i]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">patchVnode</span> (<span class="params">...</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">if</span> (isDef(data) &amp;&amp; isPatchable(vnode)) &#123;</span><br><span class="line">            <span class="comment">// 执行默认的钩子</span></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.update.length; ++i) cbs.update[i](oldVnode, vnode)</span><br><span class="line">            <span class="comment">// 执行用户定义的钩子</span></span><br><span class="line">            <span class="keyword">if</span> (isDef(i = data.hook) &amp;&amp; isDef(i = i.update)) i(oldVnode, vnode)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="组件化机制"><a href="#组件化机制" class="headerlink" title="组件化机制"></a>组件化机制</h1><ol>
<li>先使用Vue.component()声明comp组件构造函数,会返回VueComponent实例，它是继承于Vue的。</li>
<li>然后全局配置选项中添加一个components：{comp: Comp}，这个组件就能被全局使用。</li>
<li>先创建父组件，再去挂载。顺序是创建从上往下，挂载从下往上。子组件全部挂载完之后，再去将一整个渲染出来。<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"demo"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Vue组件化机制<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">comp</span>&gt;</span><span class="tag">&lt;/<span class="name">comp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    Vue.component(<span class="string">'Comp'</span>, &#123;</span></span><br><span class="line"><span class="xml">       template: '<span class="tag">&lt;<span class="name">div</span>&gt;</span>I am comp<span class="tag">&lt;/<span class="name">div</span>&gt;</span>'</span></span><br><span class="line">    &#125;)</span><br><span class="line"><span class="javascript">    <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line">        components: &#123;</span><br><span class="line">            comp: Comp</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="组件声明"><a href="#组件声明" class="headerlink" title="组件声明"></a>组件声明</h2><h3 id="src-core-global-api-assets-js"><a href="#src-core-global-api-assets-js" class="headerlink" title="src/core/global-api/assets.js"></a>src/core/global-api/assets.js</h3><p>Vue.component()或者components选项<br>initAssetRegister(Vue)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initAssetRegisters</span> (<span class="params">Vue: GlobalAPI</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 'component', 'directive', 'filter'</span></span><br><span class="line">    ASSET_TYPES.forEach(<span class="function"><span class="params">type</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// Vue['component']</span></span><br><span class="line">        Vue[type] = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">            id: string,</span></span></span><br><span class="line"><span class="function"><span class="params">            definition: Function | Object</span></span></span><br><span class="line"><span class="function"><span class="params">        </span>): <span class="title">Function</span> | <span class="title">Object</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 组件注册</span></span><br><span class="line">            <span class="keyword">if</span> (type === <span class="string">'component'</span> &amp;&amp; isPlainObject(definition)) &#123;</span><br><span class="line">                definition.name = definition.name || id</span><br><span class="line">                <span class="comment">// 使用extend方法,将传入组件配置转换为构造函数VueComponent</span></span><br><span class="line">                definition = <span class="keyword">this</span>.options._base.extend(definition)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Vue.options['components']['comp'] = VueComponent</span></span><br><span class="line">            <span class="keyword">this</span>.options[type + <span class="string">'s'</span>][id] = definition</span><br><span class="line">            <span class="keyword">return</span> definition</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建根组件"><a href="#创建根组件" class="headerlink" title="创建根组件:"></a>创建根组件:</h2><p>首先创建的是根组件,首次_render()时,会得到整棵树的VNode结构.</p>
<p>_createElement src\core\vdom\create-element.js<br>_createElement实际执行VNode创建的函数,由于传入tag是非保留标签,因此判定为自定义组件通过createComponent去创建</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取tag对应的组件构造函数</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ((!data || !data.pre) &amp;&amp; isDef(Ctor = resolveAsset(context.$options,<span class="string">'components'</span>, tag))) &#123;</span><br><span class="line">    <span class="comment">// 使用createComponent创建vnode</span></span><br><span class="line">   vnode = createComponent(Ctor, data, context, children, tag)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="src-core-vdom-create-component-js"><a href="#src-core-vdom-create-component-js" class="headerlink" title="src/core/vdom/create-component.js"></a>src/core/vdom/create-component.js</h3><p>createComponent()<br>创建组件VNode,保存了上一步处理得到的组件构造函数,props,事件等</p>
<h3 id="core-vdom-patch-js"><a href="#core-vdom-patch-js" class="headerlink" title="core/vdom/patch.js"></a>core/vdom/patch.js</h3><p>创建自定义组件实例 createEle()<br>首次执行_update()时,patch()会通过createEle()创建根元素,子元素创建研究从这里开始</p>
<h3 id="core-vdom-patch-js-1"><a href="#core-vdom-patch-js-1" class="headerlink" title="core/vdom/patch.js"></a>core/vdom/patch.js</h3><p>createComponent() 自定义组件创建</p>
<h1 id="模板编译"><a href="#模板编译" class="headerlink" title="模板编译"></a>模板编译</h1><p>模板编译的主要目标是<strong>将模板(template)转换为渲染函数(render)</strong><br><img src="/static/img/template.png"></p>
<h2 id="模板编译必要性"><a href="#模板编译必要性" class="headerlink" title="模板编译必要性"></a>模板编译必要性</h2><p>Vue 2.0需要用到VNode描述视图以及各种交互，用户只需要编写类似HTML代码的Vue模板，通过编译器将模板转换为可返回VNode的render函数的代码字符串。</p>
<h2 id="体验模板编译"><a href="#体验模板编译" class="headerlink" title="体验模板编译"></a>体验模板编译</h2><p>带编译器的版本,可以使用template或el的方式声明模板</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"demo"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Vue模板编译<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;foo&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">comp</span>&gt;</span><span class="tag">&lt;/<span class="name">comp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">   Vue.component(<span class="string">'comp'</span>, &#123;</span></span><br><span class="line"><span class="xml">       template: '<span class="tag">&lt;<span class="name">div</span>&gt;</span>I am comp<span class="tag">&lt;/<span class="name">div</span>&gt;</span>'</span></span><br><span class="line"> </span><br><span class="line">    &#125;)</span><br><span class="line"><span class="javascript">   <span class="comment">// 创建实例</span></span></span><br><span class="line"><span class="javascript">   <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">       el: <span class="string">'#demo'</span>,</span></span><br><span class="line"><span class="javascript">       data: &#123;<span class="attr">foo</span>:<span class="string">'foo'</span>&#125;</span></span><br><span class="line"> </span><br><span class="line">    &#125;);</span><br><span class="line"><span class="javascript">   <span class="comment">// 输出render函数</span></span></span><br><span class="line"><span class="javascript">   <span class="built_in">console</span>.log(app.$options.render);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">anonymous</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">with</span>(<span class="keyword">this</span>)&#123;<span class="keyword">return</span> _c(<span class="string">'div'</span>,&#123;<span class="attr">attrs</span>:&#123;<span class="string">"id"</span>:<span class="string">"demo"</span>&#125;&#125;,[</span><br><span class="line">   _c(<span class="string">'h1'</span>,[_v(<span class="string">"Vue模板编译"</span>)]),_v(<span class="string">" "</span>),_c(<span class="string">'p'</span>,[_v(_s(foo))]),_v(<span class="string">" "</span>),</span><br><span class="line">   _c(<span class="string">'comp'</span>,&#123;<span class="attr">attrs</span>:&#123;<span class="string">"foo"</span>:<span class="string">"foo"</span>,<span class="string">"bar"</span>:foo&#125;&#125;)],<span class="number">1</span>)&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">/*  "with(this)&#123;return _c('div',&#123;attrs:&#123;"id":"demo"&#125;&#125;,[_m(0),_v(" "),_c('p',</span></span><br><span class="line"><span class="comment">    [_v(_s(foo))]),_v(" "),_c('comp',&#123;attrs:&#123;"foo":"foo","bar":foo&#125;&#125;)],1)&#125;"</span></span><br><span class="line"><span class="comment">    new Function(str) 将上面的函数字符串放入函数，将字符串变成真正的函数。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>_c  返回vnode, createElement<br>_v  创建文本节点<br>_s  格式化函数<br>其他helpers: core/instance/render-helper/index</p>
</blockquote>
<h2 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h2><h3 id="compileToFunctions"><a href="#compileToFunctions" class="headerlink" title="compileToFunctions"></a>compileToFunctions</h3><p>若指定template或el选项,则会执行编译(platforms/web/entry-runtime-with-compiler.js)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; render, staticRenderFns &#125; = compileToFunctions(template, &#123;&#125;, <span class="keyword">this</span>)</span><br></pre></td></tr></table></figure>

<h3 id="编译过程"><a href="#编译过程" class="headerlink" title="编译过程"></a>编译过程</h3><p>src/compiler/index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createCompiler = createCompilerCreator(<span class="function"><span class="keyword">function</span> <span class="title">baseCompile</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params"> template: string,</span></span></span><br><span class="line"><span class="function"><span class="params"> options: CompilerOptions</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">CompiledResult</span> </span>&#123;</span><br><span class="line"> <span class="comment">// 解析模板parse                                                 </span></span><br><span class="line"> <span class="keyword">const</span> ast = parse(template.trim(), options)</span><br><span class="line"> <span class="keyword">if</span> (options.optimize !== <span class="literal">false</span>) &#123;</span><br><span class="line">   optimize(ast, options) <span class="comment">// 优化optimize</span></span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">// 代码生成generate</span></span><br><span class="line"> <span class="keyword">const</span> code = generate(ast, options)</span><br><span class="line"> <span class="keyword">return</span> &#123;</span><br><span class="line">   ast,</span><br><span class="line">   render: code.render,</span><br><span class="line">   staticRenderFns: code.staticRenderFns</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="模板编译过程"><a href="#模板编译过程" class="headerlink" title="模板编译过程"></a>模板编译过程</h2><p>实现模板编译共有三个阶段: 解析, 优化, 生成</p>
<h3 id="解析-parse"><a href="#解析-parse" class="headerlink" title="解析 - parse"></a>解析 - parse</h3><p>解析器将模板解析为抽象语法树AST,只有将模板解析成AST后,才能基于它做优化或者生成代码字符串.</p>
<p>Template的parse过程，其实就是不断的截取字符串并解析它们的过程。如果截取到非闭合标签就push到stack中，如果截取道结束标签就把这个标签pop出来。</p>
<p>查看得到的AST, /src/compiler/parse/index.js 结构如下:<br><img src="/static/img/template2.png"></p>
<p>解析器内部分为HTML解析器,文本解析器和过滤解析器,最主要的是HTML解析器,核心算法说明:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//src/compiler/parser/index.js</span></span><br><span class="line">parseHTML(tempalte, &#123;</span><br><span class="line">   start(tag, attrs, unary)&#123;&#125;, <span class="comment">// 遇到开始标签的处理</span></span><br><span class="line">   end()&#123;&#125;,<span class="comment">// 遇到结束标签的处理</span></span><br><span class="line">   chars(text)&#123;&#125;,<span class="comment">// 遇到文本标签的处理</span></span><br><span class="line">   comment(text)&#123;&#125;<span class="comment">// 遇到注释标签的处理</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="截取字符串规则"><a href="#截取字符串规则" class="headerlink" title="截取字符串规则"></a>截取字符串规则</h4><p>判断模板中html.indexof(’&lt;’)的值,来确定我们是要截取标签还是文本。</p>
<p>若等于0,则进行正则匹配看是否为开始标签、结束标签、注释、条件注释、doctype中的一种。<br>大于等于 0：这就说明是文本、表达式。<br>小于 0：表示 html 标签解析完了，可能会剩下一些文本、表达式。</p>
<h4 id="stack"><a href="#stack" class="headerlink" title="stack"></a>stack</h4><p>维护了一个stack来标记DOM的深度，stack里的最后一项，永远是当前正在解析的元素的parentNode。</p>
<h3 id="优化-optimize"><a href="#优化-optimize" class="headerlink" title="优化 - optimize"></a>优化 - optimize</h3><p>优化器的作用是在AST中找出静态子树并打上标记.静态子树是在AST中永远不变的节点,如纯文本节点.</p>
<p>标记静态子树的好处:</p>
<ol>
<li>每次重新渲染,不需要为静态子树创建新节点.</li>
<li>虚拟DOM中patch时,可以跳过静态子树.</li>
</ol>
<p>测试代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 要出现嵌套关系 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Vue<span class="tag">&lt;<span class="name">span</span>&gt;</span>模板编译<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>代码实现: src/compiler/optimizer.js - optimize<br>标记结束:<br><img src="/static/img/template3.png"></p>
<h3 id="代码生成-generate"><a href="#代码生成-generate" class="headerlink" title="代码生成 - generate"></a>代码生成 - generate</h3><p>将AST转换成渲染函数中的内容,即代码字符串<br>generate方法生成渲染函数代码字符串 : src/compiler/codegen/index.js</p>
<h2 id="v-if-v-for"><a href="#v-if-v-for" class="headerlink" title="v-if, v-for"></a>v-if, v-for</h2><p>着重观察几个结构性指令的解析过程</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">v-if</span>=<span class="string">"foo"</span>&gt;</span>&#123;&#123;foo&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>解析v-if: parse/index.js<br>代码生成: codegen/index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"with(this)&#123;return </span></span><br><span class="line"><span class="string">_c(</span></span><br><span class="line"><span class="string">    'div',</span></span><br><span class="line"><span class="string">    &#123;attrs:&#123;"</span>id<span class="string">":"</span>demo<span class="string">"&#125;&#125;,</span></span><br><span class="line"><span class="string">    [</span></span><br><span class="line"><span class="string">        _m(0),_v("</span> <span class="string">"),</span></span><br><span class="line"><span class="string">        (foo)?_c('p',[_v(_s(foo))]):_e(),</span></span><br><span class="line"><span class="string">        _v("</span> <span class="string">"),</span></span><br><span class="line"><span class="string">        _c('comp',&#123;attrs:&#123;"</span>foo<span class="string">":"</span>foo<span class="string">","</span>bar<span class="string">":foo&#125;&#125;)</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    1</span></span><br><span class="line"><span class="string">)&#125;"</span></span><br></pre></td></tr></table></figure>

<p>解析结果:<br><img src="/static/img/template4.png"></p>
<p>v-if,v-for这些指令只能在编译器阶段处理,如果我们要在render函数处理条件或循环只能使用js的if和for</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Vue.component(<span class="string">'comp'</span>, &#123;</span><br><span class="line">props: [<span class="string">'foo'</span>],</span><br><span class="line">render(h) &#123; <span class="comment">// 渲染内容跟foo的值挂钩,只能用if语句</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.foo==<span class="string">'foo'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> h(<span class="string">'div'</span>, <span class="string">'foo'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> h(<span class="string">'div'</span>, <span class="string">'bar'</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="v-model原理（ToDo）"><a href="#v-model原理（ToDo）" class="headerlink" title="v-model原理（ToDo）"></a>v-model原理（ToDo）</h2><h2 id="事件和自定义事件原理"><a href="#事件和自定义事件原理" class="headerlink" title="事件和自定义事件原理"></a>事件和自定义事件原理</h2><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h2 id="组件化"><a href="#组件化" class="headerlink" title="组件化"></a>组件化</h2><h3 id="组件声明-注册"><a href="#组件声明-注册" class="headerlink" title="组件声明,注册"></a>组件声明,注册</h3><p>initAssetRegister(Vue)<br>生成组件构造函数: VueComponent Vue.extend(opts)<br>注册组件: Vue.$options.components,然后可以全局使用</p>
<h3 id="组件实例化及挂载"><a href="#组件实例化及挂载" class="headerlink" title="组件实例化及挂载"></a>组件实例化及挂载</h3><p>new Vue 根组件创建, 根组件的_render() =&gt; VNode<br>_createElement() 获取子组件构造函数并创建<br>createComponent() : 添加初始化钩子<br>vm._update() =&gt; patch() =&gt; createElm()<br>调用子组件初始化钩子</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取子组件构造函数</span></span><br><span class="line">Ctor = resolveAsset(context.$options,<span class="string">'components'</span>,tag)</span><br><span class="line">vnode = createComponent(Ctor)</span><br></pre></td></tr></table></figure>

<h3 id="编译原理-template-gt-render"><a href="#编译原理-template-gt-render" class="headerlink" title="编译原理: template =&gt; render()"></a>编译原理: template =&gt; render()</h3><blockquote>
<p>解析parse: 转换字符串模板为AST,解析DOM结构及其中表达式,指令等<br>优化optimize: 标记不发生变化的节点为静态节点和静态根节点,将来可以跳过他们的patch过程起到优化的作用<br>生成generate: 将AST转换为渲染函数的代码字符串</p>
</blockquote>
<h3 id="编译器获取整体流程"><a href="#编译器获取整体流程" class="headerlink" title="编译器获取整体流程"></a>编译器获取整体流程</h3><p>编译template为render</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compileToFunctions(template, &#123; &#125;, <span class="keyword">this</span>)</span><br></pre></td></tr></table></figure>

<p>compileToFunctions是createCompiler(baseOptions)的返回结果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// createCompiler</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createCompiler = createCompilerCreator(<span class="function"><span class="keyword">function</span></span></span><br><span class="line"><span class="function"><span class="title">baseCompile</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params"> template: string,</span></span></span><br><span class="line"><span class="function"><span class="params"> options: CompilerOptions</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">CompiledResult</span> </span>&#123;&#125;)</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/22/Vue源码分析三/" data-id="ckh44mzto000o4sv2k69ixngf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Vue源码分析二" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/11/Vue源码分析二/" class="article-date">
  <time datetime="2019-11-11T07:11:34.000Z" itemprop="datePublished">2019-11-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/11/Vue源码分析二/">Vue源码分析二</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="异步更新队列"><a href="#异步更新队列" class="headerlink" title="异步更新队列"></a>异步更新队列</h1><p>为了批量操作数据结束之后，再去更新DOM，只用更新一次。</p>
<h2 id="core-observer-watcher-js-update"><a href="#core-observer-watcher-js-update" class="headerlink" title="core/observer/watcher.js update()"></a>core/observer/watcher.js update()</h2><p>dep.notify()之后watcher执行update()函数, 然后回去执行queueWatcher(watcher)函数，将watcher放入队列。</p>
<h2 id="core-observer-scheduler-js"><a href="#core-observer-scheduler-js" class="headerlink" title="core/observer/scheduler.js"></a>core/observer/scheduler.js</h2><p>queueWatcher(watcher)<br>将watcher插入队列，同时会对watcehr进行去重。再去执行 nextTick(flushSchedulerQueue)<br>flushSchedulerQueue()函数会清空队列，并去执行watcher.run()方法，然后再去更新视图。</p>
<h2 id="core-util-next-tick-js"><a href="#core-util-next-tick-js" class="headerlink" title="core/util/next-tick.js"></a>core/util/next-tick.js</h2><p>nextTick(flushSchedulerQueue): nextTick按照特定策略去执行异步操作。涉及微任务和宏任务。</p>
<p>测试代码: 给foo赋值会触发watcher中update函数，update执行了三次，watcher进入队列三次，但队列会做去重，最后也只有一个watcher，然后执行这个watcher.run()方法，仅执行一次，也就是说只有最后一次赋值的结果会被浏览器渲染。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"demo"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">h1</span>&gt;</span>异步更新<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"p1"</span>&gt;</span>&#123;&#123;foo&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 创建实例</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">        el: <span class="string">'#demo'</span>,</span></span><br><span class="line"><span class="javascript">        data: &#123; <span class="attr">foo</span>: <span class="string">''</span> &#125;,</span></span><br><span class="line">        mounted() &#123;</span><br><span class="line"><span class="javascript">            setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;                    </span></span><br><span class="line"><span class="javascript">                <span class="keyword">this</span>.foo = <span class="built_in">Math</span>.random()</span></span><br><span class="line"><span class="javascript">                <span class="keyword">this</span>.foo = <span class="built_in">Math</span>.random()</span></span><br><span class="line"><span class="javascript">                <span class="keyword">this</span>.foo = <span class="built_in">Math</span>.random()</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(p1.innerHTML)</span></span><br><span class="line"><span class="javascript">                <span class="keyword">this</span>.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">console</span>.log(p1.innerHTML)</span></span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;, 1000);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="宏任务和微任务"><a href="#宏任务和微任务" class="headerlink" title="宏任务和微任务"></a>宏任务和微任务</h1><h1 id="虚拟DOM"><a href="#虚拟DOM" class="headerlink" title="虚拟DOM"></a>虚拟DOM</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>虚拟DOM(Virtual DOM) 是对DOM 的JS抽象表示,它就是JS对象,能够描述DOM结构和关系.应用各种状态变化会作用于虚拟DOM,最终映射到DOM.不需要操作DOM，只需对数据更改，就会改变虚拟DOM，再去渲染真实DOM。<br><img src="/static/img/virtualdom.png"></p>
<h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><ul>
<li>虚拟DOM轻量,快速: 当它们发生变化时,通过新旧虚拟DOM比对可以得到最小DOM操作量,从而提升性能和用户体验.</li>
<li>跨平台: 将虚拟dom更新转换为不同运行时特殊操作实现跨平台</li>
<li>兼容性: 还可以加入兼容性代码增强操作的兼容性</li>
</ul>
<h2 id="必要性-为什么Vue2-0中虚拟DOM是必需的"><a href="#必要性-为什么Vue2-0中虚拟DOM是必需的" class="headerlink" title="必要性(为什么Vue2.0中虚拟DOM是必需的?)"></a>必要性(为什么Vue2.0中虚拟DOM是必需的?)</h2><p>Vue1.0中有细粒度的数据变化侦测,它是不需要虚拟DOM的,但是细粒度造成了大量开销,这对于大型项目来说是不可接受的.因此,Vue2.0选择了中等粒度的解决方案,每一个组件一个watcher实例,这样状态变化时只能通知到组件,再通过引入虚拟DOM去进行比对和渲染.</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="core-instance-lifecycle-js-mountComponent"><a href="#core-instance-lifecycle-js-mountComponent" class="headerlink" title="core/instance/lifecycle.js mountComponent()"></a>core/instance/lifecycle.js mountComponent()</h3><p>渲染,更新组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> updateComponent = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 实际调用是在lifeCycleMixin中定义的_update和renderMixin中定义的_render</span></span><br><span class="line">    <span class="comment">// _render()执行可以获得虚拟DOM，VNode</span></span><br><span class="line">    <span class="comment">// _update()将虚拟DOM转换成真实DOM，这里有两种情况，组件第一次创建时，生成真实DOM，是不会去patch的，因为第一次没有老的VNode去比较。再就是数据改变时，生成新的VNode，会去比较新旧VNode, 然后去patch，生成真实DOM。</span></span><br><span class="line">    vm._update(vm._render(), hydrating)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">new</span> Watcher(<span class="keyword">this</span>.vm, updateComponent)</span><br></pre></td></tr></table></figure>

<h3 id="core-instance-render-js-render"><a href="#core-instance-render-js-render" class="headerlink" title="core/instance/render.js _render()"></a>core/instance/render.js _render()</h3><p>生成虚拟DOM</p>
<h3 id="core-instance-render-js-vm-createElement"><a href="#core-instance-render-js-vm-createElement" class="headerlink" title="core/instance/render.js vm.$createElement()"></a>core/instance/render.js vm.$createElement()</h3><p>真正用来创建vnode树的函数是vm.$createElement</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.$createElement = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> createElement(vm, a, b, c, d, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<h3 id="core-vdom-create-element-js"><a href="#core-vdom-create-element-js" class="headerlink" title="core/vdom/create-element.js"></a>core/vdom/create-element.js</h3><p>$createElement() 是对createElement函数的封装.</p>
<h3 id="core-vdom-create-component-js"><a href="#core-vdom-create-component-js" class="headerlink" title="core/vdom/create-component.js"></a>core/vdom/create-component.js</h3><p>createComponent() 用于创建组件并返回VNode</p>
<h3 id="core-vdom-vnode-js"><a href="#core-vdom-vnode-js" class="headerlink" title="core/vdom/vnode.js"></a>core/vdom/vnode.js</h3><p>render返回的一个VNode实例, 它的children还是VNode,最终构成一个树,就是虚拟DOM树.</p>
<h3 id="core-instance-lifecycle-js"><a href="#core-instance-lifecycle-js" class="headerlink" title="core/instance/lifecycle.js"></a>core/instance/lifecycle.js</h3><p>_update负责更新dom,将vnode转换为dom</p>
<h3 id="platforms-web-runtime-index-js-patch"><a href="#platforms-web-runtime-index-js-patch" class="headerlink" title="platforms/web/runtime/index.js patch()"></a>platforms/web/runtime/index.js <strong>patch</strong>()</h3><p><strong>patch</strong>是在平台特有代码中指定的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype.__patch__ = inBrowser ? patch : noop</span><br></pre></td></tr></table></figure>

<p>patch 是createPatchFunction的返回值,传递nodeOps和modules是web平台特别实现的.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> patch: <span class="built_in">Function</span> = createPatchFunction(&#123;nodeOps, modules&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="platforms-web-runtime-node-ops-js"><a href="#platforms-web-runtime-node-ops-js" class="headerlink" title="platforms/web/runtime/node-ops.js"></a>platforms/web/runtime/node-ops.js</h3><p>定义各种原生dom基础操作方法</p>
<h3 id="platforms-web-runtime-modules-index-js"><a href="#platforms-web-runtime-modules-index-js" class="headerlink" title="platforms/web/runtime/modules/index.js"></a>platforms/web/runtime/modules/index.js</h3><p>modules 定义了属性更新实现</p>
<h3 id="core-vdom-patch-js-patch"><a href="#core-vdom-patch-js-patch" class="headerlink" title="core/vdom/patch.js patch()"></a>core/vdom/patch.js patch()</h3><p>patch的规则<br>通过同层的树节点进行比较而非对树进行逐层搜索遍历的方式,所以时间复杂度只有O(n),是一种相当高效的算法。<br>同层级只做三件事:增删改。具体规则是:new VNode不存在就删;old VNode不存在就增;都存在就比较类型,类型不同直接替换、类型相同执行更新;<br><img src="/static/img/patch1.png"></p>
<h4 id="patchVnode"><a href="#patchVnode" class="headerlink" title="patchVnode"></a>patchVnode</h4><p>两个VNode类型相同,就执行更新操作,包括三种类型操作: 属性更新PROPS,文本更新TEXT,子节点更新REORDER.</p>
<p>patchVnode具体规则如下:</p>
<ol>
<li>如果新旧VNode都是静态的,那么只需要替换elm 以及componentInstance即可。</li>
<li>新老节点均有children子节点,则对子节点进行diff操作,调用updateChildren。</li>
<li>如果老节点没有子节点而新节点存在子节点,先清空老节点DOM的文本内容,然后为当前DOM节点加入子节点。</li>
<li>当新节点没有子节点而老节点有子节点的时候,则移除该DOM节点的所有子节点。</li>
<li>当新老节点都无子节点的时候,就只是文本的替换。</li>
</ol>
<h4 id="updateChildren"><a href="#updateChildren" class="headerlink" title="updateChildren"></a>updateChildren</h4><p>updateChildren 主要作用是用一种较高效的方式比对新旧两个VNode的children得出最小操作补丁.执行下一个双循环是传统方式,vue中针对web场景特点做了特别的算法优化.<br><img src="/static/img/updateChildren1.png"></p>
<p>在新老两组VNode节点的左右头尾两侧都有一个变量标记,在遍历过程中这几个变量都会向中间靠拢.<br>当oldStartIdx &gt; oldEndIdx 或者newStartIdx &gt; newEndIdx时结束循环.<br>遍历规则:<br>首先,oldStartVnode、oldEndVnode与newStartVnode、newEndVnode两两交叉比较,共有4种比较方法.<br>当 oldStartVnode和newStartVnode 或者 oldEndVnode和newEndVnode 满足sameVnode,直接将该VNode节点进行patchVnode即可,不需再遍历就完成了一次循环。如下图:</p>
<img src="/static/img/updateChildren2.png">

<p>如果oldStartVnode与newEndVnode满足sameVnode。说明oldStartVnode已经跑到了oldEndVnode后面去了,进行patchVnode的同时还需要将真实DOM节点移动到oldEndVnode的后面。<br><img src="/static/img/updateChildren3.png"></p>
<p>如果oldEndVnode与newStartVnode满足sameVnode,说明oldEndVnode跑到了oldStartVnode的前面,进行patchVnode的同时要将oldEndVnode对应DOM移动到oldStartVnode对应DOM的前面。<br><img src="/static/img/updateChildren4.png"></p>
<p>如果以上情况均不符合,则在old VNode中找与newStartVnode满足sameVnode的vnodeToMove,若存在执行patchVnode,同时将vnodeToMove对应DOM移动到oldStartVnode对应的DOM的前面。<br><img src="/static/img/updateChildren5.png"></p>
<p>当然也有可能newStartVnode在old VNode节点中找不到一致的key,或者是即便key相同却不是sameVnode,这个时候会调用createElm创建一个新的DOM节点。<br><img src="/static/img/updateChildren6.png"></p>
<p>至此循环结束,但是我们还需要处理剩下的节点。<br>当结束时oldStartIdx &gt; oldEndIdx,这个时候旧的VNode节点已经遍历完了,但是新的节点还没有。说明了新的VNode节点实际上比老的VNode节点多,需要将剩下的VNode对应的DOM插入到真实DOM中,此时调用addVnodes(批量调用createElm接口)。<br><img src="/static/img/updateChildren7.png"></p>
<p>但是,当结束时newStartIdx &gt; newEndIdx时,说明新的VNode节点已经遍历完了,但是老的节点还有剩余,需要从文档中删 的节点删除。<br><img src="/static/img/updateChildren8.png"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h2 id="异步更新-批量异步执行组件更新"><a href="#异步更新-批量异步执行组件更新" class="headerlink" title="异步更新: 批量异步执行组件更新"></a>异步更新: 批量异步执行组件更新</h2><p> dep.notify() =&gt; watcher.update() =&gt; queueWatcher() =&gt; nextTick() =&gt; timerFunc() =&gt; flushSchedulerQueue() =&gt; watcher.run()</p>
<ul>
<li>core/observer/index.js reactiveSetter() 通知更新</li>
<li>watcher.js update() 入队</li>
<li>core\observer\scheduler.js 加入异步任务</li>
<li>core\util\next-tick.js 加入回调,启动任务队列</li>
<li>timerFunc() 启动异步执行任务</li>
<li>watcher.run() 更新操作<h2 id="虚拟DOM-利用patching算法转换虚拟DOM为真实DOM"><a href="#虚拟DOM-利用patching算法转换虚拟DOM为真实DOM" class="headerlink" title="虚拟DOM: 利用patching算法转换虚拟DOM为真实DOM"></a>虚拟DOM: 利用patching算法转换虚拟DOM为真实DOM</h2><h3 id="什么是虚拟DOM"><a href="#什么是虚拟DOM" class="headerlink" title="什么是虚拟DOM?"></a>什么是虚拟DOM?</h3>用来描述DOM树的JS对象。<h3 id="为什么需要虚拟DOM"><a href="#为什么需要虚拟DOM" class="headerlink" title="为什么需要虚拟DOM?"></a>为什么需要虚拟DOM?</h3>因为Vue2.x中，一个组件一个watcher，在数据改变之后，要通过比较新旧DOM，来做更新操作，因此需要虚拟DOM。</li>
</ul>
<p>watcher.run() =&gt; updateComponent() =&gt; _render() =&gt; _update() =&gt; vm.__patch() =&gt; patch()</p>
<ul>
<li>watcher.js run()</li>
<li>core/instance/lifecycle.js mountComponent() updateComponent()</li>
<li>core/instance/render.js _render() 计算虚拟DOM</li>
<li>core/instance/lifecycle.js _update() 把虚拟DOM变成真实DOM</li>
<li>platforms/web/runtime/index.js __patch() patch算法</li>
<li>core/vdom/patch.js patch()</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/11/Vue源码分析二/" data-id="ckh44mztl000m4sv2vuyiwawq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Vue源码分析一" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/08/Vue源码分析一/" class="article-date">
  <time datetime="2019-11-08T06:13:03.000Z" itemprop="datePublished">2019-11-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/08/Vue源码分析一/">Vue源码分析一</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="获取Vue源码"><a href="#获取Vue源码" class="headerlink" title="获取Vue源码"></a>获取Vue源码</h1><p>Vue源码地址: <a href="https://github.com/vuejs/vue" target="_blank" rel="noopener">https://github.com/vuejs/vue</a><br>当前版本号: 2.6.10</p>
<h2 id="获取源代码"><a href="#获取源代码" class="headerlink" title="获取源代码"></a>获取源代码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/vuejs/vue.git</span><br></pre></td></tr></table></figure>

<h1 id="调试环境搭建"><a href="#调试环境搭建" class="headerlink" title="调试环境搭建"></a>调试环境搭建</h1><h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖:"></a>安装依赖:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install</span><br></pre></td></tr></table></figure>

<h2 id="全局安装rollup"><a href="#全局安装rollup" class="headerlink" title="全局安装rollup:"></a>全局安装rollup:</h2><p>rollup是打包工具,专门用于打包js代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g rollup</span><br></pre></td></tr></table></figure>

<h2 id="修改package-json的dev选项-添加-–sourcemap"><a href="#修改package-json的dev选项-添加-–sourcemap" class="headerlink" title="修改package.json的dev选项,添加 –sourcemap"></a>修改package.json的dev选项,添加 –sourcemap</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dev 选项中 : -c scripts/config.js 指明 配置文件所在</span></span><br><span class="line"><span class="comment"># 参数TARGET:web-full-dev 指明 输出文件配置项((scripts/config.js,line:123))</span></span><br><span class="line"><span class="string">"dev"</span>: <span class="string">"rollup -w -c scripts/config.js --sourcemap --environment TARGET:web-</span></span><br><span class="line"><span class="string">full-dev"</span></span><br></pre></td></tr></table></figure>

<h2 id="运行开发命令"><a href="#运行开发命令" class="headerlink" title="运行开发命令"></a>运行开发命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run dev</span><br></pre></td></tr></table></figure>

<h2 id="新建html文件用于浏览器调试"><a href="#新建html文件用于浏览器调试" class="headerlink" title="新建html文件用于浏览器调试"></a>新建html文件用于浏览器调试</h2><p>/examples/test/test.html<br>引用 vue.js</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/dist/vue.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="入口文件"><a href="#入口文件" class="headerlink" title="入口文件"></a>入口文件</h1><p>vue 各版本: /dist<br>vue.runtime.common.js 用于webpack 1.x, browserify.<br>vue.runtime.esm.js 用于webpack 2.x.</p>
<h2 id="查看-scripts-config-js-line-123"><a href="#查看-scripts-config-js-line-123" class="headerlink" title="查看 /scripts/config.js (line:123)"></a>查看 /scripts/config.js (line:123)</h2><p>入口文件在 /src/platforms/web/entry-runtime-with-compiler.js，源码分析从这个文件开始.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Runtime+compiler development build (Browser)</span></span><br><span class="line">    <span class="string">'web-full-dev'</span>: &#123;</span><br><span class="line">        entry: resolve(<span class="string">'web/entry-runtime-with-compiler.js'</span>), <span class="comment">// 入口</span></span><br><span class="line">        dest: resolve(<span class="string">'dist/vue.js'</span>),<span class="comment">// 目标文件</span></span><br><span class="line">        format: <span class="string">'umd'</span>, <span class="comment">// 输出规范</span></span><br><span class="line">        env: <span class="string">'development'</span>,</span><br><span class="line">        alias: &#123; <span class="attr">he</span>: <span class="string">'./entity-decoder'</span> &#125;,</span><br><span class="line">        banner</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="初始化流程"><a href="#初始化流程" class="headerlink" title="初始化流程"></a>初始化流程</h1><p>入口: /src/platforms/web/entry-runtime-with-compiler.js<br>扩展默认的$mount方法: 在不同的平台有不同的处理方式。在浏览器平台，在没有render选项时去处理template，没有template去处理el选项。但是最终都会将模板字符串变为render函数。</p>
<h2 id="src-platforms-web-runtime-index-js"><a href="#src-platforms-web-runtime-index-js" class="headerlink" title="src/platforms/web/runtime/index.js"></a>src/platforms/web/runtime/index.js</h2><p>定义了$mount方法，执行挂载mountComponent(this, el, hydrating) : 挂载根组件到指定宿主元素<br>定义<strong>patch</strong>: 补丁函数，做diff操作，比较新旧VDOM，然后再决定如何更新DOM。</p>
<h2 id="src-core-index-js"><a href="#src-core-index-js" class="headerlink" title="src/core/index.js"></a>src/core/index.js</h2><h3 id="初始化全局API"><a href="#初始化全局API" class="headerlink" title="初始化全局API"></a>初始化全局API</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化全局API</span></span><br><span class="line">initGlobalAPI(Vue)</span><br></pre></td></tr></table></figure>

<h3 id="实现全局API-具体如下"><a href="#实现全局API-具体如下" class="headerlink" title="实现全局API,具体如下:"></a>实现全局API,具体如下:</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/global-api/index.js</span></span><br><span class="line">Vue.set = <span class="keyword">set</span></span><br><span class="line">Vue.delete = del</span><br><span class="line">Vue.nextTick = nextTick</span><br><span class="line">initUse(Vue) // 实现Vue.use函数</span><br><span class="line">initMixin(Vue) // 实现Vue.mixin函数</span><br><span class="line">initExtend(Vue) // 实现Vue.extend函数</span><br><span class="line">initAssetRegisters(Vue) // 注册实现Vue.component/directive/filter</span><br></pre></td></tr></table></figure>

<h2 id="src-core-instance-index-js"><a href="#src-core-instance-index-js" class="headerlink" title="src/core/instance/index.js"></a>src/core/instance/index.js</h2><h3 id="Vue构造函数定义，实例api定义"><a href="#Vue构造函数定义，实例api定义" class="headerlink" title="Vue构造函数定义，实例api定义"></a>Vue构造函数定义，实例api定义</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 构造函数仅执行了_init</span></span><br><span class="line">    <span class="keyword">this</span>._init(options)</span><br><span class="line">&#125;</span><br><span class="line">initMixin(Vue)  <span class="comment">// 实现init函数</span></span><br><span class="line">stateMixin(Vue) <span class="comment">// 状态相关api $data,$props,$set,$delete,$watch</span></span><br><span class="line">eventsMixin(Vue)<span class="comment">// 事件相关api $on,$once,$off,$emit</span></span><br><span class="line">lifecycleMixin(Vue) <span class="comment">// 生命周期api _update,$forceUpdate,$destroy</span></span><br><span class="line">renderMixin(Vue)<span class="comment">// 渲染api _render,$nextTick</span></span><br></pre></td></tr></table></figure>

<h2 id="src-core-instance-init-js"><a href="#src-core-instance-init-js" class="headerlink" title="src/core/instance/init.js"></a>src/core/instance/init.js</h2><h3 id="创建组件实例-初始化其数据、属性、事件等"><a href="#创建组件实例-初始化其数据、属性、事件等" class="headerlink" title="创建组件实例,初始化其数据、属性、事件等"></a>创建组件实例,初始化其数据、属性、事件等</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">initLifecycle(vm)  <span class="comment">// 初始化$parent,$root,$children,$refs</span></span><br><span class="line">initEvents(vm)     <span class="comment">// 处理父组件传递给当前组件实例的监听器</span></span><br><span class="line">initRender(vm)     <span class="comment">// 渲染相关：$slots,$scopedSlots,_c,$createElement</span></span><br><span class="line">callHook(vm, <span class="string">'beforeCreate'</span>) <span class="comment">// 在beforeCreate 之中无法拿到 state</span></span><br><span class="line">initInjections(vm) <span class="comment">// resolve injections before data/props 获取注入的数据(父组件的)</span></span><br><span class="line">initState(vm)      <span class="comment">// 初始化组件中的props，methods，data，computed, watch。对这些数据做响应式。</span></span><br><span class="line">initProvide(vm)    <span class="comment">// resolve provide after data/props 提供数据注入 </span></span><br><span class="line">callHook(vm, <span class="string">'created'</span>) <span class="comment">// 要拿到state 最早要在created 钩子函数中</span></span><br></pre></td></tr></table></figure>

<h2 id="src-core-instance-lifecycle-js"><a href="#src-core-instance-lifecycle-js" class="headerlink" title="src/core/instance/lifecycle.js"></a>src/core/instance/lifecycle.js</h2><h3 id="lifecycleMixin-Vue"><a href="#lifecycleMixin-Vue" class="headerlink" title="lifecycleMixin(Vue)"></a>lifecycleMixin(Vue)</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lifecycleMixin(Vue)</span></span><br><span class="line"><span class="comment">// 添加以下方法到Vue上</span></span><br><span class="line">Vue.prototype._update</span><br><span class="line">Vue.prototype.$forceUpdate</span><br><span class="line">Vue.prototype.$destroy</span><br></pre></td></tr></table></figure>

<h3 id="mountComponent-方法-执行挂载"><a href="#mountComponent-方法-执行挂载" class="headerlink" title="mountComponent()方法 执行挂载"></a>mountComponent()方法 执行挂载</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">callHook(vm, <span class="string">'beforeMount'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义组件更新函数 updateComponent()</span></span><br><span class="line"><span class="comment">// vm._render()执行可以获得虚拟DOM,VNode</span></span><br><span class="line"><span class="comment">// vm._update()将虚拟DOM转换成真实DOM</span></span><br><span class="line">updateComponent = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    vm._update(vm._render(), hydrating)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 声明一个render watcher 用于update</span></span><br><span class="line"><span class="keyword">new</span> Watcher(vm, updateComponent, noop, &#123;</span><br><span class="line">    before () &#123;</span><br><span class="line">      <span class="keyword">if</span> (vm._isMounted &amp;&amp; !vm._isDestroyed) &#123;</span><br><span class="line">        callHook(vm, <span class="string">'beforeUpdate'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 手动挂载</span></span><br><span class="line">  <span class="keyword">if</span> (vm.$vnode == <span class="literal">null</span>) &#123;</span><br><span class="line">    vm._isMounted = <span class="literal">true</span></span><br><span class="line">    callHook(vm, <span class="string">'mounted'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vm</span><br></pre></td></tr></table></figure>

<h2 id="src-core-instance-events-js"><a href="#src-core-instance-events-js" class="headerlink" title="src/core/instance/events.js"></a>src/core/instance/events.js</h2><h3 id="initEvents-vm"><a href="#initEvents-vm" class="headerlink" title="initEvents(vm)"></a>initEvents(vm)</h3><p>初始化 父组件的监听器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// initEvents(vm)</span></span><br><span class="line"><span class="keyword">const</span> listeners = vm.$options._parentListeners</span><br><span class="line"><span class="keyword">if</span> (listeners) &#123;</span><br><span class="line">    updateComponentListeners(vm, listeners)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="eventsMixin-Vue"><a href="#eventsMixin-Vue" class="headerlink" title="eventsMixin(Vue)"></a>eventsMixin(Vue)</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册事件</span></span><br><span class="line">Vue.prototype.$on()</span><br><span class="line">Vue.prototype.$once()</span><br><span class="line">Vue.prototype.$off()</span><br><span class="line">Vue.prototype.$emit()</span><br></pre></td></tr></table></figure>

<h2 id="src-core-instance-render-js"><a href="#src-core-instance-render-js" class="headerlink" title="src/core/instance/render.js"></a>src/core/instance/render.js</h2><h3 id="初始化render-initRender"><a href="#初始化render-initRender" class="headerlink" title="初始化render initRender()"></a>初始化render initRender()</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册createElement()方法</span></span><br><span class="line"><span class="comment">// args order: tag, data, children, normalizationType, alwaysNormalize</span></span><br><span class="line">vm._c = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> createElement(vm, a, b, c, d, <span class="literal">false</span>)</span><br><span class="line">vm.$createElement = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> createElement(vm, a, b, c, d, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<h3 id="renderMixin"><a href="#renderMixin" class="headerlink" title="renderMixin()"></a>renderMixin()</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype.$nextTick()   <span class="comment">// 注册$nextTick()函数</span></span><br><span class="line">Vue.prototype._render()     <span class="comment">// 注册_render()函数,该函数返回VNODE</span></span><br></pre></td></tr></table></figure>

<h1 id="数据响应式"><a href="#数据响应式" class="headerlink" title="数据响应式"></a>数据响应式</h1><p>Vue一大特点是数据响应式,数据的变化会作用于UI而不用进行DOM操作。原理上来讲,是利用了JS语<br>言特性Object.defineProperty(),通过定义对象属性setter方法拦截对象属性变更,从而将数值的变化<br>转换为UI的变化，因此这种方式就叫数据劫持。<br>具体实现是在Vue初始化时,会调用initState,它会初始化data,props等,这里着重关注data初始化,</p>
<h2 id="src-core-instance-state-js"><a href="#src-core-instance-state-js" class="headerlink" title="src/core/instance/state.js"></a>src/core/instance/state.js</h2><p>初始化数据</p>
<h3 id="proxy-代理方法"><a href="#proxy-代理方法" class="headerlink" title="proxy()代理方法"></a>proxy()代理方法</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">proxy</span> (<span class="params">target: Object, sourceKey: string, key: string</span>) </span>&#123;</span><br><span class="line">  sharedPropertyDefinition.get = <span class="function"><span class="keyword">function</span> <span class="title">proxyGetter</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>[sourceKey][key]</span><br><span class="line">  &#125;</span><br><span class="line">  sharedPropertyDefinition.set = <span class="function"><span class="keyword">function</span> <span class="title">proxySetter</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>[sourceKey][key] = val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 在对象上定义一个新属性.</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(target, key, sharedPropertyDefinition)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="initState-vm"><a href="#initState-vm" class="headerlink" title="initState(vm)"></a>initState(vm)</h3><p>如果$options里面有 props methods data computed watch就要对他们进行初始化</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">initProps(vm, opts.props)</span><br><span class="line">initMethods()</span><br><span class="line">initData()</span><br><span class="line">initComputed(vm, opts.computed)</span><br><span class="line">initWatch(vm, watch)</span><br></pre></td></tr></table></figure>

<h3 id="initData"><a href="#initData" class="headerlink" title="initData()"></a>initData()</h3><p>核心代码就是将data数据响应化</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initData</span> (<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//获取data</span></span><br><span class="line">    <span class="keyword">let</span> data = vm.$options.data</span><br><span class="line">    data = vm._data = <span class="keyword">typeof</span> data === <span class="string">'function'</span></span><br><span class="line">    ? getData(data, vm)</span><br><span class="line">    : data || &#123;&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 代理data到实例上</span></span><br><span class="line">    <span class="comment">// observe data : 数据遍历 ,响应化处理</span></span><br><span class="line">    observe(data, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="src-core-observer-index-js"><a href="#src-core-observer-index-js" class="headerlink" title="src/core/observer/index.js"></a>src/core/observer/index.js</h2><p>Observer对象根据数据类型执行对应的响应化操作，对象和数组的响应化处理不一样。<br>defineReactive定义对象属性的getter/setter,getter负责添加依赖,setter负责通知更新</p>
<h3 id="observe-方法返回一个Observer对象实例"><a href="#observe-方法返回一个Observer对象实例" class="headerlink" title="observe()方法返回一个Observer对象实例"></a>observe()方法返回一个Observer对象实例</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ob = <span class="keyword">new</span> Observer(value)</span><br></pre></td></tr></table></figure>

<h3 id="defineReactive-方法响应化处理"><a href="#defineReactive-方法响应化处理" class="headerlink" title="defineReactive()方法响应化处理"></a>defineReactive()方法响应化处理</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  obj: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  val: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  customSetter?: ?Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  shallow?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dep = <span class="keyword">new</span> Dep()</span><br><span class="line">  <span class="comment">// 获取自有属性的属性描述符</span></span><br><span class="line">  <span class="keyword">const</span> property = <span class="built_in">Object</span>.getOwnPropertyDescriptor(obj, key)</span><br><span class="line">  <span class="keyword">if</span> (property &amp;&amp; property.configurable === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// cater for pre-defined getter/setters</span></span><br><span class="line">  <span class="keyword">const</span> getter = property &amp;&amp; property.get</span><br><span class="line">  <span class="keyword">const</span> setter = property &amp;&amp; property.set</span><br><span class="line">  <span class="keyword">if</span> ((!getter || setter) &amp;&amp; <span class="built_in">arguments</span>.length === <span class="number">2</span>) &#123;</span><br><span class="line">    val = obj[key]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果内部是对象,递归处理</span></span><br><span class="line">  <span class="keyword">let</span> childOb = !shallow &amp;&amp; observe(val)</span><br><span class="line">  <span class="comment">// 数据拦截,给对象的属性增加get 和 set</span></span><br><span class="line">  <span class="comment">// 当获取属性值或属性发生改变时都会去执行get set 里面的函数</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    enumerable: <span class="literal">true</span>,</span><br><span class="line">    configurable: <span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">get</span>: function reactiveGetter () &#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.call(obj) : val</span><br><span class="line">      <span class="comment">// 依赖收集</span></span><br><span class="line">      <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">        dep.depend() <span class="comment">//追加 依赖关系</span></span><br><span class="line">        <span class="comment">// 如果有子ob存在</span></span><br><span class="line">        <span class="keyword">if</span> (childOb) &#123;</span><br><span class="line">          childOb.dep.depend()</span><br><span class="line">          <span class="comment">// 如果是数组还要继续处理</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">            dependArray(value)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">set</span>: function reactiveSetter (newVal) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.call(obj) : val</span><br><span class="line">      <span class="comment">/* eslint-disable no-self-compare */</span></span><br><span class="line">      <span class="keyword">if</span> (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/* eslint-enable no-self-compare */</span></span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; customSetter) &#123;</span><br><span class="line">        customSetter()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// #7981: for accessor properties without setter</span></span><br><span class="line">      <span class="keyword">if</span> (getter &amp;&amp; !setter) <span class="keyword">return</span></span><br><span class="line">      <span class="keyword">if</span> (setter) &#123;</span><br><span class="line">        setter.call(obj, newVal)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        val = newVal <span class="comment">// 更新value</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果用户设置的值是对象, 还需要额外的响应化处理</span></span><br><span class="line">      childOb = !shallow &amp;&amp; observe(newVal)</span><br><span class="line">      <span class="comment">// 通知更新</span></span><br><span class="line">      dep.notify()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="src-core-observer-dep-js"><a href="#src-core-observer-dep-js" class="headerlink" title="src/core/observer/dep.js"></a>src/core/observer/dep.js</h2><p>Dep负责管理一组Watcher,包括watcher实例的增删及通知更新</p>
<h3 id="depend"><a href="#depend" class="headerlink" title="depend()"></a>depend()</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// class Dep</span></span><br><span class="line">depend () &#123;</span><br><span class="line">    <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">      <span class="comment">// 建立 和 Watcher实例之间的关系, dep 和 watcher 可能是多对多的关系</span></span><br><span class="line">      Dep.target.addDep(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Watcher"><a href="#Watcher" class="headerlink" title="Watcher"></a>Watcher</h3><p>Watcher解析一个表达式并收集依赖,当数值变化时触发回调函数,常用于$watch API和指令中。<br>每个组件也会有对应的Watcher,数值变化会触发其update函数导致重新渲染</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// watcher 在vue2.x版本里面 是一个组件一个watcher.可能里面有一些watch选项.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span> () &#123;&#125;</span><br><span class="line">    <span class="comment">//Evaluate the getter, and re-collect dependencies.</span></span><br><span class="line">    <span class="comment">// 触发依赖收集的地方</span></span><br><span class="line">    <span class="keyword">get</span> () &#123;&#125; </span><br><span class="line">    <span class="comment">// Add a dependency to this directive.</span></span><br><span class="line">    addDep (dep: Dep) &#123;&#125;</span><br><span class="line">    <span class="comment">// Clean up for dependency collection.</span></span><br><span class="line">    cleanuoDeps()</span><br><span class="line">    <span class="comment">// Subscriber interface. Will be called when a dependency changes.</span></span><br><span class="line">    update ()</span><br><span class="line">    <span class="comment">// Scheduler job interface.Will be called by the scheduler.</span></span><br><span class="line">    run()</span><br><span class="line">    <span class="comment">// Evaluate the value of the watcher.This only gets called for lazy watchers.</span></span><br><span class="line">    evaluate()</span><br><span class="line">    <span class="comment">// Depend on all deps collected by this watcher.</span></span><br><span class="line">    depend()</span><br><span class="line">    <span class="comment">// Remove self from all dependencies' subscriber list.</span></span><br><span class="line">    teardown()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="数组的响应化"><a href="#数组的响应化" class="headerlink" title="数组的响应化"></a>数组的响应化</h1><p>数组数据变化的侦测跟对象不同,以下数组方法(变异方法)对数组数据操作,让原数组被改变,但是页面此时没有办法得知数据变化。<br>所以vue中采取的策略是拦截这些方法并通知dep。<br>‘push’, ‘pop’, ‘shift’, ‘unshift’, ‘splice’, ‘sort’, ‘reverse’</p>
<h2 id="src-core-observer-index-js-1"><a href="#src-core-observer-index-js-1" class="headerlink" title="src/core/observer/index.js"></a>src/core/observer/index.js</h2><p>Observer中覆盖数组原型</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">  <span class="comment">// 替换数组原型</span></span><br><span class="line">  protoAugment(value, arrayMethods) <span class="comment">// value.__proto__ = arrayMethods</span></span><br><span class="line">  <span class="keyword">this</span>.observeArray(value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="src-core-observer-array-js"><a href="#src-core-observer-array-js" class="headerlink" title="src\core\observer\array.js"></a>src\core\observer\array.js</h2><p>为数组原型中的7个可以改变内容的方法定义拦截器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arrayProto = <span class="built_in">Array</span>.prototype</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> arrayMethods = <span class="built_in">Object</span>.create(arrayProto)</span><br><span class="line"><span class="keyword">const</span> methodsToPatch = [</span><br><span class="line">  <span class="string">'push'</span>,</span><br><span class="line">  <span class="string">'pop'</span>,</span><br><span class="line">  <span class="string">'shift'</span>,</span><br><span class="line">  <span class="string">'unshift'</span>,</span><br><span class="line">  <span class="string">'splice'</span>,</span><br><span class="line">  <span class="string">'sort'</span>,</span><br><span class="line">  <span class="string">'reverse'</span></span><br><span class="line">]</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Intercept mutating methods and emit events</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">methodsToPatch.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">method</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// cache original method</span></span><br><span class="line">  <span class="comment">// 数组的原型方法</span></span><br><span class="line">  <span class="keyword">const</span> original = arrayProto[method]</span><br><span class="line">  <span class="comment">// 拦截,添加额外行为</span></span><br><span class="line">  def(arrayMethods, method, <span class="function"><span class="keyword">function</span> <span class="title">mutator</span> (<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 执行原先的任务</span></span><br><span class="line">    <span class="keyword">const</span> result = original.apply(<span class="keyword">this</span>, args)</span><br><span class="line">    <span class="comment">// 额外任务: 通知更新</span></span><br><span class="line">    <span class="keyword">const</span> ob = <span class="keyword">this</span>.__ob__</span><br><span class="line">    <span class="comment">// 以下三个操作需要额外响应化处理</span></span><br><span class="line">    <span class="keyword">let</span> inserted</span><br><span class="line">    <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'push'</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'unshift'</span>:</span><br><span class="line">        inserted = args</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">'splice'</span>:</span><br><span class="line">        inserted = args.slice(<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (inserted) ob.observeArray(inserted)</span><br><span class="line">    <span class="comment">// notify change</span></span><br><span class="line">    ob.dep.notify()</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>理解响应式原理的实现,注意以下事项:</p>
<ol>
<li><p>对象各属性初始化时进行一次响应化处理,以后再动态设置是无效的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// data: &#123;obj:&#123;foo: 'foo'&#125;&#125;</span></span><br><span class="line"><span class="comment">// 无效</span></span><br><span class="line"><span class="keyword">this</span>.obj.bar = <span class="string">'bar'</span></span><br><span class="line"><span class="comment">// 有效</span></span><br><span class="line"><span class="keyword">this</span>.$<span class="keyword">set</span>(this.obj, 'bar', 'bar')</span><br></pre></td></tr></table></figure>
</li>
<li><p>数组是通过方法拦截实现响应化处理,不通过方法操作数组也是无效的<br>Vue内部对数组的7个变异方法做过封装,因此只有使用变异方法改变数组数据才能更新到页面</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// data: &#123;items: ['foo','bar']&#125;</span></span><br><span class="line"><span class="comment">// 无效</span></span><br><span class="line"><span class="keyword">this</span>.items[<span class="number">0</span>] = <span class="string">'tua'</span></span><br><span class="line"><span class="keyword">this</span>.items.length = <span class="number">0</span></span><br><span class="line"><span class="comment">// 有效</span></span><br><span class="line"><span class="keyword">this</span>.$<span class="keyword">set</span>(this.items, 0, 'tua')</span><br><span class="line">this.items.splice(0, 2)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h2 id="初始化过程-init-–-gt-mount-–-gt-compile-–-gt-new-Watcher-–-gt-render-–-gt-update"><a href="#初始化过程-init-–-gt-mount-–-gt-compile-–-gt-new-Watcher-–-gt-render-–-gt-update" class="headerlink" title="初始化过程: init –&gt; $mount –&gt; compile –&gt; new Watcher –&gt; render –&gt; update"></a>初始化过程: init –&gt; $mount –&gt; compile –&gt; new Watcher –&gt; render –&gt; update</h2><ol>
<li>runtime/index : 实现$mount</li>
<li>core/index: 全局api</li>
<li>core/instance/index: 声明vue构造函数</li>
<li>entry-runtime-with-compiler: 覆盖$mount</li>
<li>core/instance/lifecycle: mountComponent 执行渲染和更新,计算虚拟DOM,并转换成真实DOM,并挂载到$el上.<h2 id="响应化"><a href="#响应化" class="headerlink" title="响应化"></a>响应化</h2></li>
<li>observe(): 返回Observer实例.</li>
<li>Observer实例: 区分当前值的类型是对象还是数组，从而做相对应的响应化操作。</li>
<li>defineReactive： 定义响应式，最重要的创建dep。</li>
<li>Dep类: 依赖收集。</li>
<li>Watcher类：数据改变，watcher通知视图更新。</li>
</ol>
<h2 id="Dep-和-Watcher-的关系"><a href="#Dep-和-Watcher-的关系" class="headerlink" title="Dep 和 Watcher 的关系"></a>Dep 和 Watcher 的关系</h2><p>依赖收集 : dep和watcher之间建立双向引用关系的过程就叫依赖收集。每个属性都会为之产生一个Dep实例。Dep实例和Watcher实例会相互保存。<br>一个组件只有一个Watcher，Watcher中会保存多个dep。<br>第一次依赖收集的过程：<br>每个组件实例创建时，就会创建一个Watcher实例。Watcher实例创建触发render函数生成，render函数生成虚拟DOM时，会使用data中的数据，然后就会触发get函数，就会去进行依赖收集。当data中的对象或者数组里的值发生变化的时候, 就要通知组件的Watcher 去通知(notify)更新。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/08/Vue源码分析一/" data-id="ckh44mzti000j4sv2eslyj7er" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Create-my-vue" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/02/Create-my-vue/" class="article-date">
  <time datetime="2019-11-02T06:41:27.000Z" itemprop="datePublished">2019-11-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/02/Create-my-vue/">Create my vue</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Create-my-vue"><a href="#Create-my-vue" class="headerlink" title="Create my vue"></a>Create my vue</h1><p>此章记录学习vue源码,并且实现简版的Vue</p>
<h2 id="vue-工作流程"><a href="#vue-工作流程" class="headerlink" title="vue 工作流程"></a>vue 工作流程</h2><img src="/static/img/vueProcess.png">

<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>初始化data, props, 事件等</p>
<h3 id="挂载"><a href="#挂载" class="headerlink" title="挂载"></a>挂载</h3><p>执行编译,首次渲染,创建和追加过程</p>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>编译模块分为三个阶段: parse, optimize, generate</p>
<h3 id="数据响应式"><a href="#数据响应式" class="headerlink" title="数据响应式"></a>数据响应式</h3><p>渲染函数执行时会触发getter进行依赖收集, 将来数据变化时,会触发setter进行更新.</p>
<h3 id="虚拟DOM"><a href="#虚拟DOM" class="headerlink" title="虚拟DOM"></a>虚拟DOM</h3><p>Vue2开始支持Virtual DOM, 通过JS对象描述DOM, 数据变更时映射为DOM操作.<br>真实DOM</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">name</span>=<span class="string">"div"</span> <span class="attr">style</span>=<span class="string">"color:red"</span> @<span class="attr">click</span>=<span class="string">"func"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span>&gt;</span>click<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>虚拟DOM</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    tag: &apos;div&apos;,  </span><br><span class="line">    props:&#123;</span><br><span class="line">       name:&apos;div&apos;,</span><br><span class="line">       style:&#123;color:red&#125;,</span><br><span class="line">       onClick:func</span><br><span class="line">    &#125;,</span><br><span class="line">    children: [</span><br><span class="line">       &#123;</span><br><span class="line">           tag: &apos;a&apos;,        </span><br><span class="line">           text: &apos;click me&apos;  </span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="更新视图"><a href="#更新视图" class="headerlink" title="更新视图"></a>更新视图</h3><p>数据修改时Watcher会执行更新,通过对比新旧VDOM,得到最小修改就是patch.</p>
<h2 id="Vue2-响应式的原理-defineProperty"><a href="#Vue2-响应式的原理-defineProperty" class="headerlink" title="Vue2 响应式的原理: defineProperty"></a>Vue2 响应式的原理: defineProperty</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">p</span>&gt;</span>hello<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">'name'</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> obj = &#123;&#125;;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">Object</span>.defineProperty(obj, <span class="string">"name"</span>, &#123;</span></span><br><span class="line"><span class="javascript">       <span class="keyword">get</span>() &#123;</span></span><br><span class="line"><span class="javascript">           <span class="built_in">console</span>.log(<span class="string">'获取name'</span>)</span></span><br><span class="line"><span class="javascript">           <span class="keyword">return</span> <span class="built_in">document</span>.querySelector(<span class="string">'#name'</span>).innerHTML;</span></span><br><span class="line">     </span><br><span class="line">        &#125;,</span><br><span class="line"><span class="javascript">       <span class="keyword">set</span>(nick) &#123;</span></span><br><span class="line"><span class="javascript">           <span class="built_in">console</span>.log(<span class="string">'设置name'</span>)</span></span><br><span class="line"><span class="javascript">           <span class="built_in">document</span>.querySelector(<span class="string">'#name'</span>).innerHTML = nick;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="javascript">    obj.name = <span class="string">"Richard"</span>;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(obj.name)</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="实现自己的vue"><a href="#实现自己的vue" class="headerlink" title="实现自己的vue"></a>实现自己的vue</h3><p>简化版架构图<br><img src="/static/img/vue.png"></p>
<ul>
<li>创建Myvue.js</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    new Myvue(&#123;</span></span><br><span class="line"><span class="comment">        data: &#123;</span></span><br><span class="line"><span class="comment">            msg: 'hello'</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    &#125;)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// Myvue类:</span></span><br><span class="line"><span class="comment">// 1. 对传入的data对象执行响应化处理</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Myvue</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(options) &#123;</span><br><span class="line">        <span class="comment">// 保存选项对象</span></span><br><span class="line">        <span class="keyword">this</span>.$options = options;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存data</span></span><br><span class="line">        <span class="keyword">this</span>.$data = options.data;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 对传入data对象执行响应化处理</span></span><br><span class="line">        <span class="keyword">this</span>.observe(<span class="keyword">this</span>.$data);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 测试  新建一个Watcher观察者对象,这时候Dep.target会指向这个Watcher对象</span></span><br><span class="line">        <span class="comment">// new Watcher(this, 'test')</span></span><br><span class="line">        <span class="comment">// this.test; // 读取属性,访问get函数，触发依赖收集</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Compile(options.el, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (options.created) &#123;</span><br><span class="line">            options.created.call(<span class="keyword">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    observe(value) &#123;</span><br><span class="line">        <span class="comment">// 参数必须是对象</span></span><br><span class="line">        <span class="keyword">if</span> (!value || <span class="keyword">typeof</span> value !== <span class="string">'object'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">Object</span>.keys(value).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 执行响应化</span></span><br><span class="line">            <span class="keyword">this</span>.defineReactive(value, key, value[key])</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 执行代理</span></span><br><span class="line">            <span class="keyword">this</span>.proxyData(key)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        obj: data 对象</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            data: &#123;</span></span><br><span class="line"><span class="comment">                test: 'aaa',</span></span><br><span class="line"><span class="comment">                foo: 'abc'</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    defineReactive(obj, key, val) &#123;</span><br><span class="line">        <span class="comment">// 递归判断</span></span><br><span class="line">        <span class="keyword">this</span>.observe(val);</span><br><span class="line">        <span class="comment">// 创建Dep,它 和key 的关系 1:1,每次defineReactive创建一个Dep实例</span></span><br><span class="line">        <span class="keyword">const</span> dep = <span class="keyword">new</span> Dep();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义属性</span></span><br><span class="line">        <span class="comment">// 参数3 是属性描述符,定义配置性,遍历性,可读,可写</span></span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">            <span class="keyword">get</span>() &#123;</span><br><span class="line">                <span class="comment">// 依赖收集, 将Dep.target(即当前的Watcher对象存入Dep的deps中)</span></span><br><span class="line">                Dep.target &amp;&amp; dep.addDep(Dep.target)</span><br><span class="line">                <span class="keyword">return</span> val;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="keyword">set</span>(newVal) &#123;</span><br><span class="line">                <span class="keyword">if</span> (newVal == val) &#123;</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">                val = newVal;</span><br><span class="line">                <span class="comment">// // 在set的时候触发dep的notify来通知所有的Watcher对象更新视图</span></span><br><span class="line">                dep.notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 在Vue实例上定义属性key, 实际就是保存一下$data里面的属性和值</span></span><br><span class="line">    proxyData(key) &#123;</span><br><span class="line">       <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>, key, &#123;</span><br><span class="line">           <span class="keyword">get</span>() &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">this</span>.$data[key]</span><br><span class="line">           &#125;,</span><br><span class="line">           <span class="keyword">set</span>(newVal) &#123;</span><br><span class="line">            <span class="keyword">this</span>.$data[key] = newVal</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>依赖收集与追踪</li>
</ul>
<img src="../static/img/dependency.png">

<p>在Vue 1.x中,一个属性对应一个dep,页面中出现多少个属性的引用，就有多少个watcher。 Dep就是Watcher的容器(一个Dep有多个Watcher)<br>在Vue 2.x中,一个组件对应一个Watcher。页面引用属性，会触发render函数返回虚拟DOM，当属性值改变之后也会触发render返回新的虚拟DOM，然后比较新旧虚拟DOM，再决定如何更新试图。这也是为什么Vue2需要引入虚拟DOM的原因。</p>
<p>现在实现的是Vue1.0里面的Dep和Watcher<br>创建 Dep</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Myvue.js</span></span><br><span class="line"><span class="comment">// Dep类 : 管理若干Watcher实例,通知他们更新</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="comment">// 存数所有的依赖</span></span><br><span class="line">        <span class="keyword">this</span>.deps = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在deps中添加一个监听器对象</span></span><br><span class="line">    addDep(dep) &#123;</span><br><span class="line">        <span class="keyword">this</span>.deps.push(dep);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通知所有监听器去更新视图</span></span><br><span class="line">    notify() &#123;</span><br><span class="line">        <span class="comment">// set 函数调用时触发</span></span><br><span class="line">        <span class="keyword">this</span>.deps.forEach(<span class="function"><span class="params">dep</span> =&gt;</span> dep.update())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 Watcher</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Myvue.js</span></span><br><span class="line"><span class="comment">// Watcher类 : 负责更新视图</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(vm, key, updater) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.vm = vm;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.updater = updater;</span><br><span class="line"></span><br><span class="line">        Dep.target = <span class="keyword">this</span>;  <span class="comment">// 在new一个监听器对象时将该对象赋值给Dep.target,在get中会用到</span></span><br><span class="line">        <span class="keyword">this</span>.vm[<span class="keyword">this</span>.key];</span><br><span class="line">        Dep.target = <span class="literal">null</span>; <span class="comment">// 避免watcher重复的加入到其他dep中。</span></span><br><span class="line">    &#125;</span><br><span class="line">    update() &#123;</span><br><span class="line">        <span class="keyword">this</span>.updater.call(<span class="keyword">this</span>.vm, <span class="keyword">this</span>.vm[<span class="keyword">this</span>.key])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>编译compile<br>过程:<img src="/static/img/compile.png">
核心任务:</li>
</ul>
<ol>
<li>获取并遍历DOM树</li>
<li>文本节点: 获取插值表达式的内容并解析</li>
<li>元素节点: 访问节点特性,截获k-和@开头内容并解析</li>
</ol>
<p>创建 compile.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// new Compile('#app', vm)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compile</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(el, vm) &#123;</span><br><span class="line">        <span class="keyword">this</span>.$vm = vm;</span><br><span class="line">        <span class="keyword">this</span>.$el = <span class="built_in">document</span>.querySelector(el);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.$el) &#123;</span><br><span class="line">            <span class="comment">// 执行编译</span></span><br><span class="line">            <span class="keyword">this</span>.compile(<span class="keyword">this</span>.$el);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    compile(el) &#123;</span><br><span class="line">        <span class="comment">// 遍历el</span></span><br><span class="line">        <span class="keyword">const</span> childNodes = el.childNodes;</span><br><span class="line">        <span class="built_in">Array</span>.from(childNodes).forEach(<span class="function"><span class="params">node</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 判断节点类型</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.isElement(node)) &#123;</span><br><span class="line">                <span class="comment">// 元素节点: 访问节点特性,并截获 k-和 @开头的内容并解析</span></span><br><span class="line">                <span class="keyword">this</span>.compileElement(node);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.isInter(node)) &#123;</span><br><span class="line">                <span class="comment">// 文本节点: 获取&#123;&#123;&#125;&#125;格式的内容并解析</span></span><br><span class="line">                <span class="keyword">this</span>.compileText(node);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 递归 如果子节点下面还有子节点就继续compile操作</span></span><br><span class="line">            <span class="keyword">if</span> (node.childNodes &amp;&amp; node.childNodes.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.compile(node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断是否是元素节点</span></span><br><span class="line">    isElement(node) &#123;</span><br><span class="line">        <span class="keyword">return</span> node.nodeType === <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断是否是插值表达式 &#123;&#123;&#125;&#125;</span></span><br><span class="line">    isInter(node) &#123;</span><br><span class="line">        <span class="keyword">return</span> node.nodeType === <span class="number">3</span> &amp;&amp; <span class="regexp">/\&#123;\&#123;(.*)\&#125;\&#125;/</span>.test(node.textContent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//  编译插值文本</span></span><br><span class="line">    compileText(node) &#123;</span><br><span class="line">        <span class="comment">// 获取表达式 exp 正则表达式匹配的内容</span></span><br><span class="line">        <span class="comment">// &#123;&#123;a+b()&#125;&#125;</span></span><br><span class="line">        <span class="keyword">const</span> exp = <span class="built_in">RegExp</span>.$<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">this</span>.update(node, exp, <span class="string">"text"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通用更新函数,根据指令决定调用哪个更新器 update(node, 'xxx', 'text')</span></span><br><span class="line">    update(node, exp, dir) &#123;</span><br><span class="line">        <span class="comment">// 构造更新函数并执行: 相当于首次赋值</span></span><br><span class="line">        <span class="keyword">let</span> updaterFunc = <span class="keyword">this</span>[dir + <span class="string">'Updater'</span>];</span><br><span class="line">        updaterFunc &amp;&amp; updaterFunc(node, <span class="keyword">this</span>.$vm[exp]);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建watcher,执行后续更新操作</span></span><br><span class="line">        <span class="comment">// 额外传递一个更新函数: 能够更新指定dom元素</span></span><br><span class="line">        <span class="keyword">new</span> Watcher(<span class="keyword">this</span>.$vm, exp, <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">            updaterFunc &amp;&amp; updaterFunc(node, value);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 插值文本更新器</span></span><br><span class="line">    textUpdater(node, value) &#123;</span><br><span class="line">        node.textContent = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 编译元素节点,解析指令</span></span><br><span class="line">    compileElement(node) &#123;</span><br><span class="line">        <span class="comment">// 获取属性</span></span><br><span class="line">        <span class="keyword">const</span> nodeAttrs = node.attributes;</span><br><span class="line">        <span class="built_in">Array</span>.from(nodeAttrs).forEach(<span class="function"><span class="params">attr</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// k-text = "test"</span></span><br><span class="line">            <span class="keyword">const</span> attrName = attr.name; <span class="comment">//k-text</span></span><br><span class="line">            <span class="keyword">const</span> exp = attr.value; <span class="comment">//test</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (attrName.indexOf(<span class="string">'k-'</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 指令k-text k-model</span></span><br><span class="line">                <span class="keyword">const</span> dir = attrName.slice(<span class="number">2</span>); <span class="comment">//text</span></span><br><span class="line">                <span class="keyword">this</span>[dir] &amp;&amp; <span class="keyword">this</span>[dir](node, exp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    text(node, exp) &#123;</span><br><span class="line">        <span class="keyword">this</span>.update(node, exp, <span class="string">"text"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/02/Create-my-vue/" data-id="ckh44mzso00044sv2s1dimgiw" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Problems-in-working" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/02/Problems-in-working/" class="article-date">
  <time datetime="2019-11-02T05:14:36.000Z" itemprop="datePublished">2019-11-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/02/Problems-in-working/">Problems in working</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Problems-in-working"><a href="#Problems-in-working" class="headerlink" title="Problems in working"></a>Problems in working</h1><p>此章用于总结工作中遇到的问题.</p>
<h2 id="Vuex-Don’t-mutate-vuex-store-state-outside-mutation-handler"><a href="#Vuex-Don’t-mutate-vuex-store-state-outside-mutation-handler" class="headerlink" title="[Vuex]:  Don’t mutate vuex store state outside mutation handler"></a>[Vuex]:  Don’t mutate vuex store state outside mutation handler</h2><ul>
<li><p>问题产生的原因:<br>在mutations 之外改变了vuex store state中的数据,就会产生这个报错,而且 这个只会在strict: true 的时候产生.</p>
</li>
<li><p>配置strict:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  strict: <span class="literal">true</span>,</span><br><span class="line">  modules: &#123;</span><br><span class="line">    add: add,</span><br><span class="line">    test: test</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>现象:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      formModel: &#123;</span><br><span class="line">        <span class="string">'test'</span>: <span class="string">''</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    changeStoreValue() &#123;</span><br><span class="line">      <span class="keyword">this</span>.formModel[<span class="string">'test'</span>] = <span class="string">'hello'</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.formModel[<span class="string">'test'</span>])</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.$store.state.test.storeValue)</span><br><span class="line">    &#125;,</span><br><span class="line">    printVal() &#123;</span><br><span class="line">      <span class="comment">// 这种写法 改变this.formModel 也会引发 Vuex warning : Don't mutate vuex store state outside mutation handler</span></span><br><span class="line">      <span class="comment">// 实际上就是: arry变量 使用了 this.formModel 的引用 ,当arry 成为state后, this.formModel的值改变,arry也会跟着改变</span></span><br><span class="line">      <span class="comment">// 因此会引发上述的vuex warning,这种比较难发现,因此要注意.</span></span><br><span class="line">      <span class="keyword">let</span> arry = [<span class="keyword">this</span>.formModel]</span><br><span class="line">      <span class="comment">// 使用以下写法</span></span><br><span class="line">      <span class="comment">// let arrt = [Object.assign(&#123;&#125;, this.formModel)]</span></span><br><span class="line">      <span class="keyword">this</span>.$store.commit(<span class="string">'test/setStoreValue'</span>, arry)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>解决方法: </p>
</li>
</ul>
<ol>
<li><p>state中存的是基本数据类型 boolean, string, number 重新赋值给新的变量, 通过操作新的变量达到处理数据的目的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设 this.$store.state.test.message = ''</span></span><br><span class="line"><span class="keyword">let</span> newVal = <span class="keyword">this</span>.$store.state.test.message</span><br></pre></td></tr></table></figure>
</li>
<li><p>state 中存的是引用数据类型, array, object (注:null 也是 object)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设 this.$store.state.test.message = []</span></span><br><span class="line"><span class="comment">// 方法一: </span></span><br><span class="line"><span class="comment">// slice 方法: 会返回一个新的数组.一块新的内存空间,这样改变newArray时 不会改动this.$store.state.test.message</span></span><br><span class="line"><span class="keyword">let</span> newArray = <span class="keyword">this</span>.$store.state.test.message.slice()</span><br><span class="line"><span class="comment">// 方法二: </span></span><br><span class="line"><span class="comment">// Object.assign()方法 用于将所有可枚举属性的值从一个或多个源对象复制到目标对象。它将返回目标对象。</span></span><br><span class="line"><span class="keyword">let</span> newArray = <span class="built_in">Object</span>.assign([], <span class="keyword">this</span>.$store.state.test.message)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设 this.$store.state.test.message = &#123;&#125;</span></span><br><span class="line"><span class="keyword">let</span> newObj = <span class="built_in">Object</span>.assign(&#123;&#125;, <span class="keyword">this</span>.$store.state.test.message)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>总结:<br>在解决vuex store mutation的问题时,实际上就变成了对基本数据类型和引用数据类型的处理的问题.<br>基本数据类型string,number,boolean在赋值之后,会分配一块新的内存空间来存储值,因此改变新的变量和原来的变量相互不影响.<br>引用数据类型array,object,在赋值操作之后, 并不会分配一块新的内存空间,而是将旧的变量的引用(也可以叫内存地址)赋给新的变量,因此新旧两个变量改变时,会互相影响. 因此在编程时,要尤其注意,修改一个对象或数组后,要考虑是否会改变原来的值,原来的值在之后使用可能又会影响其他的值.所以我们要操作一个引用型的数据时要做一个副本的拷贝的工作,以保证原来的值不会以一种难以发现的方式被修改,以致于混乱。</p>
<h1 id="problems-in-work"><a href="#problems-in-work" class="headerlink" title="problems-in-work"></a>problems-in-work</h1><p>Be used to record problems in working</p>
<h1 id="vuetify"><a href="#vuetify" class="headerlink" title="vuetify"></a>vuetify</h1><p>Vuetify 设置v-flex 内容(图片文字)垂直居中， 使用 d-flex 和 align-center<br>ex: <v-flex d-flex align-center></v-flex></p>
<h1 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h1><p>Your identification has been saved in /home/richard/.ssh/id_rsa.<br>Your public key has been saved in /home/richard/.ssh/id_rsa.pub.<br>password:123456</p>
<h1 id="git操作"><a href="#git操作" class="headerlink" title="git操作"></a>git操作</h1><h2 id="本地创建git仓库"><a href="#本地创建git仓库" class="headerlink" title="本地创建git仓库"></a>本地创建git仓库</h2><p>git init</p>
<h2 id="创建远程仓库"><a href="#创建远程仓库" class="headerlink" title="创建远程仓库"></a>创建远程仓库</h2><p>git remote add origin <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a>:cokelovejoy/cokelovejoy.github.io.git<br>(创建 名为origin的远程仓库, 该远程仓库连接到github地址的代码库)<br>git push -u origin master (将本地的master分支推送到origin主机，同时指定origin为默认主机)</p>
<h2 id="拉取远程仓库代码到本地"><a href="#拉取远程仓库代码到本地" class="headerlink" title="拉取远程仓库代码到本地"></a>拉取远程仓库代码到本地</h2><p>git pull origin master</p>
<h2 id="创建本地分支并切换"><a href="#创建本地分支并切换" class="headerlink" title="创建本地分支并切换"></a>创建本地分支并切换</h2><p>git checkout -b dev<br>git checkout -b dev origin/dev </p>
<h2 id="拉取远程仓库代码"><a href="#拉取远程仓库代码" class="headerlink" title="拉取远程仓库代码"></a>拉取远程仓库代码</h2><p>git pull origin dev</p>
<h2 id="分支操作"><a href="#分支操作" class="headerlink" title="分支操作"></a>分支操作</h2><p>git branch （查看当前分支）<br>git branch -r（查看远程分支）<br>git branch -a (查看所有分支)<br>git branch –set-upstream-to=origin/远程分支名 本地分支名 (git 将本地分支关联到远程分支)<br>git checkout dev （切换到已经存在的分支）<br>git checkout -b dev （在本地创建新分支，并切换到该分支）<br>git checkout -b dev origin/dev (基于远程origin/dev分支新建本地dev分支)</p>
<h2 id="拉取-提交操作"><a href="#拉取-提交操作" class="headerlink" title="拉取,提交操作"></a>拉取,提交操作</h2><p>git pull (将远程分支上的代码拉到本地)<br>git add -A<br>git commit -m’xxxx’<br>git push origin xxxbranch-name<br>git push -u origin master 命令将本地的master分支推送到origin主机，同时指定origin为默认主机，后面就可以不加任何参数使用git push了。<br>git push –set-upstream origin dev-01(当远程没有该分支的时候，会在远程库里创建这个分支如dev-01,然后再推送文件，origin 是远程主机名)<br>git push origin dev-branch（origin表示远程主机名， dev-branch表示本地分支名）<br>git push origin（如果当前分支与远程分支存在追踪关系，则本地分支和远程分支都可以省略，将当前分支推送到origin主机的对应分支）<br>git push（如果当前分支只有一个远程分支，那么主机名都可以省略，形如 git push，可以使用git branch -r ，查看远程的分支名）</p>
<h2 id="解决冲突"><a href="#解决冲突" class="headerlink" title="解决冲突"></a>解决冲突</h2><p>git add file-name之后，如果取消add 使用git reset file-name即可<br>git commit -m ‘message’ 之后，如果要取消 commit<br>先使用git log 查看commit 历史记录<br>然后使用 git reset 404b1f29b3066ec19b07c3ddf76510d97c5643b1<br>（倒数第二次记录的commit哈希值），即可恢复到上一次commit。</p>
<h2 id="pull-request-merge-conflict"><a href="#pull-request-merge-conflict" class="headerlink" title="pull request merge conflict"></a>pull request merge conflict</h2><p>当pull request 为branch1 指向 branch2 时，发生冲突，需要解决冲突，将branch2 的代码 pull到brach1,在branch1上解决冲突，保留branch2上的代码。然后提交。<br>之后再在branch1上做修改，把原来的冲突代码写回来。branch2 的代码始终不能改变的。<br>step1： 拉取远程分支branch2的代码，然后合并到branch1，然后解决冲突。<br>git checkout branch1<br>git pull origin branch2<br>step2：提交改变，add，commit，push,然后 branch2 的代码 就会合并到branch1上。<br>git add -a<br>git commit -m’xxx’<br>git push origin HEAD   // HEAD为当前分支的简称</p>
<h2 id="查看信息"><a href="#查看信息" class="headerlink" title="查看信息"></a>查看信息</h2><p>git log （查看commit提交记录）<br>git status （查看本地库文件的更改状态）<br>git diff （显示提交之间、提交和工作区之间等的差异）<br>git remote -v （显示对应的克隆地址）<br>git remote （列出每个远程库的简短名字。在克隆完某个项目后，至少可以看到一个名为 origin 的远程库，Git 默认使用这个名字来标识你所克隆的原始仓库）<br>git remote show origin (查看某一个远程仓库的更多信息)</p>
<h2 id="merge用法"><a href="#merge用法" class="headerlink" title="merge用法"></a>merge用法</h2><p>一, 开发分支(dev)上的代码达到上线的标准,合并到master分支<br>git checkout dev<br>git pull<br>git checkout master<br>git merge dev<br>git push -u origin master</p>
<p>二,当master代码改动了,需要更新开发分支(dev)上的代码<br>git checkout master<br>git pull<br>git checkout dev<br>git merge master<br>git push -u origin dev</p>
<h2 id="暂存"><a href="#暂存" class="headerlink" title="暂存"></a>暂存</h2><p>git stash<br>git stash pop</p>
<h2 id="配置config"><a href="#配置config" class="headerlink" title="配置config"></a>配置config</h2><p>git config –global user.name ‘richard’<br>git config –global user.email ‘847035485@qq.com’<br>git config –list</p>
<p>工作笔记 ：</p>
<h1 id="软链接"><a href="#软链接" class="headerlink" title="软链接"></a>软链接</h1><p>全局安装@vue/cli之后显示没有 找不到vue命令。<br>解决方法： 将安装的全局包建立软连接： sudo ln -s /home/richard/npm-global/bin/vue /usr/local/bin/vue<br>建立成功会在/usr/local/bin/vue下生成vue文件。</p>
<h1 id="箭头函数"><a href="#箭头函数" class="headerlink" title="箭头函数"></a>箭头函数</h1><p>箭头函数内的this,在定义的时候决定的.绑定定义时所在的作用域的this.<br>其他函数 的this ,是使用的时候所在的作用域的this.<br>箭头函数不能用于构造函数.</p>
<h1 id="rest"><a href="#rest" class="headerlink" title="rest"></a>rest</h1><p>rest参数, 把实参放入到数组中<br>…arr<br>function fn(…arr) {<br>    console.log(arr)<br>}<br>fn(1,2,3)<br>不用再使用arguments</p>
<h1 id="对象合并"><a href="#对象合并" class="headerlink" title="对象合并"></a>对象合并</h1><p>Object.assign(target, source)</p>
<h1 id="扩展运算符"><a href="#扩展运算符" class="headerlink" title="扩展运算符"></a>扩展运算符</h1><p>数组的扩展<br>let arr = [1,2,3]<br>let arr2 = […arr]<br>对象的扩展<br>let obj1 = {a:1}<br>let obj2 = {b:2}<br>let obj = {…obj1,…obj2}</p>
<h1 id="数组的方法"><a href="#数组的方法" class="headerlink" title="数组的方法"></a>数组的方法</h1><p>ES5方法<br>map() , filter(), reduce(), every(), some()</p>
<p>ES6方法<br>find(), findIndex()</p>
<p>//find 找到符合条件的第一个.<br>let arr = [1,2,3,4,5,6]<br>arr.find(function(item,index){<br>    return item &lt;3<br>})</p>
<p>indexOf()方法 返回字符串,或数组中某个值第一次出现的index,没有返回-1<br>let a= [1,2,3,4]<br>a.indexOf(4) //3</p>
<p>查找使用includes() 代替indexOf() 效率更高</p>
<h1 id="nextTick"><a href="#nextTick" class="headerlink" title="$nextTick"></a>$nextTick</h1><p>Vue $nextTick():<br>主要用于数据改变之后需要操作DOM,DOM操作作为回调函数写入$nextTick()</p>
<h1 id="vuex-store"><a href="#vuex-store" class="headerlink" title="vuex store"></a>vuex store</h1><p>Vuex store中的数据在页面刷新后会消失,如果要让它不消失,需要使用插件将对store中的数据做持久化操作,在页面刷新之前保存到localStorage.</p>
<h1 id="Mouse-Event"><a href="#Mouse-Event" class="headerlink" title="Mouse Event"></a>Mouse Event</h1><p>Mouse Event 对象的属性clengtX和pageX和screenX和offsetX的区别:<br>clientX 设置或获取鼠标指针位置相对于浏览器内容窗口的 x 坐标，其中客户区域不包括窗口自身的控件和滚动条。</p>
<p>clientY 设置或获取鼠标指针位置相对于浏览器内容窗口的 y 坐标，其中客户区域不包括窗口自身的控件和滚动条。<br>(跟screenX相比就是将参照点改成了浏览器内容区域的左上角，该参照点会随之滚动条的移动而移动，也就是说，他计算left或top时直接忽略了滚动条的高和宽，它的参考点是浏览器可见区域的左上角，而不是页面本身的body左上角原点，计算数值和滚动条是否滚动没有关系，只是绝对的计算鼠标点距离浏览器内容区域的左上角的距离，忽略了滚动条的存在)</p>
<p>offsetX 设置或获取鼠标指针位置相对于触发事件的对象的 x 坐标。<br>offsetY 设置或获取鼠标指针位置相对于触发事件的对象的 y 坐标。</p>
<p>screenX 设置或获取获取鼠标指针位置相对于用户屏幕的 x 坐标。<br>screenY 设置或获取鼠标指针位置相对于用户屏幕的 y 坐标。</p>
<p>pageX：参照点是页面本身左上角的原点.已经把滚动条滚过的高或宽计算在内.</p>
<p>所以基本可以得出结论：<br>pageX &gt; clientX, pageY &gt; clientY<br>pageX = clientX + ScrollLeft(滚动条滚过的水平距离)<br>pageY = clientY + ScrollTop(滚动条滚过的垂直距离)</p>
<h1 id="contenteditable"><a href="#contenteditable" class="headerlink" title="contenteditable"></a>contenteditable</h1><p>HTML 全局属性contenteditable  是一个枚举属性，表示元素是否可被用户编辑。 如果可以，浏览器会修改元素的部件以允许编辑。<br><label contenteditable="true">Example Label</label></p>
<h1 id="获取光标所在的位置"><a href="#获取光标所在的位置" class="headerlink" title="获取光标所在的位置"></a>获取光标所在的位置</h1><p>const selection = window.getSelection() ; //返回一个Selection对象,对象里面有一些属性可以用来取到光标所在的元素或者光标所在位置或者覆盖的文字</p>
<ul>
<li>selection对象<br>Selection对象表示用户选择的文本范围或插入符号的当前位置。它代表页面中的文本选区，可能横跨多个元素。文本选区由用户拖拽鼠标经过文字而产生。要获取用于检查或修改的Selection对象，请调用 window.getSelection()。</li>
<li>range对象<br>文档中用户选择的区域(拖蓝). 获取当前选中的范围 let range = selection.getRangeAt(0)<br>属性: selection.rangeCount 返回当前选中区域的数量<br>方法: selection.getRangeAt(0), 返回选区开始的节点.<br>selection.delectionFromDocument(), 从页面中删除选区中的内容.</li>
</ul>
<h1 id="event-preventDefault"><a href="#event-preventDefault" class="headerlink" title="event.preventDefault()"></a>event.preventDefault()</h1><p>event.preventDefault().阻止事件的默认行为.</p>
<h1 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h1><p>有些符号在URL中是不能直接传递的，如果要在URL中传递这些特殊符号，那么就要使用他们的编码了。<br>编码的格式为：%加字符的ASCII码，即一个百分号%，后面跟对应字符的ASCII（16进制）码值。例如 空格的编码值是”%20”。<br>如果不使用转义字符，这些编码就会当URL中定义的特殊字符处理。<br>下表中列出了一些URL特殊符号及编码 十六进制值</p>
<p>1) + URL 中+号表示空格 %2B<br>2) 空格 URL中的空格可以用+号或者编码 %20<br>3) / 分隔目录和子目录 %2F<br>4) ? 分隔实际的 URL 和参数 %3F<br>5) % 指定特殊字符 %25<br>6) # 表示书签 %23<br>7) &amp; URL 中指定的参数间的分隔符 %26<br>8) = URL 中指定参数的值 %3D</p>
<h1 id="Vue-scoped-css"><a href="#Vue-scoped-css" class="headerlink" title="Vue scoped css"></a>Vue scoped css</h1><p>在style标签中使用 scoped以实现css模块化,原理是给标签打上 tag.<br>问题有时候会因为标签打上了,而找不到标签,导致设置class没有作用,因此使用scoped要仔细考虑.<br>(通过PostCSS来实现这种转换)<br><a href="https://vue-loader.vuejs.org/en/features/scoped-css.html3" target="_blank" rel="noopener">https://vue-loader.vuejs.org/en/features/scoped-css.html3</a> vue-loader的官方文档中也说了这个问题 所以使用 &gt;&gt;&gt; 符号可以做到，但是注意vue-loader的版本要高于12.2.0 这个功能是这个版本后才具有的.<br>scoped三条渲染规则：<br>　　1、给HTML的DOM节点加一个不重复data属性(形如：data-v-19fca230)来表示他的唯一性<br>　　2、在每句css选择器的末尾（编译后的生成的css语句）加一个当前组件的data属性选择器（如[data-v-19fca230]）来私有化样式<br>　　3、如果组件内部包含有其他组件，只会给其他组件的最外层标签加上当前组件的data属性</p>
<h1 id="npm全局安装包的位置"><a href="#npm全局安装包的位置" class="headerlink" title="npm全局安装包的位置"></a>npm全局安装包的位置</h1><p>使用npm root -g 进行查询</p>
<h1 id="npm-更新版本到最新"><a href="#npm-更新版本到最新" class="headerlink" title="npm 更新版本到最新"></a>npm 更新版本到最新</h1><p>npm install npm@latest -g</p>
<h1 id="node"><a href="#node" class="headerlink" title="node"></a>node</h1><p>输入命令sudo npm install n -g，来安装n这个工具，n可以切换node版本<br>输入命令sudo n stable，安装最新稳定版的nodejs<br>重启终端，查看node.js和npm版本,node –version,npm  –version</p>
<h1 id="Vue-forceUpdate"><a href="#Vue-forceUpdate" class="headerlink" title="Vue: $forceUpdate()"></a>Vue: $forceUpdate()</h1><p>对象深层的数据改变,Vue无法监听,用于强制更新数据</p>
<h1 id="Vue-refs"><a href="#Vue-refs" class="headerlink" title="Vue: $refs"></a>Vue: $refs</h1><p>$refs在template和computed属性中使用无效,它不是响应式的。</p>
<h1 id="Vue-native-事件修饰符"><a href="#Vue-native-事件修饰符" class="headerlink" title="Vue: native 事件修饰符"></a>Vue: native 事件修饰符</h1><p>在组件上使用 v-on 只会监听自定义事件 (组件用 $emit 触发的事件)。如果要监听根元素的原生事件，可以使用 .native 修饰符<br>.native事件修饰符只能修饰组件，不能使用到div原生标签上。</p>
<h1 id="vue中父组件通过props向子组件传异步值为空的问题"><a href="#vue中父组件通过props向子组件传异步值为空的问题" class="headerlink" title="vue中父组件通过props向子组件传异步值为空的问题"></a>vue中父组件通过props向子组件传异步值为空的问题</h1><p>因为父组件的值是通过axios请求获得，当父组件拿到处理后的值时，子组件钩子函数生命周期已经走完。因此通过props传递给子组件，在子组件的生命周期中无法访问到异步获取的值。但是在页面上是能渲染父组件传递的异步数据。</p>
<p>解决方案：通过v-if 判断值，当值有的时候再渲染子组件。<br>还可以通过Vuex。</p>
<h1 id="关于dialog-弹窗的几点思考"><a href="#关于dialog-弹窗的几点思考" class="headerlink" title="关于dialog 弹窗的几点思考"></a>关于dialog 弹窗的几点思考</h1><ol>
<li>dialog关闭 是否还需要 弹窗组件</li>
<li>由子组件通过emit事件触发父组件通过v-if 销毁整个组件。还是父组件通过$refs控制子组件中dialog的显隐，第3点解释了两种实现方式不同的原理。</li>
<li>v-if 的切换组件，会销毁组件内的数据，再打开组件时，组件的生命周期会重新走一次。</li>
</ol>
<h1 id="localStorage"><a href="#localStorage" class="headerlink" title="localStorage"></a>localStorage</h1><p>localStorage只能保存字符串，对于对象要用JSON.stringify和JSON.parse</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/02/Problems-in-working/" data-id="ckh44mzt3000a4sv2ajqpnk5r" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Vue介绍" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/24/Vue介绍/" class="article-date">
  <time datetime="2019-10-24T02:18:25.000Z" itemprop="datePublished">2019-10-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/24/Vue介绍/">Vue介绍</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Vue"><a href="#Vue" class="headerlink" title="Vue"></a>Vue</h2><p>一套用于构建用户界面的渐进式框架</p>
<ul>
<li>特点</li>
</ul>
<ol>
<li>构建用户界面,关注View层</li>
<li>简单易学,简洁,轻量, 快速</li>
<li>渐进式框架</li>
</ol>
<h2 id="库和框架"><a href="#库和框架" class="headerlink" title="库和框架"></a>库和框架</h2><ul>
<li><p>库<br>库是一些封装好的特定方法的集合,用于实现特定功能,提供给开发者使用, 库没有控制权,控制权在使用者的手中. 代表: jQuery, underscore, util</p>
</li>
<li><p>框架<br>框架就是一套架构,会基于自身的特点向用户提供一套相当完整的解决方案.而且控制权在框架本身,使用者要按照框架所规定的某种规范进行开发.代表: backbone, react, angular, vue</p>
</li>
</ul>
<p>框架和库的关系: 框架包含库.</p>
<h2 id="理解渐进式"><a href="#理解渐进式" class="headerlink" title="理解渐进式"></a>理解渐进式</h2><ol>
<li>声明式渲染</li>
<li>组件系统</li>
<li>客户端路由</li>
<li>大规模状态管理</li>
<li>构建工具</li>
</ol>
<h2 id="Vue两个核心点"><a href="#Vue两个核心点" class="headerlink" title="Vue两个核心点"></a>Vue两个核心点</h2><ol>
<li><p>响应式的数据绑定<br> 当数据发生变化时 -&gt; 视图自动更新<br> 专注于操作数据, 忘记操作DOM</p>
</li>
<li><p>可组合的视图组件<br> 把视图按功能切分若干基本单元组件<br> 组件可以一级一级组合成整个应用, 形成组件树<br> 使用组件的好处: 可维护, 可重用, 可测试.</p>
</li>
</ol>
<h2 id="MVVM模式"><a href="#MVVM模式" class="headerlink" title="MVVM模式"></a>MVVM模式</h2><p>M: Model数据<br>V: view视图<br>vm:view-Model视图模型 (control)<br>视图(DOM) (数据绑定,DOM监听)     准备数据<br>v———————&gt; vm ——————–&gt;model<br>v&lt;——————— vm &lt;——————–model</p>
<h2 id="Vue指令"><a href="#Vue指令" class="headerlink" title="Vue指令"></a>Vue指令</h2><p>指令: 是一种特殊的自定义行间属性,以 v-开头<br>将数据和DOM关联,当表达式的值改变时,响应式地作用在视图.<br>预期的值为javaScript表达式 (表达式是一定会返回值的)</p>
<ul>
<li><p>v-bind &amp; v-on<br>v-bind:msg=”message” 绑定属性 , 属性值动态改变, 简写 :msg=”message”<br>v-on:click=”funcHandler” 绑定事件, 事件处理函数的第一个参数是触发事件的DOM中的event对象.<br>简写 @click=”funcHandler”<br>event.target: 返回触发此事件的事件源元素.<br>当在模板中给事件处理函数传递其他参数时,需要把$event作为第一个参数传入.<br>methods 中的方法中的this 都指向当前组件实例</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 不传参数 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"funcHandler1"</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 传参 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"funcHandler2($event, value)"</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">    methods: &#123;</span><br><span class="line"><span class="javascript">        <span class="comment">// event 是 $event ,事件对象</span></span></span><br><span class="line">        funcHandler1(event) &#123;</span><br><span class="line">            pass</span><br><span class="line">        &#125;,</span><br><span class="line"><span class="javascript">        <span class="comment">// event 是 $event ,事件对象</span></span></span><br><span class="line">        funcHandler2(event, params) &#123;</span><br><span class="line">            pass</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>v-model<br>双向数据绑定<br>Vue 将数据对象 和DOM进行绑定:<br>数据的改变会引起DOM的改变<br>DOM的改变也会引起数据的变化<br>v-model<br>在表单元素上创建双向数据绑定,也可以用于组件 :<br>  数据 —&gt; 页面<br>  页面 —&gt; 数据</p>
</li>
<li><p>v-for<br>循环渲染数据,可以循环数组,也可以循环对象</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">v-for</span>=<span class="string">"(item, index) of items"</span> <span class="attr">:key</span>=<span class="string">"key"</span>&gt;</span>&#123;&#123; item &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">v-for</span>=<span class="string">"(item, index) in items"</span> <span class="attr">:key</span>=<span class="string">"key"</span>&gt;</span>&#123;&#123; item &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">v-for</span>=<span class="string">"(item, key, index) in obj"</span> <span class="attr">:key</span>=<span class="string">"key"</span>&gt;</span>&#123;&#123; item &#125;&#125;--&#123;&#123; key &#125;&#125;--&#123;&#123; index &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>v-if 和 v-show<br>条件判断<br>v-if = “表达式”<br>v-show = “表达式”<br>v-if : 根据表达式的值的真假条件渲染元素和移除元素,表达式为false时,元素会真正的被移除.<br>v-show : 根据表达式的值的真假条件,切换元素的CSS属性,表达式为 false时, 相当于设置style属性: display:none;<br>初始页面根据条件判断是否要渲染某一块的组件时,使用v-if ,使用情况: 较少的操作DOM.<br>频繁的切换组件的显示隐藏,就使用v-show.</p>
</li>
</ul>
<h2 id="对象的响应数据变化"><a href="#对象的响应数据变化" class="headerlink" title="对象的响应数据变化"></a>对象的响应数据变化</h2><p>只有在data里面声明的数据,才能做响应<br>data对象中的数据都会被转换成 getter/setter, 所以数据变化时,才会自动更新在页面中.<br>如果对象中没有定义某个属性,直接通过赋值新增的属性,就不能检测到该属性的变化.</p>
<ul>
<li><p>直接给对象新增属性,并不能响应化</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.obj.newattr = <span class="string">'new msg'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>调用Vue的静态方法set</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Vue.set(targetObj, property, value)</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用实例上的$set方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$<span class="keyword">set</span>(targetObj, property, value)</span><br></pre></td></tr></table></figure>
</li>
<li><p>给对象重新赋新的对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.obj = <span class="built_in">Object</span>.assign(&#123;&#125;, vm.obj, &#123;<span class="attr">msg</span>: <span class="string">'new msg'</span>&#125;)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="数组的响应数据变化"><a href="#数组的响应数据变化" class="headerlink" title="数组的响应数据变化"></a>数组的响应数据变化</h2><ul>
<li>数组的变异方法<br>vue中提供了观察数组的变异方法,使用这些方法将会触发视图更新push(), pop(),shift(), unshift(), sort(), splice(), reverse(),这些方法会改变原数组.<br>因为Vue内部对以上七个方法做了一些扩展,使得只有在使用以上方法改变数组时,视图才会更新.</li>
</ul>
<ol>
<li>不能触发视图更新的情况<br>利用索引直接设置一个项时<br>修改数组的长度时<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vm.arr.push(<span class="number">1000</span>)</span><br><span class="line"><span class="comment">// 通过下标改变值,并不会让视图更新</span></span><br><span class="line">vm.list[<span class="number">0</span>] = <span class="string">'test'</span></span><br><span class="line"><span class="comment">// 使用splice()方法可以改变数组,并且视图会更新数据</span></span><br><span class="line">vm.list.splice(<span class="number">0</span>,<span class="number">1</span>,<span class="string">"test"</span>)</span><br><span class="line"><span class="comment">// 改变数组的长度也不能改变视图更新 (如果之后使用了其他的变异方法,会使数组更新,使视图更新)</span></span><br><span class="line">vm.list.length = <span class="number">1</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="动态绑定class"><a href="#动态绑定class" class="headerlink" title="动态绑定class"></a>动态绑定class</h2><ul>
<li>v-bind:class= “{classname: 表达式}”<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div :class=<span class="string">"&#123; red: isRed &#125;"</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;div :class=<span class="string">"[classA, classB]"</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;div :class=<span class="string">"[classA, &#123; classB: isB, classC: isC &#125;]"</span>&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="动态绑定style"><a href="#动态绑定style" class="headerlink" title="动态绑定style"></a>动态绑定style</h2><ul>
<li>v-bind:style= “{样式名: 样式值}”<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- style 绑定 --&gt;</span><br><span class="line">&lt;div :style=<span class="string">"&#123; fontSize: size + 'px' &#125;"</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;div :style=<span class="string">"[styleObjectA, styleObjectB]"</span>&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="删除对象的实例属性"><a href="#删除对象的实例属性" class="headerlink" title="删除对象的实例属性"></a>删除对象的实例属性</h2><ul>
<li>$delete<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$<span class="keyword">delete</span>(<span class="keyword">this</span>.obj, key)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="计算属性Computed"><a href="#计算属性Computed" class="headerlink" title="计算属性Computed"></a>计算属性Computed</h2><p>计算属性用于 当模板中 对一个data有过多的逻辑操作时,将其写成函数的形式,在函数内部先进行具体的数据处理,最后再返回.<br>计算属性写法类似函数,实际上不是函数.</p>
<ul>
<li>计算属性的特点:</li>
</ul>
<ol>
<li>可以缓存(当模板中多次使用计算属性时,计算属性只会计算一次,将返回的结果缓存起来,直到有依赖的数据变化时,重新计算.也就是说除了第一次使用computed,会进行计算以外,其他使用computed的值是直接返回的缓存的值,不用再进行计算)</li>
<li>依赖数据的变化,数据变化,计算属性就会重新计算.</li>
</ol>
<ul>
<li>计算属性的两个操作:</li>
</ul>
<ol>
<li>取值(get()), 只有一个函数时,默认就是触发的get()</li>
<li>设置值(set())</li>
</ol>
<ul>
<li>例子<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#example'</span>,</span><br><span class="line">  data: &#123;</span><br><span class="line">    message: <span class="string">'Hello'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  computed: &#123;</span><br><span class="line">    <span class="comment">// 计算属性的 getter, 只有一个函数 默认就是getter</span></span><br><span class="line">    reversedMessage: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// `this` 指向 vm 实例</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.message.split(<span class="string">''</span>).reverse().join(<span class="string">''</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    handleMessage: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 取值</span></span><br><span class="line">        <span class="keyword">get</span>() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.message</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">set</span>(newVal) &#123;</span><br><span class="line">            <span class="keyword">this</span>.message = newVal</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Vue-响应式原理"><a href="#Vue-响应式原理" class="headerlink" title="Vue 响应式原理"></a>Vue 响应式原理</h2><p>把一个普通的JavaScript对象传给Vue实例的data选项.Vue将遍历此对象所有的属性, 并用Object.defineProperty把这些属性全部转为getter/setter. Vue内部会对这些数据进行数据劫持操作,进而追踪依赖,在属性被访问和修改时,通知变化.</p>
<ul>
<li><p>对数据操作时,要先对数据进行劫持(代理)<br>Object.defineProperty() 方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性， 并返回这个对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dataValue;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(data, <span class="string">'keyName'</span>, &#123;</span><br><span class="line">    <span class="comment">// 数据描述符</span></span><br><span class="line">    value: <span class="string">'hello'</span>,     <span class="comment">// 设置属性值,默认为undefined</span></span><br><span class="line">    writable: <span class="literal">false</span>,    <span class="comment">// 默认为false,不可改写</span></span><br><span class="line">    enumerable: <span class="literal">false</span>,  <span class="comment">// 默认为false,不可枚举</span></span><br><span class="line">    configurable: <span class="literal">false</span>, <span class="comment">// 默认为false,不可以删除属性</span></span><br><span class="line">    <span class="comment">// 存取描述符 get,set默认为undifined,数据描述符和存取描述符不能混合使用</span></span><br><span class="line">    <span class="comment">// get: function () &#123;</span></span><br><span class="line">    <span class="comment">//     return dataValue</span></span><br><span class="line">    <span class="comment">// &#125;,</span></span><br><span class="line">    <span class="comment">// set: function (newVal) &#123;</span></span><br><span class="line">    <span class="comment">//     dataValue = newVal</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>数据劫持</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Observer</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">Object</span>.keys(obj).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">        defineReactive(data, key, obj[key])</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">dataObj, key, value</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(dataObj, key, &#123;</span><br><span class="line">        <span class="keyword">get</span>() &#123;</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">set</span>(newVal) &#123;</span><br><span class="line">            <span class="comment">// value 在参数中就已经声明了,已经分配了内存空间</span></span><br><span class="line">            value = newVal</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="声明式渲染"><a href="#声明式渲染" class="headerlink" title="声明式渲染"></a>声明式渲染</h2><p>声明式编程: 只需要声明在哪里做,而无需关心如何实现怎么做的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在这里就是声明式,不是知道forEach内部如何实现的.同样的map,reduce,fiter,every,some 都是</span></span><br><span class="line"><span class="keyword">let</span> array = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">array.forEach(<span class="function">(<span class="params">item,index</span>) =&gt;</span> &#123;</span><br><span class="line">    array[index] = item + <span class="number">1</span> </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>命令式变成: 需要以具体代码表达在哪里做,怎么做 (要描述具体怎么做)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> array = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>, i&lt; array.length, i++) &#123;</span><br><span class="line">    array[i] += <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>声明式渲染理解:</p>
<ol>
<li>DOM状态只是数据状态的一个映射</li>
<li>所有的逻辑尽可能在状态层面去进行</li>
<li>当数据状态改变了,view视图会被框架自动更新到合理的状态.</li>
</ol>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/10/24/Vue介绍/" data-id="ckh44mztk000l4sv24mx0alop" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/4/">&laquo; 上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/">CSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DOM/">DOM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/How-to-use-hexo-create-a-blog/">How to use hexo create a blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/canvas-基础/">canvas 基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/CSS/" style="font-size: 20px;">CSS</a> <a href="/tags/DOM/" style="font-size: 10px;">DOM</a> <a href="/tags/How-to-use-hexo-create-a-blog/" style="font-size: 10px;">How to use hexo create a blog</a> <a href="/tags/canvas-基础/" style="font-size: 10px;">canvas 基础</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/10/09/DOM/">DOM</a>
          </li>
        
          <li>
            <a href="/2020/10/09/CSS总结/">CSS总结</a>
          </li>
        
          <li>
            <a href="/2020/10/09/canvas基础/">canvas</a>
          </li>
        
          <li>
            <a href="/2020/10/09/设计模式/">设计模式</a>
          </li>
        
          <li>
            <a href="/2020/10/09/重识CSS/">重识CSS</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Richard.Zhao<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>